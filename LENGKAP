<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="author" content="Muhamad Jias Bin Jalun">
<meta name="copyright" content="Hak Cipta Terpelihara Jabatan Elektrik IKBN Kinarut 2025">
<title>Simulasi Network V55.0 (User Auth & Report)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    /* --- VARIABEL UTAMA CSS --- */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap');

    :root {
        --bg-color: #000000;
        --panel-bg: rgba(10, 10, 10, 0.95);
        --panel-border: #333333;
        --panel-width: 420px;
        --hv-live: #ef4444; 
        --hv-off: #1f2937;  
        --hv-fault: #d946ef; 
        --lv-live: #facc15; 
        --dead: #374151;    
        --earth: #22c55e;   
        --text-main: #f1f5f9;
        --accent: #06b6d4; 
        --label-bg: #15803d; 
        --label-text: #ffffff;
        --hv-link-live: #f97316; 
        --nop-green: #22c55e; 
    }

    /* --- GLOBAL & ANIMASI --- */
    body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg-color); color: var(--text-main); overflow: hidden; height: 100vh; width: 100vw; user-select: none; }
    .digital-font { font-family: 'Orbitron', sans-serif; }
    @keyframes flashFault { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .tripped { animation: flashFault 0.5s infinite; }
    @keyframes pulse-red { 0% { background-color: #7f1d1d; } 50% { background-color: #ef4444; } 100% { background-color: #7f1d1d; } }
    .emergency-mode { animation: pulse-red 0.3s infinite; }
    @keyframes blink-red { 0%, 100% { background-color: #300; box-shadow: none; } 50% { background-color: #f00; box-shadow: 0 0 10px #f00; } }

    /* --- ANIMASI ALIRAN ARUS (POWER FLOW) --- */
    @keyframes flowHorz { from { background-position: 0 0; } to { background-position: 20px 0; } }
    @keyframes flowVert { from { background-position: 0 0; } to { background-position: 0 20px; } }
    @keyframes flowSVG { to { stroke-dashoffset: -20; } }

    /* Kelas Arah Aliran Dinamik */
    .flow-fwd { animation-direction: normal !important; }
    .flow-rev { animation-direction: reverse !important; }

    /* --- LAYOUT UTAMA --- */
    #app-container { position: relative; height: 100vh; width: 100vw; overflow: hidden; opacity: 0; transition: opacity 1s; visibility: hidden; }
    .canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000000; cursor: grab; z-index: 0; touch-action: none; }
    .canvas-container:active { cursor: grabbing; }
    
    /* SPARK LAYER */
    #spark-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    
    /* Sidebar */
    .ui-layer { position: absolute; top: 0; left: 0; bottom: 0; z-index: 100; pointer-events: none; display: flex; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .sidebar { width: var(--panel-width); background: var(--panel-bg); border-right: 1px solid var(--panel-border); display: flex; flex-direction: column; pointer-events: auto; box-shadow: 10px 0 25px -5px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); max-width: 90vw; }
    .toggle-btn { width: 24px; height: 80px; margin-top: 50vh; transform: translateY(-50%); background: var(--accent); border-radius: 0 8px 8px 0; cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: #000; font-size: 1rem; box-shadow: 4px 0 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s; }
    .toggle-btn:hover { filter: brightness(1.1); width: 28px; }
    .ui-layer.collapsed { transform: translateX(calc(-1 * var(--panel-width))); }
    @media (max-width: 450px) { .ui-layer.collapsed { transform: translateX(-90vw); } }
    .ui-layer.collapsed .toggle-btn i { transform: rotate(180deg); }
    
    #zoom-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; transition: transform 0.1s ease-out; }
    .zoom-controls { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 8px; z-index: 90; }
    .zoom-btn { width: 40px; height: 40px; background: rgba(30, 30, 30, 0.9); border: 1px solid #555; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: 0.2s; }
    .zoom-btn:hover { background: #444; }

    /* --- KOMPONEN --- */
    .substation { position: absolute; border: 3px solid #64748b; background: rgba(30, 41, 59, 0.4); border-radius: 12px; pointer-events: none; box-shadow: 0 0 20px rgba(0,0,0,0.6); backdrop-filter: blur(2px); transition: all 0.3s ease; }
    
    .sub-title { position: absolute; top: -24px; left: 15px; background: linear-gradient(180deg, #166534 0%, #14532d 100%); padding: 6px 20px; font-weight: 900; font-size: 1rem; color: #fff; border: 2px solid #4ade80; border-radius: 6px; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); text-shadow: 1px 1px 0 #000; z-index: 20; display: flex; align-items: center; justify-content: center; min-width: 150px; }
    
    .cable { position: absolute; background: var(--dead); transition: background 0.3s; z-index: 5; }
    .cable.v { width: 4px; } .cable.h { height: 4px; }
    .cable-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 4; }
    
    /* SVG & CABLE STYLES */
    .svg-line { stroke: var(--dead); stroke-width: 4; transition: stroke 0.3s; fill: none; stroke-linejoin: round; stroke-linecap: round; }
    .svg-line.live-hv { stroke: var(--hv-live); filter: drop-shadow(0 0 5px var(--hv-live)); stroke-dasharray: 10 5; animation: flowSVG 0.5s linear infinite; }
    .svg-line.fault-hv { stroke: var(--hv-fault); filter: drop-shadow(0 0 5px var(--hv-fault)); stroke-dasharray: 10 5; animation: flashFault 0.3s infinite; }
    .svg-line.live-lv-svg { stroke: var(--lv-live); stroke-dasharray: 8 4; filter: drop-shadow(0 0 5px var(--lv-live)); animation: flowSVG 1s linear infinite; }
    .svg-dot.live-lv-svg { fill: var(--lv-live); filter: drop-shadow(0 0 5px var(--lv-live)); }

    .cable.live-hv.h { background: repeating-linear-gradient(90deg, var(--hv-live), var(--hv-live) 10px, #991b1b 10px, #991b1b 20px) !important; animation: flowHorz 1s linear infinite; box-shadow: 0 0 10px var(--hv-live); }
    .cable.live-hv.v { background: repeating-linear-gradient(180deg, var(--hv-live), var(--hv-live) 10px, #991b1b 10px, #991b1b 20px) !important; animation: flowVert 1s linear infinite; box-shadow: 0 0 10px var(--hv-live); }

    /* LV CABLE ANIMATION */
    .cable.live-lv.h { 
        background-color: var(--lv-live) !important;
        background-image: repeating-linear-gradient(90deg, var(--lv-live), var(--lv-live) 10px, #b45309 10px, #b45309 20px) !important; 
        background-size: 40px 100% !important; 
        animation: flowHorz 1s linear infinite !important; 
        border: none !important; 
        box-shadow: 0 0 8px var(--lv-live); 
        opacity: 1 !important;
        z-index: 20 !important;
    }
    .cable.live-lv.v { 
        background-color: var(--lv-live) !important;
        background-image: repeating-linear-gradient(180deg, var(--lv-live), var(--lv-live) 10px, #b45309 10px, #b45309 20px) !important; 
        background-size: 100% 40px !important; 
        animation: flowVert 1s linear infinite !important; 
        border: none !important; 
        box-shadow: 0 0 8px var(--lv-live);
        opacity: 1 !important;
        z-index: 20 !important;
    }
    
    /* LINK CABLE (Dashed Orange + Transparent) */
    .cable.live-hv-link { filter: drop-shadow(0 0 5px var(--hv-link-live)); box-shadow: none !important; z-index: 25; }
    .cable.live-hv-link.h { background: repeating-linear-gradient(90deg, var(--hv-link-live), var(--hv-link-live) 10px, transparent 10px, transparent 20px) !important; background-size: 40px 100% !important; animation: flowHorz 0.5s linear infinite; background-color: transparent !important; } 
    .cable.live-hv-link.v { background: repeating-linear-gradient(180deg, var(--hv-link-live), var(--hv-link-live) 10px, transparent 10px, transparent 20px) !important; background-size: 100% 40px !important; animation: flowVert 0.5s linear infinite; background-color: transparent !important; } 
    
    /* SVG LINK (Dashed Orange) */
    .svg-line.live-hv-link { stroke: var(--hv-link-live); filter: drop-shadow(0 0 5px var(--hv-link-live)); stroke-dasharray: 10 5; animation: flowSVG 0.5s linear infinite; }

    /* SOLID BUSBARS */
    .cable.live-hv-solid { background: var(--hv-live) !important; box-shadow: 0 0 12px var(--hv-live) !important; animation: none !important; }
    .lv-busbar-horz.on-solid { background: var(--lv-live) !important; box-shadow: 0 0 8px var(--lv-live); animation: none !important; }
    
    .sw-wrapper { position: absolute; width: 40px; height: 60px; z-index: 10; display: flex; flex-direction: column; align-items: center; }
    .sw-box { width: 36px; height: 36px; background: var(--hv-off); border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; cursor: pointer; color: #fff; transition: 0.2s; z-index: 15; border-radius: 4px; }
    .sw-box:hover { border-color: #fff; transform: scale(1.1); }
    .sw-box.hv.on { background: var(--hv-live); border-color: #fff; box-shadow: 0 0 10px var(--hv-live); }
    .sw-box.hv.off { background: var(--hv-off); border-color: #64748b; color: #94a3b8; }
    .sw-box.lv.on { background: #1f2937; color: #94a3b8; border-color: #4b5563; box-shadow: none; }
    .sw-box.lv.on.energized { background: #facc15 !important; color: #000 !important; border-color: #fff !important; box-shadow: 0 0 15px #facc15; font-weight: 900; }
    .sw-box.racked-out { border: 2px dashed #facc15; opacity: 0.6; transform: scale(0.9); }
    .sw-box.lbs-green { background: var(--nop-green) !important; border-color: #fff !important; color: #000 !important; }
    .sw-box.lbs-red { background: var(--hv-live) !important; border-color: #fff !important; color: #fff !important; box-shadow: 0 0 10px var(--hv-live); }
    
    .sw-earth { width: 28px; height: 16px; background: #000; border: 1px dashed #666; margin-top: 4px; font-size: 0.6rem; display: flex; align-items: center; justify-content: center; color: #888; cursor: pointer; transition: 0.2s; border-radius: 2px; }
    .sw-earth:hover { border-color: var(--earth); color: var(--earth); }
    .sw-earth.active { background: var(--earth); color: #000; font-weight: bold; border-style: solid; }
    
    .sw-label { position: absolute; top: -22px; font-size: 0.8rem; color: #ffffff; white-space: nowrap; pointer-events: none; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 0.05em; }
    .sw-label.bottom { top: auto; bottom: -10px; } 
    .tx-icon { position: absolute; width: 40px; height: 50px; display: flex; flex-direction: column; align-items: center; z-index: 15; }
    .tx-c { width: 24px; height: 24px; border-radius: 50%; border: 3px solid #64748b; margin: -5px 0; background: #1f2937; }
    .tx-live .tx-c { border-color: var(--lv-live); box-shadow: 0 0 10px var(--lv-live); }
    .tx-live-33 .tx-c { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .tx-label-right { position: absolute; left: 35px; top: 50%; transform: translateY(-50%); color: #00bcd4; text-align: left; white-space: nowrap; font-weight: 600; font-size: 0.7rem; }

    /* METER DIGITAL STYLE */
    .digital-meter {
        position: absolute;
        top: -45px;
        background: #000;
        border: 1px solid #333;
        color: #06b6d4; /* Cyan */
        font-family: 'Orbitron', monospace;
        font-size: 9px;
        padding: 2px 4px;
        border-radius: 3px;
        text-align: right;
        min-width: 45px;
        box-shadow: 0 0 5px rgba(6, 182, 212, 0.2);
        z-index: 20;
        display: flex;
        flex-direction: column;
        line-height: 1.1;
    }
    .digital-meter span { display: block; }
    .meter-val { color: #fff; font-weight: bold; }

    /* FAULT INDICATOR STYLE */
    .fault-indicator {
        display: inline-block;
        width: 10px; height: 10px;
        border-radius: 50%;
        background-color: #300;
        margin-right: 5px;
        box-shadow: inset 0 0 2px #000;
    }
    .fault-indicator.active {
        animation: blink-red 0.5s infinite;
    }

    /* REPORT CARD MODAL */
    #report-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s;
    }
    #report-modal.show { opacity: 1; }
    .report-card {
        background: #1e293b;
        border: 2px solid #06b6d4;
        border-radius: 12px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 50px rgba(6, 182, 212, 0.3);
        text-align: center;
    }
    .score-circle {
        width: 120px; height: 120px;
        border-radius: 50%;
        border: 8px solid #4ade80;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        color: #fff;
        background: rgba(255,255,255,0.1);
    }
    .mistake-list {
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0,0,0,0.3);
        padding: 10px;
        border-radius: 6px;
        margin: 15px 0;
        font-size: 0.85rem;
        color: #cbd5e1;
    }
    .mistake-item { border-bottom: 1px solid #333; padding: 5px 0; display: flex; justify-content: space-between; }
    .mistake-pts { color: #ef4444; font-weight: bold; }

    .lv-section { position: absolute; display: flex; align-items: flex-start; z-index: 15; }
    .lv-busbar-horz { position: absolute; top: 18px; left: 0; right: 0; height: 4px; background: #475569; z-index: 5; border-radius: 2px; transition: background 0.3s; }
    .fuse-unit { display: flex; flex-direction: column; align-items: center; margin: 0 3px; position: relative; width: 22px; padding-top: 25px; }
    .fuse-lbl { font-size: 9px; color: #888; margin-bottom: 2px; text-align: center; font-weight: bold; }
    .fuse-tap { position: absolute; top: 18px; width: 4px; height: 10px; background: #475569; transition: background 0.3s; transform: translateY(-50%); z-index: 6; }
    .fuse-tap.on { background: var(--lv-live) !important; box-shadow: 0 0 4px var(--lv-live); }
    .fuse-box { width: 16px; height: 24px; background: #1f2937; border: 1px solid #64748b; z-index: 10; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 9px; transition: 0.2s; border-radius: 2px; }
    .fuse-box.on { background: var(--lv-live); color: #000; border-color: #fff; font-weight: bold; }
    .fuse-box.off { background: #334155; color: #94a3b8; border: 1px solid #64748b; } 
    .fuse-box.empty { background: #000; border: 1px dashed #475569; color: #333; }
    
    .fuse-line-out { width: 4px; height: 40px; background: #334155; margin-top: 0; transition: background 0.3s; }
    .fuse-line-out.on { 
        background-color: var(--lv-live); 
        background-image: repeating-linear-gradient(180deg, var(--lv-live), var(--lv-live) 10px, #b45309 10px, #b45309 20px) !important;
        background-size: 100% 40px !important;
        animation: flowVert 1s linear infinite !important; 
        box-shadow: 0 0 5px var(--lv-live); 
        border: none !important;
        opacity: 1 !important;
    }
    
    .fuse-nop .fuse-lbl { color: var(--accent); font-weight: 800; }
    .fuse-nop .fuse-box { border: 1px solid var(--accent); }
    .fuse-nop .fuse-line-out { height: 15px; }
    
    /* Positions */
    #fs-lk { top:350px; left:122px; } 
    #fs-pt { top:350px; left:462px; } 
    #fs-lm { top:350px; left:1128px; } 

    #l-lm-f4, #l-lm-f5, 
    #l-pt-f7, #l-pt-f8, 
    #l-lk-f7, #l-lk-f8 {
        background-color: #475569; width: 4px !important; border: none !important;
    }

    #l-lm-f4 { height: 117px !important; }
    #l-lm-f5 { height: 135px !important; }
    #l-pt-f7 { height: 135px !important; }
    #l-pt-f8 { height: 127px !important; }
    #l-lk-f7 { height: 117px !important; }
    #l-lk-f8 { height: 127px !important; }

    #l-lm-f4.on, #l-lm-f5.on, 
    #l-pt-f7.on, #l-pt-f8.on, 
    #l-lk-f7.on, #l-lk-f8.on {
        box-shadow: 0 0 6px var(--lv-live); 
    }

    /* UI */
    .panel-head { padding: 20px; border-bottom: 1px solid #333; background: rgba(20, 20, 20, 0.9); }
    .panel-body { padding: 20px; flex: 1; overflow-y: auto; }
    .ctrl-group { background: #111; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
    .ctrl-label { font-size: 0.7rem; color: #888; margin-bottom: 8px; display: block; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .btn { width: 100%; padding: 12px; border: none; font-weight: 600; cursor: pointer; border-radius: 6px; font-size: 0.85rem; transition: all 0.2s; margin-bottom: 6px; text-align: left; display: flex; align-items: center; justify-content: space-between; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    .btn-op { background: #15803d; color: #dcfce7; }
    .btn-cl { background: #b91c1c; color: #fee2e2; }
    .btn-ea { background: transparent; border: 1px dashed #22c55e; color: #22c55e; text-align: center; justify-content: center; }
    .btn-ea.active { background: var(--earth); color: #000; font-weight: bold; border-style: solid; }
    .btn-test { background: #1f2937; color: #d1d5db; border-left: 4px solid #4b5563; }
    .btn-test.passed { border-left-color: #22c55e; background: #064e3b; color: #4ade80; }
    .log-entry { font-family: 'Courier New', monospace; font-size: 0.75rem; margin-bottom: 6px; color: #cbd5e1; border-bottom: 1px solid #333; padding-bottom: 4px; line-height: 1.4; }
    #ai-overlay { position: absolute; top: 70px; left: 20px; right: 20px; bottom: 20px; background: rgba(10, 10, 10, 0.98); border: 1px solid var(--accent); border-radius: 12px; z-index: 200; display: none; flex-direction: column; box-shadow: 0 0 30px rgba(6, 182, 212, 0.2); }
    .ai-header { padding: 15px; border-bottom: 1px solid var(--panel-border); display: flex; justify-content: space-between; align-items: center; }
    #connection-status { transition: all 0.3s ease; animation: pulse-status 2s infinite; }
    @keyframes pulse-status { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    #connection-status i { animation: blink-dot 1.5s infinite; }
    @keyframes blink-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .loading-dots { display: inline-block; }
    .loading-dots span { animation: loading-dot 1.4s infinite; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes loading-dot { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
    .ai-content { flex: 1; padding: 20px; overflow-y: auto; font-family: monospace; color: #a5f3fc; }
    .ai-input-area { padding: 15px; border-top: 1px solid var(--panel-border); display: flex; gap: 10px; }
    .ai-input { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 6px; font-size: 0.9rem; }
    .ai-btn { background: var(--accent); color: black; width: 40px; height: 40px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .ai-btn:hover { filter: brightness(1.1); }
    .ai-btn.recording { background: #ef4444; color: white; animation: pulse-red 1s infinite; }
    .audio-controls { display: flex; gap: 5px; align-items: center; }
    .btn-audio { background: transparent; border: 1px solid #555; color: #aaa; width: 30px; height: 30px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
    .btn-audio:hover { color: white; border-color: white; }
    .btn-audio.active { color: var(--accent); border-color: var(--accent); }
    #lang-select { background: #1f2937; color: white; border: 1px solid #555; padding: 2px 5px; border-radius: 4px; font-size: 0.75rem; }
    .ai-line { margin-bottom: 10px; display: flex; gap: 10px; }
    .ai-avatar { width: 30px; height: 30px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold; flex-shrink: 0; }
    .user-avatar { width: 30px; height: 30px; background: #475569; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
    .ai-msg-text { background: rgba(6, 182, 212, 0.1); padding: 8px 12px; border-radius: 0 12px 12px 12px; font-size: 0.85rem; line-height: 1.4; white-space: pre-wrap; }
    .user-msg-text { background: rgba(71, 85, 105, 0.3); padding: 8px 12px; border-radius: 12px 0 12px 12px; font-size: 0.85rem; line-height: 1.4; }
    .typing-dot { display: inline-block; width: 6px; height: 6px; background: #a5f3fc; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite ease-in-out; }
    @keyframes typing { 0%, 100% { transform: scale(0.6); opacity: 0.5; } 50% { transform: scale(1); opacity: 1; } }
    .watermark { position: fixed; bottom: 10px; right: 15px; font-size: 11px; color: rgba(255,255,255,0.3); z-index: 1000; pointer-events: none; font-weight: 500; }
    .role-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 8px; }
    .role-student { background: #0284c7; color: white; }
    .role-admin { background: #dc2626; color: white; border: 1px solid #fca5a5; box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); animation: pulseAdmin 2s infinite; }
    @keyframes pulseAdmin { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
</style>
</head>
<body>
    <div id="login-screen" class="fixed inset-0 z-[9999] bg-slate-900 flex flex-col items-center justify-center p-6 transition-all duration-700">
        <div class="mb-6 text-cyan-400 text-7xl animate-pulse"><i class="fa-solid fa-bolt"></i></div>
        <h1 class="text-3xl md:text-5xl font-bold text-center mb-3 tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 digital-font">JABATAN ELEKTRIK</h1>
        <h2 class="text-xl md:text-3xl font-bold text-center mb-12 tracking-widest text-slate-300 digital-font">SIMULASI 11KV IKBN KINARUT</h2>
        <div class="w-full max-w-md bg-slate-800/80 backdrop-blur-lg border border-slate-600 p-8 rounded-2xl shadow-2xl flex flex-col gap-4 relative z-10">
            <!-- USER AUTH FIELDS -->
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-widest font-bold">Nama Pelajar</label>
                <input type="text" id="student-name" placeholder="Masukkan Nama Penuh" class="w-full bg-slate-900 border border-slate-600 text-white py-2 px-4 rounded focus:outline-none focus:border-cyan-500 transition-colors">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-widest font-bold">No. Matrik / ID</label>
                <input type="text" id="student-id" placeholder="Contoh: E012345" class="w-full bg-slate-900 border border-slate-600 text-white py-2 px-4 rounded focus:outline-none focus:border-cyan-500 transition-colors">
            </div>
            
            <div class="relative mt-2">
                <input type="password" id="passcode" placeholder="Kod Akses" class="w-full bg-slate-900 border-2 border-slate-600 text-center text-xl text-white py-3 px-4 rounded-lg focus:outline-none focus:border-cyan-500 transition-colors digital-font tracking-widest">
                <i class="fa-solid fa-lock absolute right-4 top-4 text-slate-500"></i>
            </div>
            
            <button id="login-button" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-[1.02] shadow-lg tracking-wide mt-2">LOG MASUK</button>
            <p id="error-msg" class="text-red-500 text-center text-sm font-bold hidden animate-pulse"><i class="fa-solid fa-triangle-exclamation mr-1"></i> AKSES DITOLAK / SILA ISI SEMUA MAKLUMAT</p>
        </div>
        <div class="mt-auto text-center text-slate-500 text-xs"><p>Pembangun Sistem: Muhamad Jias Bin Jalun</p><p class="mt-1">© 2025 Hak Cipta Terpelihara</p></div>
    </div>

    <div id="app-container">
        <div class="canvas-container" id="canvas-container">
            <div id="zoom-layer">
                <svg class="cable-svg" xmlns="http://www.w3.org/2000/svg">
                    <line id="c1" x1="58" y1="210" x2="58" y2="770" class="svg-line" />
                    <line id="c2" x1="458" y1="210" x2="458" y2="770" class="svg-line" />
                    <line id="c3" x1="838" y1="210" x2="838" y2="770" class="svg-line" />
                    
                    <!-- LINK CABLES (RMU Interconnects) - Converted to SVG Polylines -->
                    <!-- T1: Lok Kawi - Papar -->
                    <polyline id="t1" points="120,170 120,102 780,102 780,170" class="svg-line" />
                    <!-- T2: Lok Kawi - Putatan -->
                    <polyline id="t2" points="240,170 240,122 400,122 400,170" class="svg-line" />
                    <!-- T3: Putatan - Papar -->
                    <polyline id="t3" points="640,170 640,132 900,132 900,170" class="svg-line" />
                    <!-- T4: Putatan - Limau -->
                    <polyline id="t4" points="580,170 580,112 1080,112 1080,170" class="svg-line" />
                    <!-- T5: Papar - Limau -->
                    <polyline id="t5" points="960,170 960,82 1140,82 1140,170" class="svg-line" />
                    
                    <circle id="dot-lk7" cx="192" cy="530" r="3" class="svg-dot" />
                    <circle id="dot-lm4" cx="1170" cy="530" r="3" class="svg-dot" /> 
                    <circle id="dot-lk8" cx="220" cy="540" r="3" class="svg-dot" />
                    <circle id="dot-pt8" cx="560" cy="540" r="3" class="svg-dot" />
                    <circle id="dot-pt7" cx="532" cy="550" r="3" class="svg-dot" />
                    <circle id="dot-lm5" cx="1142" cy="550" r="3" class="svg-dot" /> 
                </svg>

                <!-- LV LINKS (Converted to DIVs) -->
                <div class="cable h" id="link-lk7-lm4" style="left:192px; top:528px; width:978px;"></div>
                <div class="cable h" id="link-pt8-lk8" style="left:220px; top:538px; width:340px;"></div>
                <div class="cable h" id="link-lm5-pt7" style="left:532px; top:548px; width:610px;"></div>
                
                <!-- SSU KINARUT -->
                <div class="substation" style="top:610px; left:40px; width:1020px; height:230px;"><div class="sub-title">SSU KINARUT</div></div>
                <div class="tx-icon tx-live-33" style="top:650px; left:100px;"><div class="tx-c"></div><div class="tx-c"></div><div class="tx-label-right">TX 1<br><span style="font-size:0.6rem; color:#fff;">415V / 11kV</span></div></div>
                <div class="tx-icon tx-live-33" style="top:650px; left:900px;"><div class="tx-c"></div><div class="tx-c"></div><div class="tx-label-right">TX 2<br><span style="font-size:0.6rem; color:#fff;">415V / 11kV</span></div></div>
                <div class="cable h" id="bus-kin-a" style="top:750px; left:30px; width:482px; height:8px;"></div>
                <div class="cable h" id="bus-kin-b" style="top:750px; left:548px; width:432px; height:8px;"></div>
                <div class="cable v" style="top:700px; left:120px; height:50px; background:#00bcd4;"></div>
                
                <!-- VCB PANELS WITH METERS -->
                <div class="sw-wrapper" style="top:720px; left:100px;">
                    <div class="digital-meter"><span class="meter-val" id="m-1001-a">0 A</span><span id="m-1001-v">0.0 kV</span></div>
                    <div class="sw-box hv on" id="1001" onclick="sel('1001')">X</div><div class="sw-earth" id="e1001" onclick="opEarth('1001')">E</div><div class="sw-label bottom">1001</div>
                </div>
                <div class="cable v" style="top:700px; left:920px; height:50px; background:#00bcd4;"></div>
                <div class="sw-wrapper" style="top:720px; left:900px;">
                    <div class="digital-meter"><span class="meter-val" id="m-1002-a">0 A</span><span id="m-1002-v">0.0 kV</span></div>
                    <div class="sw-box hv on" id="1002" onclick="sel('1002')">X</div><div class="sw-earth" id="e1002" onclick="opEarth('1002')">E</div><div class="sw-label bottom">1002</div>
                </div>
                <div class="sw-wrapper" style="top:736px; left:510px;">
                    <div class="sw-label">1003</div><div class="sw-box hv off" id="1003" onclick="sel('1003')">X</div>
                </div>
                <div class="sw-wrapper" style="top:770px; left:40px;">
                    <div class="digital-meter" style="top:-35px"><span class="meter-val" id="m-1004-a">0 A</span></div>
                    <div class="sw-box hv on" id="1004" onclick="sel('1004')">X</div><div class="sw-earth" id="e1004" onclick="opEarth('1004')">E</div><div class="sw-label bottom">1004</div>
                </div>
                <div class="sw-wrapper" style="top:770px; left:440px;">
                    <div class="digital-meter" style="top:-35px"><span class="meter-val" id="m-1005-a">0 A</span></div>
                    <div class="sw-box hv on" id="1005" onclick="sel('1005')">X</div><div class="sw-earth" id="e1005" onclick="opEarth('1005')">E</div><div class="sw-label bottom">1005</div>
                </div>
                <div class="sw-wrapper" style="top:770px; left:820px;">
                    <div class="digital-meter" style="top:-35px"><span class="meter-val" id="m-1006-a">0 A</span></div>
                    <div class="sw-box hv on" id="1006" onclick="sel('1006')">X</div><div class="sw-earth" id="e1006" onclick="opEarth('1006')">E</div><div class="sw-label bottom">1006</div>
                </div>

                <!-- P/E LOK KAWI -->
                <div class="substation" style="top:40px; left:0px; width:300px; height:470px;"><div class="sub-title">P/E LOK KAWI</div></div>
                <div class="cable h" id="bus-lk" style="top:175px; left:30px; width:240px; height:6px;"></div>
                <div class="sw-wrapper" style="top:170px; left:40px;"><div class="sw-box hv on" id="2001" onclick="sel('2001')">/</div><div class="sw-earth" id="e2001" onclick="opEarth('2001')">E</div><div class="sw-label bottom">2001</div></div>
                <div class="sw-wrapper" style="top:170px; left:100px;"><div class="sw-box hv off" id="2002" onclick="sel('2002')">L</div><div class="sw-earth" id="e2002" onclick="opEarth('2002')">E</div><div class="sw-label bottom">2002</div></div>
                <div class="sw-wrapper" style="top:170px; left:160px;"><div class="sw-box hv on" id="2003" onclick="sel('2003')">X</div><div class="sw-earth" id="e2003" onclick="opEarth('2003')">E</div><div class="sw-label bottom">2003</div></div>
                <div class="sw-wrapper" style="top:170px; left:220px;"><div class="sw-box hv off" id="2004" onclick="sel('2004')">L</div><div class="sw-earth" id="e2004" onclick="opEarth('2004')">E</div><div class="sw-label bottom">2004</div></div>
                <div class="cable v" id="c-lk-rmu-tx" style="top:228px; left:178px; height:38px;"></div>
                <div class="tx-icon" id="tx-lk" style="top:266px; left:160px;"><div class="tx-c"></div><div class="tx-c"></div></div>
                <div class="cable v" id="c-lk-tx-link" style="top:306px; left:178px; height:10px;"></div>
                <div class="sw-wrapper" style="top:316px; left:160px;"><div class="sw-box lv on" style="height:20px;" id="lk-link" onclick="sel('lk-link')">||</div><div class="sw-earth" id="e_lk_link" style="display:none;">E</div></div>
                <div class="cable v" id="c-lk-link-bus" style="top:336px; left:178px; height:32px;"></div>
                <div class="lv-section" id="fs-lk"></div>

                <!-- P/E PUTATAN -->
                <div class="substation" style="top:40px; left:340px; width:370px; height:470px;"><div class="sub-title">P/E PUTATAN</div></div>
                <div class="cable h" id="bus-pt" style="top:175px; left:370px; width:310px; height:6px;"></div>
                <div class="sw-wrapper" style="top:170px; left:380px;"><div class="sw-box hv off" id="3004" onclick="sel('3004')">L</div><div class="sw-earth" id="e3004" onclick="opEarth('3004')">E</div><div class="sw-label bottom">3004</div></div>
                <div class="sw-wrapper" style="top:170px; left:440px;"><div class="sw-box hv on" id="3001" onclick="sel('3001')">/</div><div class="sw-earth" id="e3001" onclick="opEarth('3001')">E</div><div class="sw-label bottom">3001</div></div>
                <div class="sw-wrapper" style="top:170px; left:500px;"><div class="sw-box hv on" id="3003" onclick="sel('3003')">X</div><div class="sw-earth" id="e3003" onclick="opEarth('3003')">E</div><div class="sw-label bottom">3003</div></div>
                <div class="sw-wrapper" style="top:170px; left:560px;"><div class="sw-box hv off" id="3005" onclick="sel('3005')">L</div><div class="sw-earth" id="e3005" onclick="opEarth('3005')">E</div><div class="sw-label bottom">3005</div></div>
                <div class="sw-wrapper" style="top:170px; left:620px;"><div class="sw-box hv off" id="3002" onclick="sel('3002')">/</div><div class="sw-earth" id="e3002" onclick="opEarth('3002')">E</div><div class="sw-label bottom">3002</div></div>
                <div class="cable v" id="c-pt-rmu-tx" style="top:228px; left:518px; height:38px;"></div>
                <div class="tx-icon" id="tx-pt" style="top:266px; left:500px;"><div class="tx-c"></div><div class="tx-c"></div></div>
                <div class="cable v" id="c-pt-tx-link" style="top:306px; left:518px; height:10px;"></div>
                <div class="sw-wrapper" style="top:316px; left:500px;"><div class="sw-box lv on" style="height:20px;" id="pt-link" onclick="sel('pt-link')">||</div><div class="sw-earth" id="e_pt_link" style="display:none;">E</div></div>
                <div class="cable v" id="c-pt-link-bus" style="top:336px; left:518px; height:32px;"></div>
                <div class="lv-section" id="fs-pt"></div>

                <!-- S/S PAPAR -->
                <div class="substation" style="top:40px; left:710px; width:300px; height:270px;"><div class="sub-title">S/S PAPAR</div></div>
                <div class="cable h" id="bus-pp" style="top:175px; left:740px; width:240px; height:6px;"></div>
                <div class="sw-wrapper" style="top:170px; left:760px;"><div class="sw-box hv off lbs" id="4003" onclick="sel('4003')">L</div><div class="sw-earth" id="e4003" onclick="opEarth('4003')">E</div><div class="sw-label bottom">4003</div></div>
                <div class="sw-wrapper" style="top:170px; left:820px;"><div class="sw-box hv on" id="4001" onclick="sel('4001')">/</div><div class="sw-earth" id="e4001" onclick="opEarth('4001')">E</div><div class="sw-label bottom">4001</div></div>
                <div class="sw-wrapper" style="top:170px; left:880px;"><div class="sw-box hv off" id="4002" onclick="sel('4002')">/</div><div class="sw-earth" id="e4002" onclick="opEarth('4002')">E</div><div class="sw-label bottom">4002</div></div>
                <div class="sw-wrapper" style="top:170px; left:940px;"><div class="sw-box hv on" id="4004" onclick="sel('4004')">L</div><div class="sw-earth" id="e4004" onclick="opEarth('4004')">E</div><div class="sw-label bottom">4004</div></div>

                <!-- P/E LIMAU-LIMAUAN -->
                <div class="substation" style="top:40px; left:1020px; width:300px; height:470px;"><div class="sub-title">P/E LIMAU</div></div>
                <div class="cable h" id="bus-lm" style="top:175px; left:1050px; width:240px; height:6px;"></div>
                <div class="sw-wrapper" style="top:170px; left:1060px;"><div class="sw-box hv on" id="5001" onclick="sel('5001')">L</div><div class="sw-earth" id="e5001" onclick="opEarth('5001')">E</div><div class="sw-label bottom">5001</div></div>
                <div class="sw-wrapper" style="top:170px; left:1120px;"><div class="sw-box hv on" id="5002" onclick="sel('5002')">L</div><div class="sw-earth" id="e5002" onclick="opEarth('5002')">E</div><div class="sw-label bottom">5002</div></div>
                <div class="sw-wrapper" style="top:170px; left:1180px;"><div class="sw-box hv on" id="5003" onclick="sel('5003')">X</div><div class="sw-earth" id="e5003" onclick="opEarth('5003')">E</div><div class="sw-label bottom">5003</div></div>
                <div class="sw-wrapper" style="top:170px; left:1240px;"><div class="sw-box hv off" id="5004" onclick="sel('5004')">/</div><div class="sw-earth" id="e5004" onclick="opEarth('5004')">E</div><div class="sw-label bottom">5004</div></div>
                <div class="cable v" id="c-lm-rmu-tx" style="top:228px; left:1198px; height:38px;"></div>
                <div class="tx-icon" id="tx-lm" style="top:266px; left:1180px;"><div class="tx-c"></div><div class="tx-c"></div></div>
                <div class="cable v" id="c-lm-tx-link" style="top:306px; left:1198px; height:10px;"></div>
                <div class="sw-wrapper" style="top:316px; left:1180px;"><div class="sw-box lv on" style="height:20px;" id="lm-link" onclick="sel('lm-link')">||</div><div class="sw-earth" id="e_lm_link" style="display:none;">E</div></div>
                <div class="cable v" id="c-lm-link-bus" style="top:336px; left:1198px; height:32px;"></div>
                <div class="lv-section" id="fs-lm"></div>
            </div>
        </div>
        
        <!-- CANVAS LAYER FOR SPARKS -->
        <canvas id="spark-layer"></canvas>
        
        <!-- REPORT MODAL -->
        <div id="report-modal">
            <div class="report-card">
                <h2 class="text-2xl font-bold mb-1 text-cyan-400 digital-font">SLIP KEPUTUSAN</h2>
                <div class="text-xs text-slate-400 mb-4" id="report-header"></div>
                
                <div class="score-circle" id="final-score">100%</div>
                <h3 class="text-lg font-bold text-white mb-2">SENARAI KESALAHAN:</h3>
                <div class="mistake-list" id="mistake-log">
                    <div class="text-center text-gray-500 italic">Tiada kesalahan direkodkan.</div>
                </div>
                <button onclick="closeReport()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 rounded mt-4">TUTUP & SAMBUNG</button>
                <button onclick="location.reload()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded mt-2 text-xs">LOG KELUAR / MULA BARU</button>
            </div>
        </div>

        <div class="ui-layer" id="ui-layer">
            <div class="sidebar" id="sidebar">
                <div class="panel-head flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div><h3 class="font-bold text-white tracking-wider">PANEL KAWALAN</h3><div class="text-[10px] text-slate-400 flex items-center">SISTEM V55.0 <span id="role-badge"></span></div></div>
                        <button onclick="logout()" class="text-xs bg-red-600/80 text-white px-3 py-1 rounded hover:bg-red-600 transition"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                    <!-- SCORE DISPLAY -->
                    <div class="flex justify-between items-center mt-2 bg-slate-900 p-2 rounded border border-slate-700">
                        <div id="score-badge" class="text-sm font-bold text-green-400 font-mono">SKOR: 100%</div>
                        <button onclick="endSession()" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold px-2 py-1 rounded text-xs">TAMAT SESI</button>
                    </div>
                    <!-- STUDENT INFO -->
                    <div id="student-display" class="hidden text-[10px] text-cyan-300 bg-slate-800 p-1 rounded text-center border border-slate-600"></div>
                </div>
                <div class="p-4 border-b border-slate-700 bg-slate-900/50">
                    <button onclick="toggleAI()" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 hover:brightness-110 transition"><i class="fa-solid fa-robot"></i> PENYELIA PINTAR AI ✨</button>
                    <div id="ai-overlay"><div class="ai-header"><span class="text-cyan-400 font-bold flex items-center gap-2"><i class="fa-solid fa-brain"></i> PENYELIA PINTAR AI ✨</span><div class="flex gap-2 items-center"><div id="connection-status" class="flex items-center gap-1 text-xs px-2 py-1 rounded" style="background:rgba(34,197,94,0.2); color:#4ade80;"><i class="fa-solid fa-circle" style="font-size:6px;"></i><span>ONLINE</span></div><select id="lang-select" onchange="toggleSpeechRecognition()" title="Pilih Bahasa"><option value="ms-MY">Melayu</option><option value="en-GB">English</option><option value="zh-CN">Chinese</option><option value="ta-MY">Tamil</option></select><button class="btn-audio" onclick="toggleMute()" id="mute-btn" title="Mute/Unmute"><i class="fa-solid fa-volume-high"></i></button><button class="btn-audio" onclick="stopSpeaking()" title="Stop Audio"><i class="fa-solid fa-stop"></i></button><button onclick="toggleAI()" class="text-gray-400 hover:text-white ml-2"><i class="fa-solid fa-times"></i></button></div></div><div class="ai-content" id="ai-messages"><div class="ai-line"><div class="ai-avatar">AI</div><div class="ai-msg-text">Halo! Saya Penyelia Pintar AI anda. Saya boleh menganalisis litar, menjawab soalan SOP, dan mencari maklumat teknikal dari internet. Sistem saya menggunakan web search dan knowledge base untuk memberikan jawapan yang tepat.</div></div></div><div class="p-3 flex flex-col gap-2 border-t border-slate-700 bg-slate-900"><button onclick="triggerSmartAnalysis()" class="w-full bg-cyan-700 hover:bg-cyan-600 text-white text-xs font-bold py-2 px-4 rounded flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> ANALISIS KESELAMATAN PINTAR</button><div class="ai-input-area" style="padding:0; border:none; display: flex; gap: 5px;"><button class="ai-btn" id="mic-btn" onclick="toggleSpeechRecognition()" title="Cakap (Suara)"><i class="fa-solid fa-microphone"></i></button><input type="text" id="ai-input" class="ai-input" placeholder="Tanya soalan teknikal atau SOP..." onkeypress="if(event.key==='Enter') sendAIChat()"><button class="ai-send-btn" onclick="sendAIChat()"><i class="fa-solid fa-paper-plane"></i></button></div></div></div>
                </div>
                <div id="alarm-panel" style="display:none; background:#7f1d1d; padding:15px; text-align:center; border-bottom:1px solid #ef4444;"><div style="color:white; font-weight:bold; margin-bottom:10px; font-size:0.9rem; letter-spacing: 1px;"><i class="fa-solid fa-triangle-exclamation fa-shake mr-2"></i>FAULT TRIP!</div><button onclick="stopSiren()" class="bg-white text-red-900 px-6 py-2 rounded font-bold hover:bg-gray-200 shadow-lg text-xs uppercase tracking-widest border-2 border-red-900">MATIKAN SIREN</button></div>
                <div class="panel-body"><div id="sel-info" style="margin-bottom:20px; padding:15px; background:#1e293b; border-radius:8px; text-align:center; color:#cbd5e1; border:1px solid #334155;"><i class="fa-solid fa-arrow-pointer mb-2 text-cyan-400"></i><br>Sila pilih komponen pada skematik.</div><div id="dynamic-controls"></div><div id="msg" style="color:#ff5252; font-size:0.85rem; margin-top:15px; font-weight:bold; min-height:20px; text-align:center;"></div></div>
                <div style="height:160px; background:#020617; padding:15px; overflow-y:auto; border-top:1px solid #334155;" id="log-box"><div class="log-entry">> Sistem V55.0 (User Auth) Sedia.</div></div>
            </div>
            <div class="toggle-btn" onclick="toggleUI()"><i class="fa-solid fa-chevron-left"></i></div>
        </div>

        <div class="zoom-controls"><button class="zoom-btn" onclick="zoom(1)"><i class="fa-solid fa-plus"></i></button><button class="zoom-btn" onclick="zoom(-1)"><i class="fa-solid fa-minus"></i></button><button onclick="resetZoom()"><i class="fa-solid fa-compress"></i></button></div>
        <div class="watermark">Dibangunkan oleh Muhamad Jias Bin Jalun</div>
    </div>

<script>
    // 1. VARIABLE DECLARATIONS
    const apiKey = "AIzaSyCdaFtxtXnImOYFcGdN3fhEdDsy0h9s6IQ"; 
    const USER_KEY = "IKBNksB011@Pje";
    const ADMIN_KEY = "Mj5771@Pje123";
    
    let isAdmin = false, syncTests = [false, false, false, false], nopPhase1 = false;
    let nopTests = [false, false, false, false, false], fuseTests = [false, false, false, false, false]; // 5 tests for standard fuses
    let nopReadings = [false, false, false, false, false]; // For reading mode (before RMU transformer off)
    let nopTestMode = 'reading'; // 'reading' or 'full' - reading mode before RMU off, full mode after RMU off
    let selId = null, selNopId = null, selFuseId = null, globalState = null, aiActive = false;
    let linkTests = [false, false, false, false]; // For LV Link tests: PCD, Remove Fuse, PCD Again, Earth
    let isMuted = false, recognition = null, isRecording = false;
    let zoomScale = 1, isPanning = false, panStartX=0, panStartY=0, panX=0, panY=0;
    
    // SCORING & AUTH SYSTEM VARS
    let currentScore = 100;
    let mistakesLog = [];
    let studentName = "";
    let studentID = "";
    
    const fuses = {}; 

    // 2. SOUND SYSTEM
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let sirenOsc = null, sirenGain = null, sirenInterval = null;
    let humOsc = null, humGain = null;

    function initAudio() { if(audioCtx.state === 'suspended') { audioCtx.resume(); } }
    
    function initHum() {
        if(humOsc) return;
        humOsc = audioCtx.createOscillator();
        humGain = audioCtx.createGain();
        humOsc.type = 'sawtooth';
        humOsc.frequency.value = 50; 
        humGain.gain.value = 0; 
        humOsc.connect(humGain);
        humGain.connect(audioCtx.destination);
        humOsc.start();
    }

    function updateHum(isLive) {
        if(!humOsc) initHum();
        if(isMuted) { humGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1); return; }
        const targetGain = isLive ? 0.05 : 0; 
        humGain.gain.setTargetAtTime(targetGain, audioCtx.currentTime, 0.5);
    }

    function playTone(freq, type, duration) {
        if(isMuted) return;
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    function playExplosionSound() {
        if(isMuted) return;
        initAudio();
        const bufferSize = audioCtx.sampleRate * 1.5; 
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        let lastOut = 0;
        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            data[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = data[i];
            data[i] *= 5.0; 
        }
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 1000;
        filter.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 1);
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        noise.start();
    }

    function playSparkSound() {
        if(isMuted) return;
        initAudio();
        const bufferSize = audioCtx.sampleRate * 0.2;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const gain = audioCtx.createGain();
        gain.gain.value = 0.2;
        noise.connect(gain);
        gain.connect(audioCtx.destination);
        noise.start();
    }

    function playBreakerSound(isOpen) {
        if(isMuted) return;
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(isOpen ? 150 : 100, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
    }

    function playSwitchSound() { playTone(800, 'triangle', 0.05); }

    function startSiren() { 
        if(sirenOsc) return; 
        document.getElementById('alarm-panel').style.display = 'block'; 
        document.body.classList.add('emergency-mode'); 
        initAudio(); 
        sirenOsc = audioCtx.createOscillator(); 
        sirenGain = audioCtx.createGain(); 
        sirenOsc.connect(sirenGain); 
        sirenGain.connect(audioCtx.destination); 
        sirenOsc.type = 'square'; 
        sirenOsc.frequency.value = 600; 
        sirenOsc.start(); 
        let high = false; 
        sirenInterval = setInterval(() => { 
            const freq = high ? 600 : 900; 
            sirenOsc.frequency.setValueAtTime(freq, audioCtx.currentTime); 
            sirenOsc.frequency.linearRampToValueAtTime(high ? 900 : 600, audioCtx.currentTime + 0.4); 
            high = !high; 
        }, 500); 
    }
    
    function stopSiren() { 
        if(sirenOsc) { sirenOsc.stop(); sirenOsc.disconnect(); sirenOsc = null; clearInterval(sirenInterval); } 
        document.body.classList.remove('emergency-mode'); 
        document.getElementById('alarm-panel').style.display = 'none'; 
    }
    window.stopSiren = stopSiren; 

    function playAlarm(m) { 
        const msgDiv = document.getElementById('msg'); 
        msgDiv.innerText = m; 
        msgDiv.style.opacity = 1; 
        startSiren(); 
        log(`[AMARAN] ${m}`); 
        setTimeout(() => { stopSiren(); msgDiv.style.opacity = 0; }, 4000); 
    }

    function toggleMute() { isMuted = !isMuted; const btn = document.getElementById('mute-btn'); if (isMuted) { stopSpeaking(); btn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>'; btn.classList.add('active'); } else { btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>'; btn.classList.remove('active'); } }

    // 3. SPARK VISUAL SYSTEM
    const sparkCanvas = document.getElementById('spark-layer');
    const sparkCtx = sparkCanvas.getContext('2d');
    let sparks = [];
    
    function resizeSparkCanvas() {
        sparkCanvas.width = window.innerWidth;
        sparkCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeSparkCanvas);
    resizeSparkCanvas();

    class SparkParticle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.prevX = x; this.prevY = y; 
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 15 + 5; 
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
            this.decay = Math.random() * 0.03 + 0.015;
            this.gravity = 0.5; 
            this.friction = 0.92; 
            const colors = ['#FFFF00', '#FFA500', '#C0C0C0']; 
            this.color = colors[Math.floor(Math.random() * colors.length)];
            this.width = Math.random() * 3 + 1;
        }
        update() {
            this.prevX = this.x;
            this.prevY = this.y;
            this.vx *= this.friction;
            this.vy *= this.friction;
            this.vy += this.gravity;
            this.x += this.vx;
            this.y += this.vy;
            this.life -= this.decay;
        }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.lineWidth = this.width;
            ctx.strokeStyle = this.color;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(this.prevX, this.prevY);
            ctx.lineTo(this.x, this.y);
            ctx.stroke();
            ctx.shadowBlur = 10;
            ctx.shadowColor = this.color;
            ctx.stroke();
            ctx.shadowBlur = 0; 
            ctx.globalAlpha = 1.0;
        }
    }

    function createExplosion(x, y, count) {
        for(let i=0; i<count; i++) {
            sparks.push(new SparkParticle(x, y));
        }
    }

    function triggerVisualSpark(x, y) {
        const finalX = x || window.innerWidth / 2;
        const finalY = y || window.innerHeight / 2;
        createExplosion(finalX, finalY, 80);
        animateSparks();
        setTimeout(() => { createExplosion(finalX + (Math.random()*20-10), finalY + (Math.random()*20-10), 60); }, 150);
        setTimeout(() => { createExplosion(finalX + (Math.random()*30-15), finalY + (Math.random()*30-15), 50); }, 300);
    }

    let animatingSparks = false;
    function animateSparks() {
        if(!animatingSparks) {
            animatingSparks = true;
            requestAnimationFrame(sparkLoop);
        }
    }

    function sparkLoop() {
        sparkCtx.clearRect(0, 0, sparkCanvas.width, sparkCanvas.height);
        for (let i = sparks.length - 1; i >= 0; i--) {
            sparks[i].update();
            sparks[i].draw(sparkCtx);
            if (sparks[i].life <= 0) {
                sparks.splice(i, 1);
            }
        }
        if (sparks.length > 0) {
            requestAnimationFrame(sparkLoop);
        } else {
            animatingSparks = false;
        }
    }

    // 4. SCORING & AUTH LOGIC
    function updateScoreDisplay() {
        const sb = document.getElementById('score-badge');
        if(sb) {
            sb.innerText = `SKOR: ${currentScore}%`;
            if(currentScore < 50) { sb.className = "text-sm font-bold text-red-500 font-mono"; sb.style.borderColor = "#ef4444"; }
            else if(currentScore < 80) { sb.className = "text-sm font-bold text-yellow-400 font-mono"; sb.style.borderColor = "#facc15"; }
            else { sb.className = "text-sm font-bold text-green-400 font-mono"; sb.style.borderColor = "#4ade80"; }
        }
    }

    function deductScore(amount, reason) {
        currentScore = Math.max(0, currentScore - amount);
        mistakesLog.push({ reason: reason, pts: amount, time: new Date().toLocaleTimeString() });
        updateScoreDisplay();
    }

    function endSession() {
        const modal = document.getElementById('report-modal');
        const scoreEl = document.getElementById('final-score');
        const logEl = document.getElementById('mistake-log');
        const headerEl = document.getElementById('report-header');
        
        // Update Info
        headerEl.innerHTML = `NAMA: <span class="text-white font-bold">${studentName}</span><br>ID: <span class="text-white font-bold">${studentID}</span><br>MASA: ${new Date().toLocaleString()}`;

        scoreEl.innerText = `${currentScore}%`;
        if(currentScore >= 80) scoreEl.style.borderColor = "#4ade80"; 
        else if(currentScore >= 50) scoreEl.style.borderColor = "#facc15"; 
        else scoreEl.style.borderColor = "#ef4444"; 

        if(mistakesLog.length === 0) {
            logEl.innerHTML = '<div class="text-center text-green-400">TAHNIAH! Tiada kesalahan direkodkan.</div>';
        } else {
            let h = '';
            mistakesLog.forEach(m => {
                h += `<div class="mistake-item"><span>${m.reason}</span><span class="mistake-pts">-${m.pts}</span></div>`;
            });
            logEl.innerHTML = h;
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    }
    
    function closeReport() {
        const modal = document.getElementById('report-modal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }
    window.endSession = endSession;
    window.closeReport = closeReport;

    // 5. HELPERS & LOGGING
    function log(t){ let b=document.getElementById('log-box'); if(b) { b.innerHTML=`<div class="log-entry">${t}</div>`+b.innerHTML; b.scrollTop = 0; } }
    function addAIMessage(text, isUser, isLoading = false) { 
        const c = document.getElementById('ai-messages'); 
        if (isLoading) {
            // Remove any existing loading message
            const existingLoading = c.querySelector('.loading-msg');
            if (existingLoading) existingLoading.remove();
            
            const l = document.createElement('div'); 
            l.className = 'ai-line loading-msg'; 
            l.innerHTML = `<div class="ai-avatar">AI</div><div class="ai-msg-text">${text} <span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></div>`; 
            c.appendChild(l); 
            c.scrollTop = c.scrollHeight;
            return l;
        } else {
            // Remove loading message if exists
            const existingLoading = c.querySelector('.loading-msg');
            if (existingLoading) existingLoading.remove();
            
            const l = document.createElement('div'); 
            l.className = 'ai-line' + (isUser ? ' justify-end' : ''); 
            let html = isUser ? `<div class="user-msg-text">${text}</div><div class="user-avatar"><i class="fa-solid fa-user"></i></div>` : `<div class="ai-avatar">AI</div><div class="ai-msg-text">${text}</div>`; 
            l.innerHTML = html; 
            c.appendChild(l); 
            c.scrollTop = c.scrollHeight;
            return l;
        }
    }
    function speakText(text) { 
        if(isMuted) return; 
        if ('speechSynthesis' in window) { 
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text); 
            utterance.lang = 'ms-MY'; 
            
            // Cari suara perempuan yang menyokong bahasa Malaysia
            const voices = window.speechSynthesis.getVoices();
            let femaleVoice = null;
            
            // Prioriti: cari suara perempuan yang menyokong ms-MY
            femaleVoice = voices.find(v => 
                v.lang.startsWith('ms') && 
                (v.name.toLowerCase().includes('female') || 
                 v.name.toLowerCase().includes('woman') || 
                 v.name.toLowerCase().includes('zira') ||
                 v.name.toLowerCase().includes('samantha') ||
                 v.name.toLowerCase().includes('google') && v.name.toLowerCase().includes('female'))
            );
            
            // Jika tidak jumpa, cari mana-mana suara perempuan
            if (!femaleVoice) {
                femaleVoice = voices.find(v => 
                    v.name.toLowerCase().includes('female') || 
                    v.name.toLowerCase().includes('woman') || 
                    v.name.toLowerCase().includes('zira')
                );
            }
            
            // Jika masih tidak jumpa, cari suara ms-MY (fallback)
            if (!femaleVoice) {
                femaleVoice = voices.find(v => v.lang.startsWith('ms'));
            }
            
            if (femaleVoice) {
                utterance.voice = femaleVoice;
            }
            
            // Tetapkan kelajuan dan nada untuk suara yang lebih natural
            utterance.rate = 0.95;
            utterance.pitch = 1.1; // Pitch lebih tinggi untuk suara perempuan
            utterance.volume = 1.0;
            
            window.speechSynthesis.speak(utterance); 
        } 
    }
    function stopSpeaking() { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); } }
    function announceStatus(id, type, state) { const lang = document.getElementById('lang-select').value; let message = state ? "Tutup" : "Buka"; message = `Status ${id} ${type} adalah ${message}`; speakText(message); }
    function getElCenter(id) { const el = document.getElementById(id); if(el) { const r = el.getBoundingClientRect(); return {x: r.left + r.width/2, y: r.top + r.height/2}; } return {x:0,y:0}; }

    // 6. LOGIN & AUTH
    function checkCode() { 
        initAudio(); 
        const inputName = document.getElementById('student-name').value.trim();
        const inputID = document.getElementById('student-id').value.trim();
        const inputVal = document.getElementById('passcode').value; 
        const badge = document.getElementById('role-badge'); 
        const logBox = document.getElementById('log-box'); 
        const studentDisp = document.getElementById('student-display');
        const errorMsg = document.getElementById('error-msg');

        // Validation
        if(!inputName || !inputID) {
            errorMsg.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> SILA ISI NAMA & ID PELAJAR';
            errorMsg.classList.remove('hidden');
            setTimeout(() => errorMsg.classList.add('hidden'), 2000);
            return;
        }

        if(inputVal === USER_KEY) { 
            isAdmin = false; 
            studentName = inputName;
            studentID = inputID;
            studentDisp.innerText = `${studentName} (${studentID})`;
            studentDisp.classList.remove('hidden');
            grantAccess(); 
            badge.className = 'role-badge role-student'; 
            badge.innerText = 'MOD PELAJAR'; 
            logBox.innerHTML = `<div class="log-entry success">> Selamat datang, ${studentName}.</div>` + logBox.innerHTML; 
        } else if (inputVal === ADMIN_KEY) { 
            isAdmin = true; 
            studentName = "ADMINISTRATOR";
            studentID = "SYS-ROOT";
            studentDisp.innerText = `ADMIN SESSION`;
            studentDisp.classList.remove('hidden');
            grantAccess(); 
            badge.className = 'role-badge role-admin'; 
            badge.innerText = 'MOD ADMIN'; 
            logBox.innerHTML = `<div class="log-entry alert">> AMARAN: AKSES ADMIN DIBENARKAN</div>` + logBox.innerHTML; 
        } else { 
            errorMsg.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i> KOD AKSES DITOLAK';
            errorMsg.classList.remove('hidden'); 
            setTimeout(() => errorMsg.classList.add('hidden'), 2000); 
        } 
    }
    
    function grantAccess() { 
        document.getElementById('login-screen').style.opacity = '0'; 
        setTimeout(() => { 
            document.getElementById('login-screen').classList.add('hidden'); 
            document.getElementById('app-container').style.visibility = 'visible'; 
            document.getElementById('app-container').style.opacity = '1'; 
            initHum(); 
        }, 700); 
        const SCHEMATIC_CONTENT_WIDTH = 1350; 
        panX = (window.innerWidth / 2) - (SCHEMATIC_CONTENT_WIDTH * zoomScale / 2); 
        updateTransform(); 
    }

    // 7. NETWORK & LOGIC
    const net = {
        '1001': {st:1, rack:'SERVICE', pcd:false, cme:false, type:'VCB', name:'VCB 1001 Incomer', fault:null, relayTrip:false}, 'e1001':{st:0, parent:'1001'},
        '1002': {st:1, rack:'SERVICE', pcd:false, cme:false, type:'VCB', name:'VCB 1002 Incomer', fault:null, relayTrip:false}, 'e1002':{st:0, parent:'1002'},
        '1003': {st:0, rack:'SERVICE', pcd:false, cme:false, type:'VCB', name:'VCB 1003 Bus-Sec', fault:null, relayTrip:false},
        '1004': {st:1, rack:'SERVICE', pcd:false, cme:false, type:'VCB', name:'VCB 1004 Feeder', fault:null, relayTrip:false}, 'e1004':{st:0, parent:'1004'},
        '1005': {st:1, rack:'SERVICE', pcd:false, cme:false, type:'VCB', name:'VCB 1005 Feeder', fault:null, relayTrip:false}, 'e1005':{st:0, parent:'1005'},
        '1006': {st:1, rack:'SERVICE', pcd:false, cme:false, type:'VCB', name:'VCB 1006 Feeder', fault:null, relayTrip:false}, 'e1006':{st:0, parent:'1006'},
        '2001': {iso:1, cb:1, earth:0, type:'RMU', name:'Lok Kawi 2001'}, '2002': {iso:0, cb:0, earth:0, type:'LBS', name:'Lok Kawi 2002 (Link)'}, 
        '2003': {iso:1, cb:1, earth:0, type:'RMU', name:'Lok Kawi 2003'}, '2004': {iso:0, cb:0, earth:0, type:'LBS', name:'Lok Kawi 2004 (Link)'}, 'lk-link': {st:1, type:'LINK', name:'LK LV Link'},
        '3001': {iso:1, cb:1, earth:0, type:'RMU', name:'Putatan 3001'}, '3002': {iso:0, cb:0, earth:0, type:'RMU', name:'Putatan 3002'}, '3003': {iso:1, cb:1, earth:0, type:'RMU', name:'Putatan 3003'}, 
        '3004': {iso:0, cb:0, earth:0, type:'LBS', name:'Putatan 3004 (Link)'}, '3005': {iso:0, cb:0, earth:0, type:'LBS', name:'Putatan 3005 (Link)'}, 'pt-link': {st:1, type:'LINK', name:'PT LV Link'},
        '4001': {iso:1, cb:1, earth:0, type:'RMU', name:'Papar 4001'}, '4002': {iso:0, cb:0, earth:0, type:'RMU', name:'Papar 4002'}, '4003': {iso:0, cb:0, earth:0, type:'LBS', name:'Papar 4003 (Link)'}, '4004': {iso:1, cb:1, earth:0, type:'LBS', name:'Papar 4004 (Link)'}, 
        '5001': {iso:1, cb:1, earth:0, type:'LBS', name:'Limau 5001 (Link)'}, '5002': {iso:1, cb:1, earth:0, type:'LBS', name:'Limau 5002 (Link)'}, '5003': {iso:1, cb:1, earth:0, type:'CB', name:'Limau 5003'}, '5004': {iso:0, cb:0, earth:0, type:'ISO', name:'Limau 5004'}, 'lm-link': {st:1, type:'LINK', name:'LM LV Link'}
    };
    const nopPairs = { '2004': '3004', '3004': '2004', '3002': '4002', '4002': '3002', '4004': '5002', '5002': '4004', '3005': '5001', '5001': '3005', '2002': '4003', '4003': '2002' };
    
    function isLive(id) { let d=net[id]; if (!d) return 0; if(d.type==='VCB') return d.st && d.rack==='SERVICE'; if(['RMU', 'LBS', 'ISO', 'CB'].includes(d.type)) return d.iso && d.cb; return d.st; }
    function checkIncoming(id) { let s1=(id=='1001'?1:net['1001'].st), s2=(id=='1002'?1:net['1002'].st), s3=(id=='1003'?1:net['1003'].st); if (s1 && s2 && s3) return false; return true; }
    
    function setCableFlow(id, on, direction, fault=false, isLink=false) {
        let e = document.getElementById(id); if(!e) return;
        let baseClass = (e.tagName === 'line' || e.tagName === 'polyline') ? 'svg-line' : 'cable ' + (e.classList.contains('v') ? 'v' : 'h');
        let statusClass = fault ? ' fault-hv' : (on ? (isLink ? ' live-hv-link' : ' live-hv') : '');
        let flowClass = (on && !fault) ? (direction === 'rev' ? ' flow-rev' : ' flow-fwd') : '';
        if(e.tagName === 'line' || e.tagName === 'polyline') e.setAttribute('class', baseClass + statusClass + flowClass); else e.className = baseClass + statusClass + flowClass;
    }
    function colBus(id, on) { let e = document.getElementById(id); if(!e) return; e.className = 'cable ' + (e.classList.contains('v')?'v':'h') + (on ? ' live-hv-solid' : ''); }
    function colLv(id, on) { let e = document.getElementById(id); if(!e) return; e.className = 'cable ' + (e.classList.contains('v')?'v':'h') + (on ? ' live-lv' : ''); }
    function lvBus(id, on){ let e=document.getElementById(id); if(e) e.className = on ? 'lv-busbar-horz on-solid' : 'lv-busbar-horz'; }
    function setLVTie(id, on){ let e=document.getElementById(id); if(!e) return; if(e.tagName === 'polyline') e.setAttribute('class', 'svg-line' + (on ? ' live-lv-svg' : '')); else e.className = on ? 'cable h live-lv flow-fwd' : 'cable h'; }
    function setDot(id, on) { let e=document.getElementById(id); if(!e) return; e.setAttribute('class', 'svg-dot' + (on ? ' live-lv-svg' : '')); }
    function updateSwitchVisual(id, isEnergized) {
        let el = document.getElementById(id); if(!el) return; let d = net[id];
        let isHV = ['VCB','RMU','LBS','ISO','CB'].includes(d.type) && !id.includes('link');
        let isOn = (d.type==='VCB') ? d.st : ((['RMU','LBS','ISO','CB'].includes(d.type)) ? (d.iso && d.cb) : d.st); 
        el.className = 'sw-box ' + (isHV?'hv':'lv');
        if(d.type === 'LINK') { if(isOn) { el.classList.add('on'); if(isEnergized) { el.classList.add('energized'); } else { el.classList.remove('energized'); } el.innerText = '||'; } else { el.classList.add('off'); el.classList.remove('energized'); el.innerText = '||'; } return; }
        if(d.type === 'LBS') { if(isOn) { el.classList.add('lbs-red'); el.innerText = 'L'; } else { el.classList.add('lbs-green'); el.innerText = 'L'; } } 
        else if (id === '1003') { if(isOn) { el.classList.add('on'); el.innerText = 'X'; } else { el.classList.add('lbs-green'); el.classList.remove('off'); el.innerText = 'O'; } } 
        else { if(isOn) el.classList.add('on'); else el.classList.add('off'); if(d.type==='VCB') el.innerText = isOn ? 'X' : 'O'; else if(d.type==='ISO') el.innerText = '/'; else el.innerText = isOn ? 'X' : '/'; }
        if(d.rack === 'TEST') el.classList.add('racked-out'); else el.classList.remove('racked-out');
    }
    // LOGIK KABEL RMU KE RMU - UPDATE DENGAN ARAH ARUS YANG BETUL
    function updateLinkFlow(tId, s1, s2, cableId1, busStates) {
        let bus1Live = busStates[s1], bus2Live = busStates[s2]; 
        let sw1 = false, sw2 = false;
        let sw1Id = '', sw2Id = '';
        
        // Tentukan switch ID berdasarkan link ID
        if(tId === 't1') { 
            sw1Id = '2002'; sw2Id = '4003';  // Lok Kawi <-> Papar
        }
        else if(tId === 't2') { 
            sw1Id = '2004'; sw2Id = '3004';  // Lok Kawi <-> Putatan
        }
        else if(tId === 't3') { 
            sw1Id = '3002'; sw2Id = '4002';  // Putatan <-> Papar
        }
        else if(tId === 't4') { 
            sw1Id = '3005'; sw2Id = '5001';  // Putatan <-> Limau
        }
        else if(tId === 't5') { 
            sw1Id = '4004'; sw2Id = '5002';  // Papar <-> Limau
        }
        
        // Check status switch (RMU CLOSE = iso && cb)
        sw1 = isLive(sw1Id);
        sw2 = isLive(sw2Id);
        
        // EXCEPTION: Pasangan Papar 4004 - Limau 5002 adalah DIBENARKAN untuk kedua-dua CLOSE
        // Ini adalah kes khas di mana kedua-dua RMU boleh CLOSE pada masa yang sama
        // kerana Papar memberi bekalan kepada Limau (system memberi bekalan pencawang ke pencawang)
        const isAllowedPair = (sw1Id === '4004' && sw2Id === '5002') || (sw1Id === '5002' && sw2Id === '4004');
        
        // LOGIK 1: RMU A sambung RMU B = BOLEH TAPI PASTIKAN TIDAK ADA PERTEMBUNGAN FASA
        // LOGIK 2: Satu ON (CLOSE/merah), satu OFF (OPEN/hijau) = BOLEH
        // LOGIK 3: Jika A CLOSE dan B OPEN = arus dari A ke B (fwd) - ARUS BOLEH MENGALIR WALAUPUN RMU B DALAM STANDBY
        // LOGIK 4: Jika B CLOSE dan A OPEN = arus dari B ke A (rev) - ARUS BOLEH MENGALIR WALAUPUN RMU A DALAM STANDBY
        // LOGIK 5: Jika kedua-dua CLOSE = PERTEMBUNGAN FASA (tidak boleh, trigger alarm) - KECUALI pasangan 4004-5002 (dibenarkan)
        
        let isLiveLink = false;
        let dir = 'fwd';
        let hasPhaseClash = false;
        
        // Check phase clash: KEDUA-DUA RMU CLOSE dan KEDUA-DUA BUS LIVE
        // EXCEPTION: Pasangan 4004-5002 dibenarkan untuk kedua-dua CLOSE
        if (sw1 && sw2 && bus1Live && bus2Live && !isAllowedPair) {
            hasPhaseClash = true;
            // Trigger phase clash detection (akan handle oleh checkPhaseClash())
        }
        // EXCEPTION: Jika pasangan 4004-5002 kedua-dua CLOSE = BOLEH (tiada phase clash)
        else if (sw1 && sw2 && bus1Live && bus2Live && isAllowedPair) {
            // Papar memberi bekalan kepada Limau - kedua-dua boleh CLOSE
            isLiveLink = true;
            // Arah arus: dari Papar (4004) ke Limau (5002)
            if (sw1Id === '4004') dir = 'fwd';  // Dari Papar ke Limau
            else dir = 'rev';  // Dari Limau ke Papar (jika sw1Id adalah 5002)
        }
        // LOGIK 3: A CLOSE, B OPEN = arus dari A ke B
        else if (sw1 && !sw2 && bus1Live) {
            isLiveLink = true;
            dir = 'fwd';  // Dari bus1 ke bus2
        }
        // LOGIK 4: B CLOSE, A OPEN = arus dari B ke A
        else if (!sw1 && sw2 && bus2Live) {
            isLiveLink = true;
            dir = 'rev';  // Dari bus2 ke bus1
        }
        // Jika kedua-dua OPEN = tiada arus
        else if (!sw1 && !sw2) {
            isLiveLink = false;
        }
        // Jika salah satu bus live dan switch close (restoration scenario)
        else if ((bus1Live && sw1) || (bus2Live && sw2)) {
            isLiveLink = true;
            if (bus1Live && sw1) dir = 'fwd';
            else if (bus2Live && sw2) dir = 'rev';
        }
        
        // Update visual kabel (jika phase clash, tetap tunjukkan visual tapi dengan fault)
        setCableFlow(cableId1, isLiveLink || hasPhaseClash, dir, hasPhaseClash, true);
    }
    function mkFuse(pre, n) {
        let h = `<div class="lv-busbar-horz" id="bus-${pre}-lv"></div>`;
        let fuseNames = [];
        if (pre === 'lm') { fuseNames = ['lm-f5', 'lm-f4', 'lm-f3', 'lm-f2']; } else if (pre === 'lk') { fuseNames = ['lk-f5', 'lk-f6', 'lk-f7', 'lk-f8']; } else if (pre === 'pt') { fuseNames = ['pt-f5', 'pt-f6', 'pt-f7', 'pt-f8']; } else { fuseNames = Array.from({length: n}, (_, i) => `${pre}-f${i + 1}`); }
        fuseNames.forEach((id, index) => {
            let isNop = (id === 'lk-f7' || id === 'pt-f8' || id === 'lm-f5');
            if(fuses[id] === undefined) fuses[id] = isNop ? 0 : 1;
            let label = isNop ? 'NOP' : id.split('-')[1].toUpperCase();
            let clk = isNop ? `selNop('${id}')` : `selFuseStd('${id}')`;
            h+=`<div class="fuse-unit ${isNop?'fuse-nop':''}"><div class="fuse-lbl">${label}</div><div class="fuse-tap" id="t-${id}"></div><div class="fuse-box ${isNop?'empty':'on'}" id="${id}" onclick="${clk}">|</div><div class="fuse-line-out" id="l-${id}"></div></div>`;
        });
        document.getElementById('fs-'+pre).innerHTML = h;
    }
    function updateMeter(id, amps, volts) {
        const ma = document.getElementById(`m-${id}-a`);
        const mv = document.getElementById(`m-${id}-v`);
        let finalAmps = amps > 0 ? amps + (Math.random() * 5 - 2.5) : 0;
        let finalVolts = volts > 0 ? volts + (Math.random() * 0.1 - 0.05) : 0;
        if(ma) ma.innerText = `${finalAmps.toFixed(0)} A`;
        if(mv) mv.innerText = `${finalVolts.toFixed(1)} kV`;
    }

    function calc() {
        let b={kinA:0,kinB:0,lk:0,pt:0,pp:0,lm:0}; 
        if(net['1001'].st && net['1001'].rack==='SERVICE') b.kinA=1; if(net['1002'].st && net['1002'].rack==='SERVICE') b.kinB=1; if(net['1003'].st && net['1003'].rack==='SERVICE') { if(b.kinA) b.kinB=1; if(b.kinB) b.kinA=1; }
        if(isLive('1004') && isLive('2001') && b.kinA) b.lk=1; if(isLive('1005') && isLive('3001') && b.kinA) b.pt=1; if(isLive('1006') && isLive('4001') && b.kinB) b.pp=1;
        for(let i=0;i<4;i++) { if(isLive('2002') && isLive('4003')){ if(b.lk)b.pp=1; if(b.pp)b.lk=1; } if(isLive('2004') && isLive('3004')){ if(b.lk)b.pt=1; if(b.pt)b.lk=1; } if(isLive('3002') && isLive('4002')){ if(b.pt)b.pp=1; if(b.pp)b.pt=1; } if(isLive('3005') && isLive('5001')){ if(b.pt)b.lm=1; if(b.lm)b.pt=1; } if(isLive('4004') && isLive('5002')){ if(b.pp)b.lm=1; if(b.lm)b.pp=1; } }
        let t={lk:0,pt:0,lm:0}; if(b.lk && isLive('2003')) t.lk = 1; if(b.pt && isLive('3003')) t.pt = 1; if(b.lm && isLive('5003')) t.lm = 1; 
        let lk_bus = t.lk && net['lk-link'].st; let pt_bus = t.pt && net['pt-link'].st; let lm_bus = t.lm && net['lm-link'].st;
        for(let i=0;i<3;i++) {
            let lk7 = fuses['lk-f7']; let lm4 = fuses['lm-f4']; let pt8 = fuses['pt-f8']; let lk8 = fuses['lk-f8']; let lm5 = fuses['lm-f5']; let pt7 = fuses['pt-f7'];
            if(lk_bus && lk7 && lm4) lm_bus = 1; if(lm_bus && lm4 && lk7) lk_bus = 1; if(pt_bus && pt8 && lk8) lk_bus = 1; if(lk_bus && lk8 && pt8) pt_bus = 1; if(lm_bus && lm5 && pt7) pt_bus = 1; if(pt_bus && pt7 && lm5) lm_bus = 1;
        }
        globalState = {b, t, lk_bus, pt_bus, lm_bus}; 
        
        // Update Sound & Meters
        updateMeter('1001', b.kinA ? 450 : 0, b.kinA ? 11.0 : 0);
        updateMeter('1002', b.kinB ? 420 : 0, b.kinB ? 11.0 : 0);
        updateMeter('1004', isLive('1004') ? 120 : 0, 0);
        updateMeter('1005', isLive('1005') ? 115 : 0, 0);
        updateMeter('1006', isLive('1006') ? 130 : 0, 0);
        
        // Check if any transformer is live to buzz
        let anyTxLive = (t.lk || t.pt || t.lm);
        updateHum(anyTxLive);

        draw();
    }

    function draw() {
        let {b, t, lk_bus, pt_bus, lm_bus} = globalState;
        colBus('bus-kin-a', b.kinA); colBus('bus-kin-b', b.kinB); colBus('bus-lk', b.lk); colBus('bus-pt', b.pt); colBus('bus-pp', b.pp); colBus('bus-lm', b.lm);
        const allSwitches = Object.keys(net).filter(id => !id.startsWith('e'));
        allSwitches.forEach(id => { 
            let energized = false; let d = net[id]; 
            if(id === 'lk-link') energized = globalState.t.lk || globalState.lk_bus; 
            else if(id === 'pt-link') energized = globalState.t.pt || globalState.pt_bus; 
            else if(id === 'lm-link') energized = globalState.t.lm || globalState.lm_bus; 
            else energized = true; 
            updateSwitchVisual(id, energized); 
        });
        setCableFlow('c1', isLive('1004') && b.kinA, 'rev', net['1004'].relayTrip); 
        setCableFlow('c2', isLive('1005') && b.kinA, 'rev', net['1005'].relayTrip); 
        setCableFlow('c3', isLive('1006') && b.kinB, 'rev', net['1006'].relayTrip);
        updateLinkFlow('t1', 'lk', 'pp', 't1', b);
        updateLinkFlow('t2', 'lk', 'pt', 't2', b);
        updateLinkFlow('t3', 'pt', 'pp', 't3', b);
        updateLinkFlow('t4', 'pt', 'lm', 't4', b);
        updateLinkFlow('t5', 'pp', 'lm', 't5', b);
        
        // Check for phase clash after updating all link flows
        // NOTA: checkPhaseClash() akan check semua pasangan, dan triggerPhaseClashEvent() akan double-check
        // sebelum trigger siren untuk memastikan benar-benar ada pertembungan fasa yang sebenar
        if(globalState) {
            const clashes = checkPhaseClash();
            if (clashes.length > 0) {
                triggerPhaseClashEvent(clashes);
            }
        }
        
        setCableFlow('c-lk-rmu-tx', t.lk, 'fwd'); 
        setCableFlow('c-pt-rmu-tx', t.pt, 'fwd'); 
        setCableFlow('c-lm-rmu-tx', t.lm, 'fwd');
        colLv('c-lk-tx-link', t.lk); setCableFlow('c-lk-tx-link', t.lk, 'fwd');
        colLv('c-pt-tx-link', t.pt); setCableFlow('c-pt-tx-link', t.pt, 'fwd');
        colLv('c-lm-tx-link', t.lm); setCableFlow('c-lm-tx-link', t.lm, 'fwd');
        colLv('c-lk-link-bus', lk_bus); setCableFlow('c-lk-link-bus', lk_bus, 'fwd');
        colLv('c-pt-link-bus', pt_bus); setCableFlow('c-pt-link-bus', pt_bus, 'fwd');
        colLv('c-lm-link-bus', lm_bus); setCableFlow('c-lm-link-bus', lm_bus, 'fwd');
        lvBus('bus-lk-lv', lk_bus); lvBus('bus-pt-lv', pt_bus); lvBus('bus-lm-lv', lm_bus);
        let lk7=fuses['lk-f7'], lm4=fuses['lm-f4']; let link1_live = (lk_bus && lk7) || (lm_bus && lm4);
        let pt8=fuses['pt-f8'], lk8=fuses['lk-f8']; let link2_live = (pt_bus && pt8) || (lk_bus && lk8);
        let lm5=fuses['lm-f5'], pt7=fuses['pt-f7']; let link3_live = (lm_bus && lm5) || (pt_bus && pt7);
        for(let f in fuses) {
            let prefix = f.split('-')[0]; let busStatus = (prefix==='lk'?lk_bus : prefix==='pt'?pt_bus : lm_bus); let isClosed = fuses[f]; let isLineLive = busStatus && isClosed;
            if(f === 'lk-f7' && link1_live) isLineLive = true; if(f === 'lm-f4' && link1_live) isLineLive = true; if(f === 'pt-f8' && link2_live) isLineLive = true; if(f === 'lk-f8' && link2_live) isLineLive = true; if(f === 'lm-f5' && link3_live) isLineLive = true; if(f === 'pt-f7' && link3_live) isLineLive = true;
            let el = document.getElementById(f); if(el) { if(isClosed) { el.className=`fuse-box ${busStatus ? 'on' : 'off'}`; el.innerText="|"; } else { el.className='fuse-box empty'; el.innerText=""; } }
            let ln = document.getElementById('l-'+f); if(ln) ln.className = isLineLive ? 'fuse-line-out on' : 'fuse-line-out';
            let tap = document.getElementById('t-'+f); if(tap) tap.className = busStatus ? 'fuse-tap on' : 'fuse-tap';
        }
        setLVTie('link-lk7-lm4', link1_live); setDot('dot-lk7', link1_live); setDot('dot-lm4', link1_live);
        setLVTie('link-pt8-lk8', link2_live); setDot('dot-pt8', link2_live); setDot('dot-lk8', link2_live);
        let dirLV = 'fwd'; if (lm_bus && fuses['lm-f5'] && (!pt_bus || !fuses['pt-f7'])) dirLV = 'rev'; 
        let svgLine = document.getElementById('link-lm5-pt7');
        if(svgLine) { svgLine.className = 'cable h' + (link3_live ? ' live-lv' : '') + (link3_live ? (dirLV==='rev'?' flow-rev':' flow-fwd') : ''); }
        setDot('dot-lm5', link3_live); setDot('dot-pt7', pt_bus);
        const earthSwitches = ['e1001', 'e1002', 'e1004', 'e1005', 'e1006', 'e2001', 'e2002', 'e2003', 'e2004', 'e3001', 'e3002', 'e3003', 'e3004', 'e3005', 'e4001', 'e4002', 'e4003', 'e4004', 'e5001', 'e5002', 'e5003', 'e5004'];
        earthSwitches.forEach(id => {
            const eEl = document.getElementById(id); if (!eEl) return;
            if (net[id]) { if (net[id].st) eEl.classList.add('active'); else eEl.classList.remove('active'); } 
            else { const parentId = id.substring(1); const parent = net[parentId]; if (parent && parent.earth) eEl.classList.add('active'); else eEl.classList.remove('active'); }
        });
        if(!globalState) return; const syncRequired = globalState.b.kinA && globalState.b.kinB; if (!syncRequired && syncTests.some(Boolean)) { syncTests = [false, false, false, false]; }
    }

    // HANDLERS (Inject Sparks & Sounds)
    function sel(id) {
        playSwitchSound();
        document.getElementById('ui-layer').classList.remove('collapsed'); selId=id; document.getElementById('dynamic-controls').innerHTML = ""; 
        let d=net[id]; if(!d && !id.includes('-f')) return;
        if(d) {
            document.getElementById('sel-info').innerHTML=`<b>${d.name}</b><br><span class="text-xs text-cyan-400">${d.type}</span>`;
            if(d.type==='VCB') renderVCB(d); else if(d.type==='RMU' || d.type==='ISO' || d.type==='CB' || d.type==='LBS') renderRMU(d); else if(d.type==='LINK') renderLink(d);
        }
        calc();
    }
    window.sel = sel;

    function renderVCB(d) {
        let h = `<div class="ctrl-group"><span class="ctrl-label">STATUS: ${d.relayTrip?'TRIPPED!':'NORMAL'}</span><button class="btn btn-cl" style="background:#ef4444; color:white;" onclick="injectFault('OC')" >SIMULASI FAULT (OC)</button><button class="btn btn-test" onclick="resetRelay()" ${d.relayTrip?'':'disabled'}>RESET RELAY</button></div>`;
        if (['1001', '1002', '1004', '1005', '1006'].includes(selId)) {
            let statusText = d.st === 0 ? 'OPEN' : (d.rack === 'TEST' ? 'RACKED OUT (TEST)' : 'NORMAL');
            h += `<div class="ctrl-group" style="border: 1px solid #06b6d4; background: rgba(6, 182, 212, 0.05);"><span class="ctrl-label" style="color:#06b6d4;">SOP KHAS ${selId} (7 LANGKAH)</span><div class="text-xs mb-2 text-center text-cyan-400">${statusText}</div>`;
            h += `<button class="btn btn-op" onclick="opVcb('OPEN')" ${d.st===0 ? 'disabled' : ''}>1. OPEN (TRIP) ${d.st===0?'(OK)':''}</button>`;
            h += `<button class="btn btn-test" onclick="opVcb('RACK_OUT')" ${d.st===0 ? '' : 'disabled'}>2. RACK OUT ${d.rack==='TEST'?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${d.phasingPre?'passed':''}" onclick="opVcb('PHASING_PRE')" ${d.rack==='TEST' ? '' : 'disabled'}>3. UJI PHASING STICK (SELEPAS) ${d.phasingPre?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${d.pcd?'passed':''}" onclick="opVcb('PCD')" ${d.phasingPre ? '' : 'disabled'}>4. PCD ${d.pcd?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${d.phasingPost?'passed':''}" onclick="opVcb('PHASING_POST')" ${d.pcd ? '' : 'disabled'}>5. UJI PHASING STICK (SELEPAS) ${d.phasingPost?'(OK)':''}</button>`;
            h += `<button class="btn btn-ea ${d.cme?'active':''}" onclick="opVcb('CME')" ${d.phasingPost ? '' : 'disabled'}>6. CME ${d.cme?'(ON)':'(OFF)'}</button>`;
            h += `<button class="btn btn-test ${d.lockNotice?'passed':''}" onclick="opVcb('LOCK_NOTICE')" ${d.cme ? '' : 'disabled'}>7. KUNCI DAN NOTIS ${d.lockNotice?'(OK)':''}</button>`;
            h += `</div><div class="mt-2"><button class="btn btn-op" style="border:1px dashed #666" onclick="opVcb('RESET_1004')">RESET ${selId} (DEMO)</button></div>`;
            h += `<div class="ctrl-group" style="margin-top: 15px; border: 1px solid #22c55e; background: rgba(34, 197, 94, 0.05);"><span class="ctrl-label" style="color:#22c55e;">SOP RACK IN / PEMULIHAN</span>`;
            h += `<button class="btn btn-test" onclick="opVcb('REMOVE_LOCK')" ${d.lockNotice ? '' : 'disabled'}>1. BUKA KUNCI DAN NOTIS ${!d.lockNotice && d.cme ? '(OK)' : ''}</button>`;
            h += `<button class="btn btn-ea active" onclick="opVcb('OPEN_CME')" ${!d.lockNotice && d.cme ? '' : 'disabled'}>2. BUKA CME ${!d.cme && d.rack==='TEST' ? '(OK)' : ''}</button>`;
            h += `<button class="btn btn-test" onclick="opVcb('RACK_IN_1004')" ${!d.cme && d.rack==='TEST' ? '' : 'disabled'}>3. RACK IN ${d.rack==='SERVICE'?'(OK)':''}</button>`;
            h += `<button class="btn btn-cl" onclick="opVcb('CLOSE_1004')" ${d.rack==='SERVICE' && d.st===0 ? '' : 'disabled'}>4. CLOSE VCB ${d.st===1?'(OK)':''}</button></div>`;
        } else if (selId === '1003') {
            const syncRequired = globalState.b.kinA && globalState.b.kinB;
            const allPassed = syncTests.every(Boolean);
            let syncStatus = (globalState.b.kinA && globalState.b.kinB) ? (allPassed ? 'SYNC. PASSED' : 'SYNC. REQUIRED / FAILED') : 'NORMAL (SINGLE SOURCE)';
            h += `<div class="ctrl-group" style="border: 1px solid ${syncRequired ? '#facc15' : '#334155'}; background: rgba(234, 179, 8, ${syncRequired ? 0.1 : 0.05});"><span class="ctrl-label" style="color:${syncRequired ? '#facc15' : '#94a3b8'};">PENYEGERAKAN (PARALLEL)</span><div class="text-xs mb-2 text-center text-yellow-400">${syncStatus}</div>${syncRequired ? `<button class="btn btn-test ${syncTests[0]?'passed':''}" onclick="runSyncTest(0)" ${syncTests[0]?'disabled':''}>1. SUDUT FASA (Angle): ${syncTests[0]?'OK':'FAIL'}</button><button class="btn btn-test ${syncTests[1]?'passed':''}" onclick="runSyncTest(1)" ${syncTests[1]?'disabled':''}>2. TURUTAN FASA (Seq): ${syncTests[1]?'OK':'FAIL'}</button><button class="btn btn-test ${syncTests[2]?'passed':''}" onclick="runSyncTest(2)" ${syncTests[2]?'disabled':''}>3. FREKUENSI (Freq): ${syncTests[2]?'OK':'FAIL'}</button><button class="btn btn-test ${syncTests[3]?'passed':''}" onclick="runSyncTest(3)" ${syncTests[3]?'disabled':''}>4. VOLTAN (Volt): ${syncTests[3]?'OK':'FAIL'}</button>` : `<p class="text-center text-xs text-slate-500">Ujian penyegerakan tidak diperlukan.</p>`}</div>`;
            let closeDisabled = d.st || d.cme || d.rack !== 'SERVICE' || d.relayTrip || (net['e' + selId] && net['e' + selId].st);
            if (selId === '1003' && !d.st && globalState.b.kinA && globalState.b.kinB && !syncTests.every(Boolean)) { closeDisabled = true; }
            h += `<div class="ctrl-group"><span class="ctrl-label">CIRCUIT BREAKER</span><div class="btn-row"><button class="btn btn-op" onclick="opVcb('OPEN')" ${!d.st ? 'disabled' : ''}>BUKA (TRIP)</button><button class="btn btn-cl" onclick="opVcb('CLOSE')" ${closeDisabled ? 'disabled' : ''}>TUTUP</button></div></div><div class="ctrl-group"><span class="ctrl-label">RACKING</span><div class="btn-row"><button class="btn btn-test" onclick="opVcb('RACK_OUT')">RACK OUT</button><button class="btn btn-test" onclick="opVcb('RACK_IN')">RACK IN</button></div><div class="text-xs text-center text-gray-400">Posisi: ${d.rack}</div></div><div class="ctrl-group"><span class="ctrl-label">SAFETY</span><button class="btn btn-test" onclick="opVcb('PCD')">LAKUKAN PCD ${d.pcd?'(OK)':''}</button><button class="btn btn-ea ${d.cme?'active':''}" onclick="opVcb('CME')">CME ${d.cme?'(ON)':'(OFF)'}</button></div>`;
        }
        document.getElementById('dynamic-controls').innerHTML = h;
    }

    function renderRMU(d) {
        let isNopUnit = nopPairs[selId] !== undefined;
        let nopHtml = isNopUnit ? `<div class="ctrl-group" style="border: 1px dashed #facc15; background: rgba(234, 179, 8, 0.1);"><span class="ctrl-label" style="color:#facc15;">KAWALAN NOP (NORMALLY OPEN POINT)</span><div class="text-[10px] text-gray-300 mb-2">Perhatian: Memasukkan bekalan dari dua sumber adalah satu kesalahan serius.</div><button class="btn btn-test" onclick="activateNop()" style="border-left-color: #facc15;"><i class="fa-solid fa-key mr-2"></i>BUKA KUNCI / TUKAR KUNCI</button></div>` : '';
        let h = `${nopHtml}<div class="ctrl-group"><span class="ctrl-label">PEMUTUS LITAR (BREAKER)</span><div class="btn-row"><button class="btn btn-op" onclick="opRmuCb('${selId}',0)">BUKA</button><button class="btn btn-cl" onclick="opRmuCb('${selId}',1)">TUTUP</button></div><div class="text-[10px] text-center text-gray-400">Status: ${d.cb ? 'CLOSED' : 'OPEN'}</div></div><div class="ctrl-group"><span class="ctrl-label">PENGASING (ISOLATOR)</span><div class="btn-row"><button class="btn btn-op" onclick="opRmuIso('${selId}',0)">BUKA</button><button class="btn btn-cl" onclick="opRmuIso('${selId}',1)">TUTUP</button></div><div class="text-[10px] text-center text-gray-400">Status: ${d.iso ? 'CLOSED' : 'OPEN'}</div></div><div class="ctrl-group"><span class="ctrl-label">PEMBUMIAN (EARTH)</span><div class="btn-row"><button class="btn btn-ea ${!d.earth?'':'active'}" onclick="opRmuEarth('${selId}',0)">BUKA BUMI</button><button class="btn btn-ea ${d.earth?'active':''}" onclick="opRmuEarth('${selId}',1)">TUTUP BUMI</button></div></div>`;
        document.getElementById('dynamic-controls').innerHTML = h;
    }
    
    function renderLink(d) {
        // Initialize linkTests if not exists
        if (!d.linkTests) d.linkTests = [false, false, false, false];
        let linkName = d.name || selId;
        document.getElementById('sel-info').innerHTML = `<b>${linkName}</b><br><span class="text-xs text-cyan-400">LV LINK</span>`;
        let h = `<div class="ctrl-group"><span class="ctrl-label" style="color:#ef4444;">UJIAN LV LINK (WAJIB IKUT TURUTAN)</span>`;
        h += `<button class="btn btn-test ${d.linkTests[0]?'passed':''}" onclick="runLinkTest(0)">1. UJIAN PCD ${d.linkTests[0]?'(OK)':''}</button>`;
        h += `<button class="btn btn-op" onclick="runLinkTest(1)" ${!d.linkTests[0]?'disabled':''}>2. CABUT FIUS ${d.linkTests[1]?'(OK)':''}</button>`;
        h += `<button class="btn btn-test ${d.linkTests[2]?'passed':''}" onclick="runLinkTest(2)" ${!d.linkTests[1]?'disabled':''}>3. PCD SEKALI LAGI ${d.linkTests[2]?'(OK)':''}</button>`;
        h += `<button class="btn btn-ea ${d.earth?'active':''}" onclick="runLinkTest(3)" ${!d.linkTests[2]?'disabled':''}>4. BUMIKAN DI BAHAGIAN CABEL ${d.linkTests[3]?'(OK)':''}</button></div>`;
        document.getElementById('dynamic-controls').innerHTML = h;
    }
    window.runLinkTest = function(step) {
        let d = net[selId];
        if(!d || d.type !== 'LINK') return;
        if (!d.linkTests) d.linkTests = [false, false, false, false];
        
        // Validate sequence - WAJIB IKUT TURUTAN
        if (step > 0 && !d.linkTests[step-1]) {
            playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
            speakText("Sila lakukan ujian mengikut urutan yang betul.");
            return;
        }
        
        if (step === 0) {
            // Step 1: UJIAN PCD
            d.linkTests[0] = true;
            log(`[LV LINK ${selId}] 1. Ujian PCD: LULUS`);
            speakText("Ujian PCD lulus.");
        } else if (step === 1) {
            // Step 2: CABUT FIUS
            if (d.st === 1) {
                d.st = 0;
                d.linkTests[1] = true;
                log(`[LV LINK ${selId}] 2. Fius dicabut.`);
                speakText("Fius dicabut.");
                playSwitchSound();
            } else {
                playAlarm("SOP: Fius sudah dicabut!");
                speakText("Fius sudah dicabut.");
                return;
            }
        } else if (step === 2) {
            // Step 3: PCD SEKALI LAGI
            if (d.st === 1) {
                playAlarm("SOP: CABUT FIUS DAHULU!");
                speakText("Sila cabut fius dahulu.");
                return;
            }
            d.linkTests[2] = true;
            log(`[LV LINK ${selId}] 3. PCD sekali lagi: LULUS`);
            speakText("PCD sekali lagi lulus.");
        } else if (step === 3) {
            // Step 4: BUMIKAN DI BAHAGIAN CABEL
            if (d.st === 1) {
                playAlarm("SOP: CABUT FIUS DAHULU!");
                speakText("Sila cabut fius dahulu.");
                return;
            }
            d.earth = !d.earth;
            d.linkTests[3] = true;
            log(`[LV LINK ${selId}] 4. Bumikan di bahagian cabel: ${d.earth ? 'ON' : 'OFF'}`);
            speakText(`Bumikan ${d.earth ? 'dipasang' : 'dicabut'}.`);
        }
        calc();
        sel(selId);
    }

    window.opVcb = function(act) {
        let d = net[selId]; 
        let eId = 'e' + selId; 
        
        // ...existing code (1001-1006 handling)...
        if (['1001', '1002', '1004', '1005', '1006'].includes(selId)) {
            let msg = "";
            if (act === 'OPEN') { d.st = 0; msg = `STATUS VCB ${selId} OPEN`; log(msg); playBreakerSound(true); } 
            else if (act === 'RACK_OUT') { if (d.st !== 0) { deductScore(10, "Rack-Out semasa VCB ON"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("SOP: VCB MESTI OPEN DAHULU!"); playExplosionSound(); return; } d.rack = 'TEST'; log(`RACKOUT ${selId}`); }
            else if (act === 'PHASING_PRE') { if (d.rack !== 'TEST') { deductScore(5, "Phasing Test tanpa Rack-Out"); playAlarm("SOP: VCB MESTI RACK OUT DAHULU!"); return; } d.phasingPre = true; log(`UJIAN PHASING STICK DILAKUKAN`); }
            else if (act === 'PCD') { if (!d.phasingPre) { deductScore(5, "PCD tanpa Phasing Test"); playAlarm("SOP: UJI PHASING DAHULU!"); return; } d.pcd = true; log(`PROVE CIRCUIT DEAD DILAKUKAN`); }
            else if (act === 'PHASING_POST') { if (!d.pcd) { deductScore(5, "Phasing Post tanpa PCD"); playAlarm("SOP: LAKUKAN PCD DAHULU!"); return; } d.phasingPost = true; log(`UJIAN PHASING STICK DILAKUKAN`); }
            else if (act === 'CME') { if (!d.phasingPost) { deductScore(5, "CME tanpa Phasing Post"); playAlarm("SOP: UJI PHASING (SELEPAS) DAHULU!"); return; } d.cme = true; if(net['e'+selId]) net['e'+selId].st = 1; msg = "CABLE MAIN EARTH DILAKUKAN"; log(msg); }
            else if (act === 'LOCK_NOTICE') { if (!d.cme) { deductScore(5, "Lock/Notice tanpa CME"); playAlarm("SOP: CME MESTI ON DAHULU!"); return; } d.lockNotice = true; msg = "KUNCI DAN NOTIS DIPASANG"; log(msg); }
            else if (act === 'REMOVE_LOCK') { if (!d.lockNotice) { playAlarm("SOP: KUNCI DAN NOTIS SUDAH DIBUKA!"); return; } d.lockNotice = false; msg = "KUNCI DAN NOTIS DIBUKA"; log(msg); }
            else if (act === 'OPEN_CME') { if (d.lockNotice) { deductScore(5, "Buka CME sebelum Lock dibuka"); playAlarm("SOP: BUKA KUNCI DAHULU!"); return; } if (!d.cme) { playAlarm("SOP: CME SUDAH BUKA!"); return; } d.cme = false; if(net['e'+selId]) net['e'+selId].st = 0; msg = "CABLE MAIN EARTH DIBUKA"; log(msg); }
            else if (act === 'RACK_IN_1004') { if (d.cme) { deductScore(20, "Rack-In semasa CME ON (Bahaya)"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("BAHAYA: CME MESTI OFF SEBELUM RACK IN!"); playExplosionSound(); return; } d.rack = 'SERVICE'; msg = `VCB ${selId} RACK IN`; log(msg); }
            else if (act === 'CLOSE_1004') { if (d.rack !== 'SERVICE') { deductScore(5, "Close VCB tanpa Rack-In"); playAlarm("SOP: RACK IN DAHULU!"); return; } d.st = 1; msg = `VCB ${selId} CLOSED`; log(msg); playBreakerSound(false); }
            else if (act === 'RESET_1004') { d.st = 1; d.rack = 'SERVICE'; d.pcd = false; d.cme = false; d.phasingPre = false; d.phasingPost = false; d.lockNotice = false; if(net['e'+selId]) net['e'+selId].st = 0; msg = `VCB ${selId} DI-RESET KE ASAL`; log(msg); }
            if(msg) speakText(msg); sel(selId); calc();
            
            // CHECK FOR PHASE CLASH AFTER OPERATION
            setTimeout(() => {
                const clashes = checkPhaseClash();
                if (clashes.length > 0) {
                    triggerPhaseClashEvent(clashes);
                }
            }, 100);
            return; 
        }
        
        // ...existing code (1003 handling)...
        if(act==='OPEN') { d.st=0; if (selId === '1003') syncTests = [false, false, false, false]; log(`VCB ${selId}: TRIP/OPEN.`); announceStatus(selId, "VCB", 0); playBreakerSound(true); } 
        else if(act==='CLOSE') {
            if(d.relayTrip) { deductScore(10, "Close VCB semasa Relay Trip"); playSparkSound(); playAlarm("TRIP! SILA RESET RELAY."); playExplosionSound(); return; } 
            if(d.cme) { deductScore(20, "Close VCB semasa CME ON (Bahaya)"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("BAHAYA: CME (BUMI) SEDANG ON!"); playExplosionSound(); return; } 
            if(d.rack !== 'SERVICE') { deductScore(5, "Close VCB tanpa Rack-In"); playAlarm("SOP: VCB MESTI RACK-IN DAHULU."); return; }
            if(net[eId] && net[eId].st) { deductScore(10, "Interlock Feeder Earth ON"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("INTERLOCK: SUIS BUMI FEEDER ON!"); playExplosionSound(); return; }
            let bypass2of3 = false; 
            if (selId === '1003') { 
                if (globalState.b.kinA && globalState.b.kinB) { 
                    if (!syncTests.every(Boolean)) { deductScore(10, "Sync Fail"); playAlarm("INTERLOCK: UJIAN PENYEGERAKAN GAGAL!"); return; } 
                    bypass2of3 = true; 
                } 
            }
            if(['1001','1002','1003'].includes(selId) && !bypass2of3) { 
                if (!checkIncoming(selId)) { deductScore(10, "Interlock SSU (Lebih 2 Sumber)"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("INTERLOCK SSU: HANYA 2 SUMBER DIBENARKAN!"); playExplosionSound(); return; } 
            }
            d.st=1; d.pcd=false; log(`VCB ${selId}: CLOSED.`); announceStatus(selId, "VCB", 1); playBreakerSound(false);
        } else if(act==='RACK_OUT') { if(d.st === 1) { deductScore(10, "Rack-Out semasa VCB ON"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("BAHAYA: VCB MASIH HIDUP! BUKA DULU."); playExplosionSound(); return; } d.rack='TEST'; log(`VCB ${selId}: RACKED OUT (TEST POS).`); } 
        else if(act==='RACK_IN') { if(d.cme) { deductScore(20, "Rack-In semasa CME ON"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("BAHAYA: CME ON! TIDAK BOLEH RACK IN."); playExplosionSound(); return; } d.rack='SERVICE'; log(`VCB ${selId}: RACKED IN (SERVICE).`); } 
        else if(act==='PCD') { if(d.st==0) { d.pcd=true; log("PCD Dilakukan."); } else { deductScore(5, "PCD semasa VCB ON"); playSparkSound(); playAlarm("BAHAYA: VCB MASIH HIDUP!"); playExplosionSound(); } } 
        else if(act==='CME') { if(d.st === 1 || d.rack === 'SERVICE') { deductScore(20, "CME semasa VCB ON/Service"); playSparkSound(); triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y); playAlarm("BAHAYA: VCB HIDUP/SERVICE! TIDAK BOLEH BUMIKAN."); playExplosionSound(); return; } d.cme = !d.cme; if(net['e'+selId]) net['e'+selId].st = 1; log(`VCB ${selId}: CME ${d.cme?'ON':'OFF'}.`); announceStatus(selId, "CME", d.cme ? 1 : 0); }
        sel(selId); calc();
        
        // CHECK FOR PHASE CLASH AFTER OPERATION
        setTimeout(() => {
            const clashes = checkPhaseClash();
            if (clashes.length > 0) {
                triggerPhaseClashEvent(clashes);
            }
        }, 100);
    }

    // LOGIK RMU STABIL (dari kod yang diberikan)
    window.opRmuCb = function(id, state) {
        let d = net[id];
        if(state === 1) { 
            if(d.earth) { 
                deductScore(20, "RMU CB Close semasa Earth ON"); 
                playSparkSound(); 
                triggerVisualSpark(getElCenter(id).x, getElCenter(id).y); 
                playAlarm("BAHAYA: BUMI MASIH TERPASANG!"); 
                playExplosionSound(); 
                return; 
            } 
            if(d.iso === 0) { 
                deductScore(5, "RMU CB Close tanpa Isolator"); 
                playAlarm("SOP SALAH: TUTUP ISOLATOR DAHULU!"); 
                return; 
            }
            if (nopPairs[id]) {
                let partnerId = nopPairs[id]; 
                let partner = net[partnerId];
                let myBusLive = false; 
                if(id.startsWith('20')) myBusLive = globalState.b.lk; 
                else if(id.startsWith('30')) myBusLive = globalState.b.pt; 
                else if(id.startsWith('40')) myBusLive = globalState.b.pp; 
                else if(id.startsWith('50')) myBusLive = globalState.b.lm;
                let partnerBusLive = false; 
                if(partnerId.startsWith('20')) partnerBusLive = globalState.b.lk; 
                else if(partnerId.startsWith('30')) partnerBusLive = globalState.b.pt; 
                else if(partnerId.startsWith('40')) partnerBusLive = globalState.b.pp; 
                else if(partnerId.startsWith('50')) partnerBusLive = globalState.b.lm;
                let cableLiveFromPartner = (partner.cb && partner.iso) && partnerBusLive;
                if (myBusLive && cableLiveFromPartner) { 
                    deductScore(20, "RMU Phase Clash"); 
                    playSparkSound(); 
                    triggerVisualSpark(getElCenter(id).x, getElCenter(id).y); 
                    playExplosionSound(); 
                    playAlarm("BAHAYA: PERTEMBUNGAN FASA! KEDUA-DUA SUMBER HIDUP."); 
                    d.cb = 0; 
                    sel(id); 
                    calc(); 
                    return; 
                } else if (!myBusLive && cableLiveFromPartner) { 
                    log("INFO: Pemulihan Bekalan (Restoration) dari Link NOP berjaya."); 
                }
            }
            d.cb = 1; 
            log(`RMU ${id}: Breaker Ditutup.`); 
            announceStatus(id, "Breaker", 1); 
            playSwitchSound();
        } else { 
            d.cb = 0; 
            log(`RMU ${id}: Breaker Dibuka.`); 
            announceStatus(id, "Breaker", 0); 
            playSwitchSound(); 
        }
        sel(id); 
        calc();
        
        // CHECK FOR PHASE CLASH AFTER RMU OPERATION
        setTimeout(() => {
            if(globalState) {
                const clashes = checkPhaseClash();
                if (clashes.length > 0) {
                    triggerPhaseClashEvent(clashes);
                }
            }
        }, 100);
    }

    // Modified opNop - Add clash detection
    window.opNop = function(act) { 
        if(act === 'INSERT') {
            // For full test mode, must do tests 0 and 1 before inserting
            if (nopTestMode === 'full') {
                if (!nopTests[0] || !nopTests[1]) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "NOP tanpa ujian lengkap");
                    playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila lakukan ujian keterusan dan feedback dahulu.");
                    return;
                }
                // Mark test 2 (insert) as done
                nopTests[2] = true;
                log(`[NOP ${selNopId}] Masukan Fius: Fius berjaya dipasang`);
                speakText(`NOP ${selNopId} dipasang.`);
            } else {
                // Reading mode - no restrictions
                log(`NOP ${selNopId}: Dipasang.`);
                speakText(`NOP ${selNopId} dipasang.`);
            }
            let currentBusLive = false, remoteBusLive = false, remoteFuseClosed = false;
            if(selNopId === 'lk-f7') { currentBusLive = globalState.lk_bus; remoteBusLive = globalState.lm_bus; remoteFuseClosed = fuses['lm-f4']; } 
            else if(selNopId === 'pt-f8') { currentBusLive = globalState.pt_bus; remoteBusLive = globalState.lk_bus; remoteFuseClosed = fuses['lk-f8']; } 
            else if(selNopId === 'lm-f5') { currentBusLive = globalState.lm_bus; remoteBusLive = globalState.pt_bus; remoteFuseClosed = fuses['pt-f7']; }
            // LOGIK: Pertembungan fasa berlaku jika KEDUA-DUA FIUS DIPASANG dan KEDUA-DUA BUS LIVE
            // Selepas operasi ini, fius akan dipasang, jadi check: (fius akan dipasang) && (partner fius dipasang) && (kedua-dua bus live)
            if (currentBusLive && remoteBusLive && remoteFuseClosed) {
                // PERTEMBUNGAN FASA LV DETECTED!
                deductScore(20, `NOP Phase Clash: ${selNopId}`);
                playSparkSound();
                // Get partner fuse ID
                let partnerFuseId = '';
                if(selNopId === 'lk-f7') partnerFuseId = 'lm-f4';
                else if(selNopId === 'pt-f8') partnerFuseId = 'lk-f8';
                else if(selNopId === 'lm-f5') partnerFuseId = 'pt-f7';
                
                // Get positions for sparks
                let fuse1Pos = getElCenter(selNopId) || {x: window.innerWidth/2, y: window.innerHeight/2};
                let fuse2Pos = getElCenter(partnerFuseId) || {x: window.innerWidth/2, y: window.innerHeight/2};
                triggerVisualSpark(fuse1Pos.x, fuse1Pos.y);
                triggerVisualSpark(fuse2Pos.x, fuse2Pos.y);
                // Flash effect - tambah spark di tengah-tengah antara kedua fius
                triggerVisualSpark((fuse1Pos.x + fuse2Pos.x) / 2, (fuse1Pos.y + fuse2Pos.y) / 2);
                playExplosionSound();
                startSiren(); // SIREN BERBUNYI
                playAlarm(`BAHAYA: PERTEMBUNGAN FASA LV! Fius ${selNopId} dan ${partnerFuseId} KEDUA-DUA DIPASANG!`);
                addAIMessage("AMARAN: Pertembungan Fasa LV! Jangan pasang fius NOP semasa kedua-dua sumber hidup.", false);
                speakText("Amaran! Pertembungan fasa dikesan.");
                // TIDAK AUTO-REMOVE - System keselamatan hanya trigger siren dan flash
                log(`NOP ${selNopId}: Dipasang. (AMARAN: PERTEMBUNGAN FASA LV DETECTED!)`);
                fuses[selNopId] = 1; // Fius tetap dipasang (system tidak akan remove)
                calc();
                
                // TRIGGER PHASE CLASH DETECTION
                setTimeout(() => {
                    const clashes = checkPhaseClash();
                    if (clashes.length > 0) {
                        triggerPhaseClashEvent(clashes);
                    }
                }, 100);
                window.selNop(selNopId);
                return; 
            } else if (currentBusLive && !remoteBusLive && remoteFuseClosed) {
                // OK - Restoration scenario (tidak berlaku pertembungan fasa)
                if (nopTestMode !== 'full') {
                log(`NOP ${selNopId}: Dipasang. (Pemulihan bekalan - Tiada pertembungan fasa)`);
                }
            } else if (currentBusLive && !remoteFuseClosed) {
                // OK - Hanya satu fius dipasang, tidak berlaku pertembungan fasa
                if (nopTestMode !== 'full') {
                log(`NOP ${selNopId}: Dipasang. (Partner fius masih dibuka - Tiada pertembungan fasa)`);
            }
            }
            // Only log if not in full test mode (full test mode already logged above)
            if (nopTestMode !== 'full') {
                log(`NOP ${selNopId}: Dipasang.`);
                speakText(`NOP ${selNopId} dipasang.`);
            }
            fuses[selNopId] = 1;
        } else { 
            // REMOVE - NO CONDITIONS, can remove anytime
            log(`NOP ${selNopId}: Dicabut (TANPA SYARAT).`); 
            speakText(`NOP ${selNopId} dicabut.`);
            fuses[selNopId] = 0;
            // Reset test 2 (insert) when fuse is removed in full test mode
            if (nopTestMode === 'full') {
                nopTests[2] = false;
            }
        }
        calc();
        
        // CHECK FOR PHASE CLASH AFTER OPERATION
        setTimeout(() => {
            const clashes = checkPhaseClash();
            if (clashes.length > 0) {
                triggerPhaseClashEvent(clashes);
            }
        }, 100);
        window.selNop(selNopId); 
    }

    // PHASE CLASH DETECTION
    function checkPhaseClash() {
        let clashes = [];
        if (!globalState) return clashes;
        
        // EXCEPTION: Pasangan Papar 4004 - Limau 5002 adalah DIBENARKAN
        // Ini adalah kes khas di mana kedua-dua RMU boleh CLOSE pada masa yang sama
        // kerana Papar memberi bekalan kepada Limau (system memberi bekalan pencawang ke pencawang)
        const allowedPairs = ['4004-5002', '5002-4004'];
        
        // Check HV Link clashes (NOP pairs) - hanya check sekali untuk setiap pasangan
        let checkedPairs = new Set();
        Object.keys(nopPairs).forEach(id => {
            if (!nopPairs[id]) return;
            let partnerId = nopPairs[id];
            // Skip jika pasangan ini sudah di-check (untuk elak duplicate)
            let pairKey = id < partnerId ? `${id}-${partnerId}` : `${partnerId}-${id}`;
            if (checkedPairs.has(pairKey)) return;
            checkedPairs.add(pairKey);
            
            // EXCEPTION: Skip check untuk pasangan Papar 4004 - Limau 5002 (DIBENARKAN)
            if (allowedPairs.includes(pairKey)) {
                return; // Skip - pasangan ini dibenarkan untuk kedua-dua CLOSE
            }
            
            let sw1 = net[id];
            let sw2 = net[partnerId];
            if (!sw1 || !sw2) return;
            
            let bus1Live = false, bus2Live = false;
            if(id.startsWith('20')) bus1Live = globalState.b.lk;
            else if(id.startsWith('30')) bus1Live = globalState.b.pt;
            else if(id.startsWith('40')) bus1Live = globalState.b.pp;
            else if(id.startsWith('50')) bus1Live = globalState.b.lm;
            
            if(partnerId.startsWith('20')) bus2Live = globalState.b.lk;
            else if(partnerId.startsWith('30')) bus2Live = globalState.b.pt;
            else if(partnerId.startsWith('40')) bus2Live = globalState.b.pp;
            else if(partnerId.startsWith('50')) bus2Live = globalState.b.lm;
            
            // LOGIK BETUL: Pertembungan fasa hanya berlaku jika KEDUA-DUA RMU CLOSE dan KEDUA-DUA BUS LIVE
            // CONTOH: RMU 2004 & 3004 - Siren hanya berlaku jika KEDUA-DUA CLOSE
            // Jika satu OPEN dan satu CLOSE = SELAMAT (tiada siren) - arus boleh mengalir (restoration scenario)
            // Jika KEDUA-DUA CLOSE = BAHAYA (siren & flashover) - KECUALI pasangan 4004-5002 (dibenarkan)
            // SAFEGUARD: Double-check bahawa KEDUA-DUA RMU benar-benar CLOSE dan KEDUA-DUA BUS LIVE
            if(bus1Live && bus2Live && sw1.cb && sw1.iso && sw2.cb && sw2.iso) {
                clashes.push({type: 'HV', id1: id, id2: partnerId});
            }
        });
        
        // Check LV NOP clashes
        if(globalState.lk_bus && globalState.lm_bus && fuses['lk-f7'] && fuses['lm-f4']) {
            clashes.push({type: 'LV', id1: 'lk-f7', id2: 'lm-f4'});
        }
        if(globalState.pt_bus && globalState.lk_bus && fuses['pt-f8'] && fuses['lk-f8']) {
            clashes.push({type: 'LV', id1: 'pt-f8', id2: 'lk-f8'});
        }
        if(globalState.lm_bus && globalState.pt_bus && fuses['lm-f5'] && fuses['pt-f7']) {
            clashes.push({type: 'LV', id1: 'lm-f5', id2: 'pt-f7'});
        }
        
        return clashes;
    }
    
    function triggerPhaseClashEvent(clashes) {
        if(clashes.length === 0) return;
        let hasHVClash = false;
        const allowedPairs = ['4004-5002', '5002-4004'];
        
        clashes.forEach(clash => {
            if(clash.type === 'HV') {
                // EXCEPTION: Skip trigger untuk pasangan Papar 4004 - Limau 5002 (DIBENARKAN)
                let pairKey = clash.id1 < clash.id2 ? `${clash.id1}-${clash.id2}` : `${clash.id2}-${clash.id1}`;
                if (allowedPairs.includes(pairKey)) {
                    return; // Skip - pasangan ini dibenarkan untuk kedua-dua CLOSE
                }
                
                // SAFEGUARD: Double-check bahawa KEDUA-DUA RMU benar-benar CLOSE sebelum trigger siren
                let sw1 = net[clash.id1];
                let sw2 = net[clash.id2];
                if (!sw1 || !sw2 || !sw1.cb || !sw1.iso || !sw2.cb || !sw2.iso) {
                    // Jika salah satu RMU tidak close, skip (jangan trigger siren)
                    return;
                }
                
                // SAFEGUARD: Double-check bahawa KEDUA-DUA BUS benar-benar LIVE
                let bus1Live = false, bus2Live = false;
                if(clash.id1.startsWith('20')) bus1Live = globalState.b.lk;
                else if(clash.id1.startsWith('30')) bus1Live = globalState.b.pt;
                else if(clash.id1.startsWith('40')) bus1Live = globalState.b.pp;
                else if(clash.id1.startsWith('50')) bus1Live = globalState.b.lm;
                
                if(clash.id2.startsWith('20')) bus2Live = globalState.b.lk;
                else if(clash.id2.startsWith('30')) bus2Live = globalState.b.pt;
                else if(clash.id2.startsWith('40')) bus2Live = globalState.b.pp;
                else if(clash.id2.startsWith('50')) bus2Live = globalState.b.lm;
                
                if (!bus1Live || !bus2Live) {
                    // Jika salah satu bus tidak live, skip (jangan trigger siren)
                    return;
                }
                
                hasHVClash = true;
                // PERCIKAN di kedua-dua RMU
                const pos1 = getElCenter(clash.id1);
                const pos2 = getElCenter(clash.id2);
                triggerVisualSpark(pos1.x, pos1.y);
                triggerVisualSpark(pos2.x, pos2.y);
                // Flash effect - tambah spark di tengah-tengah antara kedua RMU
                triggerVisualSpark((pos1.x + pos2.x) / 2, (pos1.y + pos2.y) / 2);
                playSparkSound();
                playExplosionSound();
                startSiren(); // SIREN
                playAlarm(`BAHAYA: PERTEMBUNGAN FASA HV DETECTED antara ${clash.id1} dan ${clash.id2}!`);
                deductScore(20, `Phase Clash HV: ${clash.id1}-${clash.id2}`);
            } else if(clash.type === 'LV') {
                // PERCIKAN di kedua-dua fius
                const pos1 = getElCenter(clash.id1) || {x: window.innerWidth/2, y: window.innerHeight/2};
                const pos2 = getElCenter(clash.id2) || {x: window.innerWidth/2, y: window.innerHeight/2};
                triggerVisualSpark(pos1.x, pos1.y);
                triggerVisualSpark(pos2.x, pos2.y);
                // Flash effect - tambah spark di tengah-tengah antara kedua fius
                triggerVisualSpark((pos1.x + pos2.x) / 2, (pos1.y + pos2.y) / 2);
                playSparkSound();
                playExplosionSound();
                startSiren(); // SIREN BERBUNYI
                playAlarm(`BAHAYA: PERTEMBUNGAN FASA LV DETECTED antara ${clash.id1} dan ${clash.id2}!`);
                deductScore(20, `Phase Clash LV: ${clash.id1}-${clash.id2}`);
            }
        });
    }

    window.selNop = function(id) {
        playSwitchSound();
        if (selNopId !== id) { 
            nopPhase1 = false; 
            nopTests = [false, false, false, false, false]; 
            nopReadings = [false, false, false, false, false];
            nopTestMode = 'reading'; // Default to reading mode
        }
        selNopId = id; selFuseId = null; selId = null;
        let isC = fuses[id]; let nopName = id; if (id === 'lk-f7') nopName = 'NOP (Lok Kawi)'; else if (id === 'pt-f8') nopName = 'NOP (Putatan)'; else if (id === 'lm-f5') nopName = 'NOP (Limau-Limauan)';
        document.getElementById('sel-info').innerHTML = `<b>${nopName}</b><br>${isC?'TERPASANG':'KOSONG'}<br><span style="font-size:0.8rem; color:#06b6d4;">Mod: ${nopTestMode === 'reading' ? 'BACAN SAHAJA' : 'UJIAN PENUH'}</span>`;
        let h = '';
        // Mode selection buttons
        h += `<div class="ctrl-group"><span class="ctrl-label">PILIH MOD UJIAN</span><button class="btn ${nopTestMode === 'reading' ? 'btn-test passed' : 'btn-test'}" onclick="setNopMode('reading')">MOD BACAN SAHAJA (SEBELUM MATIKAN RMU)</button><button class="btn ${nopTestMode === 'full' ? 'btn-test passed' : 'btn-test'}" onclick="setNopMode('full')">MOD UJIAN PENUH (SELEPAS MATIKAN RMU)</button></div>`;
        
        if (nopTestMode === 'reading') {
            // READING MODE - Before RMU transformer off, just take readings, no sequence required
            h += `<div class="ctrl-group"><span class="ctrl-label" style="color:#facc15;">MOD BACAN SAHAJA (TIDAK PERLU IKUT TURUTAN)</span>`;
            h += `<button class="btn btn-test ${nopReadings[0]?'passed':''}" onclick="runNopReading(0)">1. UJI VOLTAN PADA BUSBAR ${nopReadings[0]?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${nopReadings[1]?'passed':''}" onclick="runNopReading(1)">2. UJI VOLTAN PADA KABEL ${nopReadings[1]?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${nopReadings[2]?'passed':''}" onclick="runNopReading(2)">3. UJI PHASE SEQUENCE ROTATING PADA BUSBAR ${nopReadings[2]?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${nopReadings[3]?'passed':''}" onclick="runNopReading(3)">4. UJI PHASE SEQUENCE ROTATING PADA KABEL ${nopReadings[3]?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${nopReadings[4]?'passed':''}" onclick="runNopReading(4)">5. UJI LV PHASING ${nopReadings[4]?'(OK)':''}</button></div>`;
        } else {
            // FULL TEST MODE - After RMU transformer off, same tests as standard fuses - WAJIB IKUT TURUTAN
            h += `<div class="ctrl-group"><span class="ctrl-label" style="color:#ef4444;">MOD UJIAN PENUH (WAJIB IKUT TURUTAN)</span>`;
            h += `<button class="btn btn-test ${nopTests[0]?'passed':''}" onclick="runNopTest(0)">1. UJI KETERUSAN FIUS ${nopTests[0]?'(OK)':''}</button>`;
            h += `<button class="btn btn-test ${nopTests[1]?'passed':''}" onclick="runNopTest(1)" ${!nopTests[0]?'disabled':''}>2. UJI FEEDBACK ${nopTests[1]?'(OK)':''}</button>`;
            let canInsert = nopTests[0] && nopTests[1];
            if (!isC) { 
                h += `<button class="btn btn-cl" style="margin: 10px 0; border: 2px solid #fff;" onclick="opNop('INSERT')" ${canInsert ? '' : 'disabled'}>3. MASUKAN FIUS</button>`; 
            } else { 
                h += `<button class="btn btn-op" style="margin: 10px 0; border: 2px solid #ef4444;" onclick="opNop('REMOVE')">CABUT FIUS</button>`; 
            }
            h += `<button class="btn btn-test ${nopTests[2]?'passed':''}" onclick="runNopTest(2)" ${!isC?'disabled':''}>4. UJIAN CONDITION FIUS ${nopTests[2]?'(OK)':''}</button>`;
            let canTest5 = isC && nopTests[2];
            h += `<button class="btn btn-test ${nopTests[3]?'passed':''}" onclick="runNopTest(3)" ${canTest5 ? '' : 'disabled'}>5. UJIAN FEEDBACK ${nopTests[3]?'(OK)':''}</button></div>`;
        }
        document.getElementById('dynamic-controls').innerHTML = h;
    }
    window.setNopMode = function(mode) {
        if (nopTestMode === mode) return;
        nopTestMode = mode;
        if (mode === 'reading') {
            nopReadings = [false, false, false, false, false];
            log(`[NOP ${selNopId}] Mod ditukar kepada: BACAN SAHAJA (Sebelum matikan RMU transformer)`);
        } else {
            nopTests = [false, false, false, false, false];
            log(`[NOP ${selNopId}] Mod ditukar kepada: UJIAN PENUH (Selepas matikan RMU transformer)`);
        }
        window.selNop(selNopId);
    }
    window.runNopReading = function(i) {
        if(nopReadings[i]) return; // Prevent duplicate readings
        nopReadings[i] = true;
        const readingNames = ["Uji Voltan pada Busbar", "Uji Voltan pada Kabel", "Uji Phase Sequence Rotating pada Busbar", "Uji Phase Sequence Rotating pada Kabel", "Uji LV Phasing"];
        const readingDetails = [
            "Uji Voltan pada Busbar: R=11.0kV, S=11.0kV, T=11.0kV",
            "Uji Voltan pada Kabel: R=0V, S=0V, T=0V (KOSONG)",
            "Uji Phase Sequence Rotating pada Busbar: R-S-T (SEQUENCE BETUL)",
            "Uji Phase Sequence Rotating pada Kabel: R-S-T (SEQUENCE BETUL)",
            "Uji LV Phasing: Fasa R-R, S-S, T-T sepadan"
        ];
        log(`[NOP ${selNopId}] ${readingDetails[i]}`);
        speakText(`${readingNames[i]} direkod.`);
        window.selNop(selNopId);
    }
    window.runNopPhase1 = function() { 
        if(nopPhase1) return;
        nopPhase1 = true; 
        log(`[NOP ${selNopId}] FASA 1: Rekod Data Beban & Voltan - Beban: 50kW, Voltan Busbar: 11kV, Voltan Kabel: 0V (KOSONG) - SELESAI`);
        speakText("Rekod data beban dan voltan selesai. Sila teruskan ke fasa dua.");
        window.selNop(selNopId); 
    }
    window.runNopTest = function(i) { 
        if(nopTests[i]) return; // Prevent duplicate tests
        
        // Only validate sequence in full test mode (after RMU transformer off)
        if (nopTestMode === 'full') {
            // WAJIB IKUT TURUTAN: 1. UJI KETERUSAN, 2. UJI FEEDBACK, (3=INSERT), 4. UJIAN CONDITION, 5. UJIAN FEEDBACK
            if (i === 3 || i === 4) {
                // Tests 3 and 4 require fuse to be inserted
                let isC = fuses[selNopId];
                if (!isC) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Ujian NOP tanpa masukkan fius dahulu");
                    playAlarm("SOP: Sila masukkan fius dahulu!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila masukkan fius dahulu sebelum ujian condition dan feedback.");
                    return;
                }
                // Test 3 requires test 2 (insert) to be done
                if (i === 3 && !nopTests[2]) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Ujian NOP tanpa masukkan fius dahulu");
                    playAlarm("SOP: Sila masukkan fius dahulu!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila masukkan fius dahulu.");
                    return;
                }
                // Test 4 requires test 3 to be done
                if (i === 4 && !nopTests[3]) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Ujian NOP tidak mengikut turutan");
                    playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila lakukan ujian condition dahulu.");
                    return;
                }
            } else if (i > 0 && !nopTests[i-1]) {
                // For test 1, must do test 0 first
                // Wrong step - only siren, no flashover
                deductScore(5, "Ujian NOP tidak mengikut turutan");
                playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
                startSiren(); // Only siren, no flashover
                speakText("Sila lakukan ujian mengikut urutan yang betul.");
                return;
            }
        }
        
        nopTests[i] = true; 
        const testNames = ["Ujian Keterusan Fius", "Ujian Feedback", "Masukan Fius", "Ujian Condition Fius", "Ujian Feedback"];
        const testDetails = [
            "Ujian Keterusan Fius: Rintangan < 0.1Ω (LULUS)",
            "Ujian Feedback: Voltan pengguna = 240V, Fasa = R-S-T (LULUS)",
            "Masukan Fius: Fius berjaya dipasang",
            "Ujian Condition Fius: Tiada kerosakan fizikal, Rating = 100A (LULUS)",
            "Ujian Feedback: Voltan stabil = 240V, Arus beban normal (LULUS)"
        ];
        log(`[NOP ${selNopId}] ${testDetails[i]}`);
        speakText(`${testNames[i]} ${i === 2 ? 'berjaya' : 'lulus'}.`);
        
        // Check if all tests completed for full test mode
        if (nopTestMode === 'full' && nopTests.every(t => t)) {
                setTimeout(() => {
                log(`[NOP ${selNopId}] SEMUA 5 UJIAN SELESAI`);
                speakText("Semua ujian NOP selesai.");
            }, 1000);
        }
        window.selNop(selNopId); 
    }
    
    window.selFuseStd = function(id) {
        playSwitchSound();
        if (selFuseId !== id) { fuseTests = [false, false, false, false, false]; } // 5 tests for standard fuses
        selFuseId = id; selNopId = null; selId = null; let isC = fuses[id];
        document.getElementById('sel-info').innerHTML = `<b>FIUS PENGGUNA: ${id}</b><br>${isC?'TERPASANG':'DICABUT'}`;
        let h = "";
        if (id.startsWith('lk-') || id.startsWith('pt-') || id.startsWith('lm-')) {
            let stationName = 'STESEN';
            if(id.startsWith('lk-')) stationName = 'PE LOKAWI'; else if(id.startsWith('pt-')) stationName = 'PE PUTATAN'; else if(id.startsWith('lm-')) stationName = 'PE LIMAU-LIMAUAN';
            h += `<div class="ctrl-group"><span class="ctrl-label" style="color:#06b6d4;">SOP KHAS ${stationName} (LANGKAH DEMI LANGKAH)</span><button class="btn btn-test ${fuseTests[0]?'passed':''}" onclick="runFuseTest(0)" ${isC ? 'disabled' : ''}>1. UJIAN KETERUSAN FIUS ${fuseTests[0]?'(OK)':''}</button><button class="btn btn-test ${fuseTests[1]?'passed':''}" onclick="runFuseTest(1)" ${isC ? 'disabled' : ''}>2. UJIAN FEEDBACK ${fuseTests[1]?'(OK)':''}</button>`;
            let canInsert = fuseTests[0] && fuseTests[1];
            if (!isC) { h += `<button class="btn btn-cl" style="margin: 10px 0; border: 2px solid #fff;" onclick="opFuse('INSERT')" ${canInsert ? '' : 'disabled'}>3. PASANG FIUS (ACTION)</button>`; } 
            else { h += `<button class="btn btn-op" style="margin: 10px 0; border: 2px solid #ef4444;" onclick="opFuse('REMOVE')">CABUT FIUS (RESET)</button>`; }
            h += `<button class="btn btn-test ${fuseTests[2]?'passed':''}" onclick="runFuseTest(2)" ${!isC ? 'disabled' : ''}>4. UJIAN KONDESI FIUS ${fuseTests[2]?'(OK)':''}</button>`;
            let canTest5 = isC && fuseTests[2]; h += `<button class="btn btn-test ${fuseTests[3]?'passed':''}" onclick="runFuseTest(3)" ${canTest5 ? '' : 'disabled'}>5. UJIAN FEEDBACK SEKALI LAGI ${fuseTests[3]?'(OK)':''}</button></div>`;
        } else {
             // Standard fuses - WAJIB IKUT TURUTAN: 1. UJI KETERUSAN, 2. UJI FEEDBACK, 3. MASUKAN FIUS, 4. UJIAN CONDITION, 5. UJIAN FEEDBACK
             h += `<div class="ctrl-group"><span class="ctrl-label" style="color:#ef4444;">SOP PEMASANGAN (WAJIB IKUT TURUTAN)</span>`;
             h += `<button class="btn btn-test ${fuseTests[0]?'passed':''}" onclick="runFuseTest(0)">1. UJI KETERUSAN FIUS ${fuseTests[0]?'(OK)':''}</button>`;
             h += `<button class="btn btn-test ${fuseTests[1]?'passed':''}" onclick="runFuseTest(1)" ${!fuseTests[0]?'disabled':''}>2. UJI FEEDBACK ${fuseTests[1]?'(OK)':''}</button>`;
             let canInsert = fuseTests[0] && fuseTests[1];
             if (!isC) { 
                 h += `<button class="btn btn-cl" style="margin: 10px 0; border: 2px solid #fff;" onclick="opFuse('INSERT')" ${canInsert ? '' : 'disabled'}>3. MASUKAN FIUS</button>`; 
             } else { 
                 h += `<button class="btn btn-op" style="margin: 10px 0; border: 2px solid #ef4444;" onclick="opFuse('REMOVE')">CABUT FIUS</button>`; 
             }
             h += `<button class="btn btn-test ${fuseTests[2]?'passed':''}" onclick="runFuseTest(2)" ${!isC?'disabled':''}>4. UJIAN CONDITION FIUS ${fuseTests[2]?'(OK)':''}</button>`;
             let canTest5 = isC && fuseTests[2];
             h += `<button class="btn btn-test ${fuseTests[3]?'passed':''}" onclick="runFuseTest(3)" ${canTest5 ? '' : 'disabled'}>5. UJIAN FEEDBACK ${fuseTests[3]?'(OK)':''}</button></div>`;
        }
        document.getElementById('dynamic-controls').innerHTML = h; 
    }
    window.runFuseTest = function(i) { 
        if(fuseTests[i]) return; // Prevent duplicate tests
        // Validate test sequence for standard fuses (non-station) - WAJIB IKUT TURUTAN
        if (!selFuseId.startsWith('lk-') && !selFuseId.startsWith('pt-') && !selFuseId.startsWith('lm-')) {
            // Standard fuses must do tests in order: 0, 1, (2=insert fuse), 3, 4
            // Test 2 is actually inserting the fuse, so we check tests 0,1 before allowing insert
            // For tests 3 and 4, fuse must be inserted first (isC)
            if (i === 3 || i === 4) {
                // Tests 3 and 4 require fuse to be inserted
                let isC = fuses[selFuseId];
                if (!isC) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Ujian fius tanpa masukkan fius dahulu");
                    playAlarm("SOP: Sila masukkan fius dahulu!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila masukkan fius dahulu sebelum ujian condition dan feedback.");
                return;
                }
                // Test 3 requires test 2 (insert) to be done
                if (i === 3 && !fuseTests[2]) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Ujian fius tanpa masukkan fius dahulu");
                    playAlarm("SOP: Sila masukkan fius dahulu!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila masukkan fius dahulu.");
                    return;
                }
                // Test 4 requires test 3 to be done
                if (i === 4 && !fuseTests[3]) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Ujian fius tidak mengikut turutan");
                    playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila lakukan ujian condition dahulu.");
                    return;
                }
            } else if (i > 0 && !fuseTests[i-1]) {
                // For tests 1, must do test 0 first
                // Wrong step - only siren, no flashover
                deductScore(5, "Ujian fius tidak mengikut turutan");
                playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
                startSiren(); // Only siren, no flashover
                speakText("Sila lakukan ujian mengikut urutan yang betul.");
                return;
            }
        }
        fuseTests[i] = true; 
        const testNames = ["Ujian Keterusan Fius", "Ujian Feedback", "Masukan Fius", "Ujian Condition Fius", "Ujian Feedback"];
        const testDetails = [
            "Ujian Keterusan Fius: Rintangan < 0.1Ω (LULUS)",
            "Ujian Feedback: Voltan pengguna = 240V, Fasa = R-S-T (LULUS)",
            "Masukan Fius: Fius berjaya dipasang",
            "Ujian Condition Fius: Tiada kerosakan fizikal, Rating = 100A (LULUS)",
            "Ujian Feedback: Voltan stabil = 240V, Arus beban normal (LULUS)"
        ];
        log(`[FIUS ${selFuseId}] ${testDetails[i]}`);
        speakText(`${testNames[i]} ${i === 2 ? 'berjaya' : 'lulus'}.`);
        // Check if all tests completed for standard fuses
        if (!selFuseId.startsWith('lk-') && !selFuseId.startsWith('pt-') && !selFuseId.startsWith('lm-')) {
            if (fuseTests.every(t => t)) {
        setTimeout(() => {
                    log(`[FIUS ${selFuseId}] SEMUA 5 UJIAN SELESAI`);
                    speakText("Semua ujian fius selesai.");
                }, 1000);
            }
        }
        window.selFuseStd(selFuseId); 
    }
    
    window.opFuse = function(act) { 
        if(act === 'INSERT') { 
            // For standard fuses, must do tests 0 and 1 before inserting
            if (!selFuseId.startsWith('lk-') && !selFuseId.startsWith('pt-') && !selFuseId.startsWith('lm-')) {
                if (!fuseTests[0] || !fuseTests[1]) {
                    // Wrong step - only siren, no flashover
                    deductScore(5, "Fius tanpa ujian lengkap");
                    playAlarm("SOP: Sila lakukan ujian mengikut urutan!");
                    startSiren(); // Only siren, no flashover
                    speakText("Sila lakukan ujian keterusan dan feedback dahulu.");
                    return;
                }
                // Mark test 2 (insert) as done
                fuseTests[2] = true;
                log(`Fius ${selFuseId}: Dipasang.`); 
                speakText(`Fius ${selFuseId} dipasang.`);
            } else {
                // Station fuses
                if (!fuseTests[0] || !fuseTests[1]) { 
                    deductScore(5, "Fius tanpa ujian (Station)"); 
                    playAlarm("SOP: Lakukan Ujian Keterusan & Feedback dahulu!"); 
                    return; 
                }
                log(`Fius ${selFuseId}: Dipasang.`); 
                speakText(`Fius ${selFuseId} dipasang.`);
            }
        } else { 
            log(`Fius ${selFuseId}: Dicabut.`); 
            speakText(`Fius ${selFuseId} dicabut.`); 
            // Reset tests when fuse is removed
            if (!selFuseId.startsWith('lk-') && !selFuseId.startsWith('pt-') && !selFuseId.startsWith('lm-')) { 
                fuseTests = [false, false, false, false, false]; 
            }
        }
        fuses[selFuseId] = (act==='INSERT'?1:0); calc(); window.selFuseStd(selFuseId); 
    }


    // RMU FUNCTIONS
    // LOGIK RMU STABIL (dari kod yang diberikan)
    window.opRmuIso = function(id, state) {
        let d = net[id];
        if(state === 1) { 
            if(d.earth) { 
                deductScore(20, "RMU ISO Close semasa Earth ON"); 
                playSparkSound(); 
                triggerVisualSpark(getElCenter(id).x, getElCenter(id).y); 
                playAlarm("BAHAYA: BUMI MASIH TERPASANG!"); 
                playExplosionSound(); 
                return; 
            } 
            d.iso = 1; 
            log(`RMU ${id}: Isolator Ditutup.`); 
            announceStatus(id, "Isolator", 1); 
            playSwitchSound(); 
        } else { 
            if(d.cb === 1) { 
                deductScore(5, "RMU ISO Open semasa CB ON"); 
                playSparkSound(); 
                triggerVisualSpark(getElCenter(id).x, getElCenter(id).y); 
                playExplosionSound(); 
                playAlarm("SOP SALAH: BUKA BREAKER DAHULU!"); 
                return; 
            } 
            d.iso = 0; 
            log(`RMU ${id}: Isolator Dibuka.`); 
            announceStatus(id, "Isolator", 0); 
            playSwitchSound(); 
        }
        sel(id); 
        calc();
        
        // CHECK FOR PHASE CLASH AFTER RMU ISO OPERATION
        setTimeout(() => {
            if(globalState) {
                const clashes = checkPhaseClash();
                if (clashes.length > 0) {
                    triggerPhaseClashEvent(clashes);
                }
            }
        }, 100);
    };
    
    window.opRmuEarth = function(id, state) {
        let d = net[id];
        if(!d) return;
        if(state === 1 && (d.cb === 1 || d.iso === 1)) {
            deductScore(20, "Tutup Earth semasa CB/ISO ON");
            playSparkSound();
            triggerVisualSpark(getElCenter(id).x, getElCenter(id).y);
            playAlarm("BAHAYA: BUKA BREAKER & ISOLATOR DAHULU!");
            playExplosionSound();
            return;
        }
        d.earth = state;
        log(`RMU ${id}: Earth ${state ? 'Ditutup' : 'Dibuka'}.`);
        announceStatus(id, "Earth", state);
        playSwitchSound();
        sel(id);
        calc();
        
        // CHECK FOR PHASE CLASH AFTER RMU EARTH OPERATION
        setTimeout(() => {
            if(globalState) {
                const clashes = checkPhaseClash();
                if (clashes.length > 0) {
                    triggerPhaseClashEvent(clashes);
                }
            }
        }, 100);
    };

    // LINK FUNCTIONS
    window.opLink = function(act) {
        let d = net[selId];
        if(!d || d.type !== 'LINK') return;
        let msg = "";
        if(act === 'PCD_PRE') {
            d.prePcd = true;
            msg = "PCD Pre-work dilakukan";
            log(msg);
        } else if(act === 'PCD_POST') {
            if(d.st === 1) {
                deductScore(5, "PCD Post semasa Link ON");
                playAlarm("SOP: CABUT LINK DAHULU!");
                return;
            }
            d.postPcd = true;
            msg = "PCD Cable (Dead) dilakukan";
            log(msg);
        } else if(act === 'OPEN') {
            if(!d.prePcd) {
                deductScore(5, "Cabut Link tanpa PCD Pre");
                playAlarm("SOP: LAKUKAN PCD PRE-WORK DAHULU!");
                return;
            }
            d.st = 0;
            msg = `Link ${selId} dicabut`;
            log(msg);
            playSwitchSound();
        } else if(act === 'CLOSE') {
            if(d.earth) {
                deductScore(20, "Pasang Link semasa Earth ON");
                playSparkSound();
                triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y);
                playAlarm("BAHAYA: BUKA BUMI DAHULU!");
                playExplosionSound();
                return;
            }
            if(!d.prePcd) {
                deductScore(5, "Pasang Link tanpa PCD Pre");
                playAlarm("SOP: LAKUKAN PCD PRE-WORK DAHULU!");
                return;
            }
            d.st = 1;
            msg = `Link ${selId} dipasang`;
            log(msg);
            playSwitchSound();
        } else if(act === 'EARTH') {
            if(!d.postPcd) {
                deductScore(5, "Bumi Kabel tanpa PCD Post");
                playAlarm("SOP: LAKUKAN PCD CABLE (DEAD) DAHULU!");
                return;
            }
            if(d.st === 1) {
                deductScore(20, "Bumi Kabel semasa Link ON");
                playSparkSound();
                triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y);
                playAlarm("BAHAYA: CABUT LINK DAHULU!");
                playExplosionSound();
                return;
            }
            d.earth = !d.earth;
            msg = `Link ${selId}: Earth ${d.earth ? 'ON' : 'OFF'}`;
            log(msg);
        }
        if(msg) speakText(msg);
        sel(selId);
        calc();
    };

    // VCB FAULT FUNCTIONS
    window.injectFault = function(type) {
        let d = net[selId];
        if(!d || d.type !== 'VCB') return;
        d.fault = type;
        d.relayTrip = true;
        d.st = 0;
        log(`FAULT ${type} DETECTED! VCB ${selId} TRIPPED!`);
        playSparkSound();
        triggerVisualSpark(getElCenter(selId).x, getElCenter(selId).y);
        playExplosionSound();
        playAlarm(`FAULT ${type}! RELAY TRIP!`);
        sel(selId);
        calc();
    };
    
    window.resetRelay = function() {
        let d = net[selId];
        if(!d || d.type !== 'VCB') return;
        d.relayTrip = false;
        d.fault = null;
        log(`Relay ${selId} di-reset`);
        speakText(`Relay ${selId} di-reset`);
        sel(selId);
    };

    // SYNC TEST FUNCTION
    window.runSyncTest = function(testIndex) {
        if(syncTests[testIndex]) return;
        const testNames = ['Sudut Fasa', 'Turutan Fasa', 'Frekuensi', 'Voltan'];
        const passed = Math.random() > 0.3; // 70% pass rate
        if(passed) {
            syncTests[testIndex] = true;
            log(`Ujian Penyegerakan ${testNames[testIndex]}: LULUS`);
            speakText(`Ujian ${testNames[testIndex]} lulus`);
        } else {
            log(`Ujian Penyegerakan ${testNames[testIndex]}: GAGAL`);
            speakText(`Ujian ${testNames[testIndex]} gagal`);
            deductScore(5, `Sync Test ${testNames[testIndex]} gagal`);
        }
        sel('1003');
    };

    // UI FUNCTIONS
    window.toggleUI = function() {
        const uiLayer = document.getElementById('ui-layer');
        uiLayer.classList.toggle('collapsed');
    };
    
    window.zoom = function(delta) {
        zoomScale = Math.max(0.5, Math.min(2, zoomScale + (delta * 0.1)));
        updateTransform();
    };
    
    window.resetZoom = function() {
        zoomScale = 1;
        panX = 0;
        panY = 0;
        updateTransform();
    };
    
    function updateTransform() {
        const zoomLayer = document.getElementById('zoom-layer');
        if(zoomLayer) {
            zoomLayer.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomScale})`;
        }
    }
    
    // PAN & ZOOM HANDLERS
    const canvasContainer = document.getElementById('canvas-container');
    if(canvasContainer) {
        canvasContainer.addEventListener('mousedown', (e) => {
            if(e.button === 0) {
                isPanning = true;
                panStartX = e.clientX - panX;
                panStartY = e.clientY - panY;
            }
        });
        canvasContainer.addEventListener('mousemove', (e) => {
            if(isPanning) {
                panX = e.clientX - panStartX;
                panY = e.clientY - panStartY;
                updateTransform();
            }
        });
        canvasContainer.addEventListener('mouseup', () => { isPanning = false; });
        canvasContainer.addEventListener('mouseleave', () => { isPanning = false; });
        canvasContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -1 : 1;
            zoom(delta);
        });
    }

    // AI FUNCTIONS
    window.toggleAI = function() {
        const overlay = document.getElementById('ai-overlay');
        if(overlay) {
            const isVisible = overlay.style.display === 'flex';
            overlay.style.display = isVisible ? 'none' : 'flex';
            aiActive = !isVisible;
            
            // Update connection status apabila AI dibuka
            if (aiActive) {
                updateConnectionStatus();
                // Check connection status setiap 30 saat
                if (window.connectionCheckInterval) {
                    clearInterval(window.connectionCheckInterval);
                }
                window.connectionCheckInterval = setInterval(updateConnectionStatus, 30000);
            } else {
                // Stop checking apabila AI ditutup
                if (window.connectionCheckInterval) {
                    clearInterval(window.connectionCheckInterval);
                    window.connectionCheckInterval = null;
                }
            }
        }
    };
    
    window.triggerSmartAnalysis = async function() {
        if(!globalState) {
            addAIMessage("Tiada data sistem untuk dianalisis. Sila pilih komponen terlebih dahulu.", false);
            return;
        }
        
        addAIMessage("🔍 Menganalisis keadaan sistem...", false);
        
        // Analisis status sistem
        const analysis = `📊 ANALISIS SISTEM KESELAMATAN\n\n` +
            `Status Sumber:\n` +
            `- Bus Kinarut A: ${globalState.b.kinA ? '🟢 LIVE' : '🔴 DEAD'}\n` +
            `- Bus Kinarut B: ${globalState.b.kinB ? '🟢 LIVE' : '🔴 DEAD'}\n\n` +
            `Status Transformer:\n` +
            `- Transformer Lok Kawi: ${globalState.t.lk ? '🟢 LIVE' : '🔴 DEAD'}\n` +
            `- Transformer Putatan: ${globalState.t.pt ? '🟢 LIVE' : '🔴 DEAD'}\n` +
            `- Transformer Limau: ${globalState.t.lm ? '🟢 LIVE' : '🔴 DEAD'}\n\n`;
        
        addAIMessage(analysis, false);
        
        // Analisis keselamatan
        let safetyWarnings = [];
        let safetyCount = 0;
        
        if (globalState.b.kinA && globalState.b.kinB) {
            safetyWarnings.push("⚠️ AMARAN: Kedua-dua sumber (Bus A & B) hidup. Pastikan NOP dipasang dengan betul untuk mengelakkan pertembungan fasa.");
            safetyCount++;
        }
        
        // Semak status RMU
        const rmuStatus = [];
        for (const [id, data] of Object.entries(net)) {
            if (data.type === 'RMU' || data.type === 'LBS') {
                const rmuLive = isLive(id);
                if (rmuLive) {
                    rmuStatus.push(`${id}: LIVE`);
                }
            }
        }
        
        if (rmuStatus.length > 0) {
            addAIMessage(`📋 RMU Aktif:\n${rmuStatus.join('\n')}\n`, false);
        }
        
        // Cadangan keselamatan
        if (safetyCount > 0) {
            addAIMessage(`\n⚠️ AMARAN KESELAMATAN:\n${safetyWarnings.join('\n')}\n`, false);
            addAIMessage(`💡 CADANGAN:\n${knowledgeBase.sop.keselamatan}`, false);
        } else {
            addAIMessage(`✅ Status sistem: SELAMAT\n\nTiada amaran keselamatan dikesan.`, false);
        }
        
        speakText("Analisis selesai. " + (safetyCount > 0 ? "Terdapat amaran keselamatan." : "Sistem selamat."));
    };
    
    window.toggleSpeechRecognition = function() {
        const lang = document.getElementById('lang-select')?.value || 'ms-MY';
        if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            addAIMessage("Speech recognition tidak disokong dalam browser ini.", false);
            return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!recognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = lang;
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById('ai-input').value = transcript;
                sendAIChat();
            };
            recognition.onerror = (e) => {
                addAIMessage(`Ralat: ${e.error}`, false);
            };
        }
        recognition.lang = lang;
        if(isRecording) {
            recognition.stop();
            isRecording = false;
            document.getElementById('mic-btn').classList.remove('recording');
        } else {
            recognition.start();
            isRecording = true;
            document.getElementById('mic-btn').classList.add('recording');
        }
    };
    
    // KNOWLEDGE BASE LOKAL - Data Teknikal dan SOP (EXTENDED VERSION)
    const knowledgeBase = {
        'sop': {
            'nop': '📋 SOP NOP (Neutral Open Point):\n\n1) Pastikan kedua-dua sumber mati sebelum pasang NOP\n2) Lakukan ujian PCD (Phase Continuity Detection) terlebih dahulu\n3) Pasang fius NOP hanya selepas pengesahan fasa\n4) Jangan pasang NOP jika kedua-dua sumber hidup (pertembungan fasa)\n5) Lakukan ujian earth selepas pasang NOP\n6) Rekod semua operasi dalam log sistem',
            'fius': '📋 SOP Fius:\n\n1) Matikan sumber sebelum pasang/keluarkan fius\n2) Gunakan peralatan keselamatan yang betul (gloves, tools)\n3) Semak rating fius sesuai dengan beban\n4) Pastikan fius dipasang dengan betul dan ketat\n5) Lakukan ujian selepas pasang fius\n6) Jangan guna fius yang rosak atau melebur',
            'rmu': '📋 SOP RMU (Ring Main Unit):\n\n1) Semak status isolator dan circuit breaker sebelum operasi\n2) Pastikan tiada beban sebelum buka/tutup switch\n3) Gunakan peralatan keselamatan lengkap (PPE)\n4) Lakukan ujian keselamatan sebelum dan selepas operasi\n5) Rekod semua operasi dalam log sistem\n6) Pastikan kawasan kerja selamat dan jelas\n7) Semak mekanisme spring charging sebelum operasi\n8) Pastikan semua interlock berfungsi dengan betul',
            'keselamatan': '📋 SOP Keselamatan:\n\n1) Sentiasa gunakan PPE (Personal Protective Equipment)\n2) Matikan sumber sebelum kerja\n3) Lakukan ujian ketiadaan voltan (LOTO - Lock Out Tag Out)\n4) Pasang earth sebelum kerja\n5) Pastikan kawasan kerja selamat dan jelas\n6) Jangan kerja sendirian - pastikan ada backup\n7) Ikut prosedur keselamatan yang ditetapkan',
            'transformer': '📋 SOP Transformer:\n\n1) Semak rating dan kapasiti transformer\n2) Pastikan cooling system berfungsi dengan baik\n3) Monitor suhu dan beban secara berkala\n4) Lakukan maintenance berkala mengikut jadual\n5) Rekod semua bacaan dan operasi\n6) Pastikan transformer tidak overload\n7) Semak oil level dan quality (untuk oil-filled transformer)\n8) Semak tap changer position\n9) Monitor winding temperature',
            'isolator': '📋 SOP Isolator:\n\n1) Pastikan tiada beban sebelum buka/tutup isolator\n2) Semak status sebelum operasi\n3) Gunakan peralatan keselamatan\n4) Jangan buka/tutup di bawah beban\n5) Rekod semua operasi\n6) Semak mekanisme operasi sebelum buka/tutup',
            'circuit breaker': '📋 SOP Circuit Breaker:\n\n1) Semak status sebelum operasi\n2) Boleh buka/tutup di bawah beban\n3) Monitor trip status dan relay\n4) Lakukan maintenance berkala\n5) Rekod semua operasi dan trip events',
            'vcb': '📋 SOP VCB (Vacuum Circuit Breaker):\n\n1) Semak status VCB sebelum operasi (ON/OFF/TEST)\n2) Pastikan spring charging mechanism berfungsi\n3) Semak vacuum level dalam interrupter\n4) Boleh buka/tutup di bawah beban (rated current)\n5) Monitor trip coil dan close coil\n6) Lakukan ujian megger sebelum operasi\n7) Semak auxiliary contact status\n8) Pastikan control voltage mencukupi\n9) Rekod semua operasi dan trip events\n10) Lakukan maintenance berkala mengikut jadual',
            'kabel': '📋 SOP Kabel:\n\n1) Semak rating kabel sesuai dengan beban\n2) Pastikan kabel tidak rosak atau terdedah\n3) Semak sambungan terminal ketat dan bersih\n4) Lakukan ujian insulation resistance sebelum sambung\n5) Pastikan kabel tidak overload\n6) Semak suhu kabel tidak melebihi rating\n7) Pastikan kabel dipasang dengan betul (tidak terlipat)\n8) Gunakan kabel yang sesuai untuk aplikasi (HV/LV)\n9) Semak earthing kabel shield (untuk kabel HV)\n10) Rekod semua ujian dan pemeriksaan',
            'lv board': '📋 SOP LV Board (Low Voltage Board):\n\n1) Matikan semua MCB sebelum buka panel\n2) Semak voltan input sebelum operasi\n3) Pastikan semua sambungan terminal ketat\n4) Semak rating MCB sesuai dengan beban\n5) Lakukan ujian insulation resistance\n6) Pastikan earthing system berfungsi\n7) Semak busbar connection\n8) Monitor beban setiap fasa\n9) Pastikan kawasan panel kering dan bersih\n10) Rekod semua operasi dan maintenance',
            'potential transformer': '📋 SOP Potential Transformer (PT):\n\n1) Matikan sumber sebelum kerja pada PT\n2) Semak rating PT sesuai dengan sistem\n3) Lakukan ujian ratio sebelum sambung\n4) Semak polarity connection\n5) Pastikan secondary tidak short circuit\n6) Semak insulation resistance\n7) Pastikan PT tidak overload\n8) Semak fius secondary PT\n9) Rekod semua ujian dan bacaan\n10) Pastikan PT dipasang dengan betul dan selamat',
            'phasing stick': '📋 SOP Phasing Stick:\n\n1) Semak phasing stick dalam keadaan baik sebelum guna\n2) Pastikan rating phasing stick sesuai dengan voltan\n3) Gunakan PPE lengkap (gloves, safety glasses)\n4) Pastikan phasing stick kering dan bersih\n5) Lakukan ujian visual sebelum guna\n6) Jangan guna phasing stick yang rosak\n7) Simpan phasing stick di tempat kering\n8) Lakukan ujian berkala pada phasing stick\n9) Rekod semua penggunaan\n10) Ikut prosedur keselamatan yang ditetapkan',
            'ujian megger': '📋 SOP Ujian Megger (Insulation Resistance Test):\n\n1) Matikan sumber dan disconnect semua sambungan\n2) Pilih voltan ujian sesuai (500V untuk LV, 1000V untuk HV)\n3) Semak megger dalam keadaan baik\n4) Sambungkan megger dengan betul (L ke conductor, E ke earth)\n5) Tekan butang test dan baca nilai\n6) Nilai minimum: 1 MΩ untuk LV, 100 MΩ untuk HV\n7) Rekod semua bacaan\n8) Discharge sebelum disconnect\n9) Jangan ujian pada peralatan yang masih hidup\n10) Gunakan megger yang dikalibrasi',
            'ujian continuity': '📋 SOP Ujian Continuity:\n\n1) Matikan sumber sebelum ujian\n2) Gunakan multimeter pada mode continuity\n3) Sambungkan probe ke dua titik yang hendak diuji\n4) Bunyi "beep" menunjukkan continuity baik\n5) Nilai rintangan rendah (<1Ω) menunjukkan sambungan baik\n6) Rekod semua bacaan\n7) Semak semua sambungan terminal\n8) Pastikan tiada loose connection\n9) Ujian pada semua fasa\n10) Rekod semua hasil ujian',
            'ujian voltan': '📋 SOP Ujian Voltan:\n\n1) Gunakan voltmeter yang sesuai dengan rating\n2) Semak voltmeter dalam keadaan baik\n3) Pilih range yang betul\n4) Sambungkan probe dengan betul\n5) Baca nilai voltan dengan teliti\n6) Semak voltan semua fasa (R, S, T)\n7) Semak voltan line-to-line dan line-to-neutral\n8) Rekod semua bacaan\n9) Bandingkan dengan nilai nominal\n10) Gunakan PPE lengkap semasa ujian',
            'ujian pcd': '📋 SOP Ujian PCD (Phase Continuity Detection):\n\n1) Matikan kedua-dua sumber sebelum ujian\n2) Gunakan PCD tester yang dikalibrasi\n3) Sambungkan tester ke kedua-dua sumber\n4) Semak continuity setiap fasa (R-R, S-S, T-T)\n5) Pastikan fasa sepadan sebelum sambung\n6) Jangan sambung jika fasa tidak sepadan\n7) Rekod semua hasil ujian\n8) Pasang NOP selepas pengesahan\n9) Gunakan PPE lengkap\n10) Ikut prosedur keselamatan',
            'ujian ratio': '📋 SOP Ujian Ratio Transformer:\n\n1) Matikan sumber sebelum ujian\n2) Gunakan ratio tester yang dikalibrasi\n3) Sambungkan tester ke primary dan secondary\n4) Apply voltan rendah ke primary\n5) Baca voltan secondary\n6) Kira ratio = Vprimary / Vsecondary\n7) Bandingkan dengan ratio nominal\n8) Toleransi biasanya ±0.5%\n9) Rekod semua bacaan\n10) Semak polarity connection',
            'ssu': '📋 SOP Stesen Suis Utama (SSU):\n\n1) Pastikan kerja dilakukan oleh orang kompeten (Chargeman B1 atau Jurutera Perkhidmatan Elektrik untuk 11kV)\n2) Dapatkan arahan daripada Pusat Kawalan sebelum melakukan penyuisan\n3) Gunakan PPE lengkap (Sut Arka, Tikar Getah, Sarung Tangan Penebat)\n4) Lakukan prosedur LOTO (Lock-Out Tag-Out) sebelum kerja\n5) Rack out VCB untuk pengasingan\n6) Lakukan ujian mati (Proving Dead) menggunakan alat penguji voltan yang sah\n7) Pasang Earth Switch sebelum kerja dimulakan\n8) Semak sistem DC (bateri dan charger) berfungsi dengan baik\n9) Semak tolok tekanan SF6 (jika menggunakan RMU SF6)\n10) Rekod semua operasi dalam log sistem\n11) Pastikan kawasan kerja selamat dan jelas\n12) Jangan kerja sendirian - pastikan ada backup\n13) Semak interlock mechanism berfungsi dengan betul\n14) Lakukan ujian megger sebelum sambung semula\n15) Pastikan semua prosedur keselamatan dipatuhi',
            'psu': '📋 SOP Papan Suis Utama (PSU/MSB):\n\n1) Pastikan kerja dilakukan oleh orang kompeten (Chargeman A1 atau ke atas untuk >100A)\n2) Matikan semua MCB sebelum buka panel\n3) Rack out ACB untuk pengasingan (jika draw-out type)\n4) Lakukan prosedur LOTO (Lock-Out Tag-Out)\n5) Lakukan ujian mati (Proving Dead) menggunakan alat penguji voltan yang sah\n6) Pasang earth sebelum kerja dimulakan\n7) Gunakan PPE lengkap (Sut Arka, Tikar Getah Kelas 0, Sarung Tangan Penebat)\n8) Semak voltan input sebelum operasi\n9) Pastikan semua sambungan terminal ketat\n10) Semak rating ACB/MCCB sesuai dengan beban\n11) Lakukan ujian insulation resistance\n12) Pastikan earthing system berfungsi\n13) Semak busbar connection dan sokongan\n14) Monitor beban setiap fasa\n15) Pastikan kawasan panel kering dan bersih\n16) Semak PFR (Power Factor Regulator) berfungsi dengan baik\n17) Semak meter TNB tidak rosak atau meterai tidak pecah\n18) Rekod semua operasi dan maintenance\n19) Pastikan Form of Separation sesuai dengan keperluan\n20) Semak kapasitor bank dan Detuned Reactor (jika ada)',
            'acb': '📋 SOP Air Circuit Breaker (ACB):\n\n1) Semak status ACB sebelum operasi (ON/OFF/TEST)\n2) Pastikan spring charging mechanism berfungsi\n3) Semak mekanisme draw-out (jika ada)\n4) Boleh buka/tutup di bawah beban (rated current)\n5) Monitor trip status dan relay protection\n6) Lakukan ujian fungsi mekanikal (ON/OFF tanpa beban) - Tahunan\n7) Semak Arc Chutes tidak rosak atau tersumbat\n8) Lakukan ujian rintangan sesentuh (Ductor Test) - 2 tahun\n9) Semak auxiliary contact status\n10) Pastikan control voltage mencukupi\n11) Rekod semua operasi dan trip events\n12) Lakukan maintenance berkala mengikut jadual\n13) Semak relay protection setting\n14) Pastikan interlock mechanism berfungsi\n15) Gunakan PPE lengkap semasa operasi',
            'pemeteran': '📋 SOP Sistem Pemeteran:\n\n1) Pastikan meter TNB tidak rosak atau meterai tidak pecah\n2) Jangan buka meterai TNB tanpa kebenaran\n3) Ambil bacaan meter MD - Bulanan\n4) Semak tetingkap kaca meter jelas dan boleh dibaca\n5) Semak CT dan VT (jika ada) berfungsi dengan baik\n6) Semak fius pengasing meter tidak melebur\n7) Semak sambungan meter dan CT/VT\n8) Jangan sentuh atau ubah sambungan meter TNB\n9) Rekod semua bacaan meter\n10) Laporkan sebarang kerosakan meter kepada TNB\n11) Semak meter bi-arah (jika ada solar) berfungsi dengan betul\n12) Semak Lockable Isolator solar boleh diakses TNB 24 jam\n13) Pastikan kiosk pemeteran (jika ada) terkunci dan selamat\n14) Jangan letak barang di hadapan panel meter\n15) Ikut prosedur TNB untuk sebarang kerja pada meter',
            'faktor kuasa': '📋 SOP Faktor Kuasa dan PFC:\n\n1) Bacaan PFR - Bulanan\n2) Semak PFR berfungsi dengan baik\n3) Semak tetapan C/K adalah betul\n4) Semak kapasitor bank tidak kembung atau rosak\n5) Semak Detuned Reactor (jika ada) berfungsi dengan baik\n6) Monitor faktor kuasa secara berkala\n7) Pastikan faktor kuasa tidak jatuh di bawah 0.85 (atau 0.90 untuk HT)\n8) Semak contactor kapasitor berfungsi dengan baik\n9) Lakukan ujian kapasitor - Tahunan\n10) Pemeriksaan kapasitor bank - 6 bulan\n11) Pemeriksaan Detuned Reactor - Tahunan\n12) Rekod semua bacaan dan operasi\n13) Laporkan sebarang masalah kepada pihak yang bertanggungjawab\n14) Pastikan panel PFC kering dan bersih\n15) Semak sambungan kapasitor dan reaktor ketat',
            'pencawang elektrik': '📋 SOP Pencawang Elektrik (PE):\n\n1) Pastikan kerja dilakukan oleh orang kompeten (Chargeman B1 atau Jurutera Perkhidmatan Elektrik untuk 11kV)\n2) Dapatkan arahan daripada Pusat Kawalan sebelum melakukan penyuisan\n3) Gunakan PPE lengkap (Sut Arka, Tikar Getah, Sarung Tangan Penebat)\n4) Lakukan prosedur LOTO (Lock-Out Tag-Out) sebelum kerja\n5) Matikan bekalan di RMU (posisi OFF) sebelum kerja pada transformer atau kabel\n6) Bumikan litar di RMU (posisi EARTH) untuk membuang cas elektrik sisa\n7) Kunci suis dengan padlock dan letakkan tag amaran "JANGAN HIDUPKAN"\n8) Lakukan ujian mati (Proving Dead) menggunakan alat penguji voltan yang sah\n9) Semak status transformer (suhu, beban, oil level jika oil-filled)\n10) Semak LV Board (voltan, beban, MCB status)\n11) Semak sistem pembumian berfungsi dengan baik\n12) Pastikan kawasan kerja selamat dan jelas\n13) Jangan kerja sendirian - pastikan ada backup\n14) Semak interlock mechanism RMU berfungsi dengan betul\n15) Rekod semua operasi dalam log sistem\n16) Pastikan pagar/tembok transformer tidak rosak (untuk outdoor)\n17) Semak Buchholz Relay status (untuk oil-filled transformer)\n18) Semak Pressure Relief Valve berfungsi (untuk oil-filled transformer)\n19) Pastikan semua prosedur keselamatan dipatuhi\n20) Lakukan ujian megger sebelum sambung semula',
            '7 langkah keselamatan': '📋 SOP 7 LANGKAH KESELAMATAN - Prosedur Kerja Selamat:\n\nDi bawah Peraturan-Peraturan Elektrik 1994 dan amalan utiliti, setiap kerja penyenggaraan mesti mematuhi 7 Langkah Keselamatan yang ketat untuk mengelakkan kemalangan maut (renjatan elektik).\n\nProsedur ini dikenali sebagai "Matikan, Asingkan, Buktikan Mati, Bumikan". Berikut adalah perinciannya:\n\nLANGKAH 1: MATIKAN (Switch Off)\nMemutuskan bekalan arus dengan membuka Pemutus Litar (VCB/RMU) dari kedudukan "ON" ke "OFF".\n\nIni hanya mematikan arus beban, tetapi peralatan masih disambung secara fizikal kepada punca hidup.\n\nLANGKAH 2: ASINGKAN (Isolate)\nMemisahkan peralatan sepenuhnya dari punca bekalan.\n\nBagi VCB jenis draw-out, pemutus litar ditarik keluar (rack-out) dari busbar.\n\nBagi RMU/Isolator, suis diputar ke posisi "OFF" dan pengasing dibuka supaya wujud penjarakan fizikal yang jelas.\n\nLANGKAH 3: KUNCI (Lock)\nKunci Tidak Piawai (Non-Standard Lock / Safety Padlock): Ini adalah kunci peribadi milik orang kompeten atau pekerja yang melakukan kerja. Ia dikunci pada shutter atau pemegang suis yang telah diasingkan.\n\nTujuan: Memastikan tiada sesiapa (termasuk penyelia) boleh menghidupkan semula suis tersebut selagi pekerja masih bekerja di talian. Hanya pekerja itu sahaja yang memegang kuncinya.\n\nLANGKAH 4: NOTIS (Notice)\nMenggantung notis amaran pada suis yang telah dikunci.\n\nJenis Notis: "BAHAYA - JANGAN DIHIDUPKAN" (Danger - Do Not Operate) atau "MENOLONG JANGAN GANGGU" (Caution - Persons Working).\n\nNotis ini memberi amaran visual kepada orang lain bahawa kerja sedang dijalankan.\n\nLANGKAH 5: BUKTIKAN MATI (Prove Dead)\nSebelum menyentuh sebarang konduktor, uji dahulu menggunakan Alat Penguji Voltan (Voltage Detector) yang telah disahkan (calibrated).\n\nProsedur: Uji alat pada punca hidup (untuk pastikan alat elok) -> Uji pada peralatan yang hendak disentuh (mesti bacaan 0V) -> Uji semula alat pada punca hidup.\n\nLANGKAH 6: BUMIKAN (Earth)\nMenutup Suis Bumi (Earth Switch) atau memasang Portable Earth pada litar yang telah dimatikan.\n\nFungsi: Jika litar terhidup secara tidak sengaja, arus akan terus mengalir ke bumi dan menyebabkan pemutus litar di punca utama jatuh serta-merta, melindungi pekerja dari renjatan. Ia juga membuang cas kapasitif sisa dalam kabel.\n\nSuis Bumi perlu dikunci menggunakan Kunci Piawai (Station Lock).\n\nLANGKAH 7: HADANG (Barricade) & PERMIT\nHadangan: Memasang pita amaran (merah/putih) dan penghadang fizikal di sekeliling kawasan kerja yang selamat. Zon di luar hadangan dianggap "HIDUP" dan bahaya.\n\nPermit Menjalankan Kerja (PTW): Dokumen rasmi (seperti Sijil Kebenaran Menjalankan Kerja - SKMK) yang dikeluarkan oleh Orang Kompeten (Penjaga Jentera/Jurutera) kepada penerima kerja, mengesahkan bahawa sistem telah selamat untuk disentuh.\n\nNOTA PENTING:\n• Semua 7 langkah mesti dilakukan mengikut urutan\n• Jangan langkau mana-mana langkah\n• Jika ragu-ragu, jangan teruskan - rujuk penyelia\n• Rekod semua langkah dalam log kerja',
            'prosedur kerja selamat': '📋 SOP Prosedur Kerja Selamat:\n\nIkut 7 Langkah Keselamatan yang mandatori. Rujuk entri "7 langkah keselamatan" untuk perincian lengkap.\n\nRINGKASAN:\n1) Matikan (Switch Off)\n2) Asingkan (Isolate)\n3) Kunci (Lock)\n4) Notis (Notice)\n5) Buktikan Mati (Prove Dead)\n6) Bumikan (Earth)\n7) Hadang (Barricade) & Permit',
            'loto': '📋 SOP LOTO (Lock-Out Tag-Out):\n\nLOTO adalah sistem kunci dan notis untuk memastikan peralatan tidak dihidupkan semula semasa kerja penyelenggaraan.\n\nJENIS KUNCI:\n\n1. Kunci Piawai (Standard Lock):\nKunci milik stesen/utiliti. Digunakan untuk mengunci pintu stesen, pagar, dan suis dalam keadaan operasi normal atau posisi BUMI.\n\n2. Kunci Tidak Piawai (Non-Standard Lock):\nKunci keselamatan peribadi (biasanya berwarna merah/kuning). Wajib digunakan oleh pekerja semasa membuat kerja pengasingan. Jika ada 3 kumpulan pekerja, mesti ada 3 kunci tidak piawai pada titik pengasingan (multi-lock hasp).\n\nPROSEDUR LOTO:\n\n1) Matikan peralatan\n2) Asingkan peralatan dari punca\n3) Kunci dengan Kunci Tidak Piawai (setiap pekerja mesti kunci sendiri)\n4) Pasang tag amaran "BAHAYA - JANGAN DIHIDUPKAN"\n5) Rekod dalam log LOTO\n6) Hanya pekerja yang mengunci boleh buka kunci\n7) Semak semua kunci dibuka sebelum hidupkan semula\n\nPENTING:\n• Setiap pekerja mesti kunci sendiri\n• Jangan buka kunci orang lain\n• Semak semua kunci sebelum hidupkan semula\n• Rekod semua operasi LOTO'
        },
        'teknikal': {
            'rmu': '⚙️ RMU (Ring Main Unit):\n\nRMU adalah peralatan switchgear untuk sistem pengagihan kuasa. Ia mengandungi:\n• Isolator - untuk mengasingkan peralatan\n• Circuit Breaker - untuk membuka/tutup litar di bawah beban\n• Earth Switch - untuk membumikan peralatan\n• Busbar - untuk sambungan antara komponen\n\nRMU digunakan untuk mengawal aliran kuasa dalam rangkaian pengagihan dan memastikan keselamatan sistem. Rating biasa: 11kV, 22kV, 33kV.',
            'nop': '⚙️ NOP (Neutral Open Point):\n\nNOP adalah titik neutral yang dibuka untuk mengelakkan pertembungan fasa antara dua sumber. NOP mesti dipasang dengan betul untuk:\n• Mengelakkan pertembungan fasa\n• Memastikan keselamatan sistem\n• Membenarkan switching antara sumber\n\nNOP biasanya dipasang dengan fius untuk perlindungan. Rating fius NOP biasanya 10A-20A.',
            'fius': '⚙️ Fius:\n\nFius adalah peranti perlindungan yang akan melebur apabila arus melebihi rating. Fius:\n• Melindungi peralatan dan kabel daripada kerosakan\n• Mempunyai rating tertentu (Amp)\n• Mesti dipasang dengan betul\n• Tidak boleh digunakan semula selepas melebur\n\nJenis fius: HRC (High Rupturing Capacity), Cartridge, Drop-out.',
            'isolator': '⚙️ Isolator:\n\nIsolator adalah switch yang digunakan untuk mengasingkan peralatan daripada sumber kuasa. Ciri-ciri:\n• Tidak boleh dibuka/tutup di bawah beban\n• Digunakan untuk maintenance\n• Mesti ditutup sebelum kerja dimulakan\n• Memberikan pengasingan fizikal\n\nJenis: Off-load isolator, On-load isolator (dengan arcing horn).',
            'circuit breaker': '⚙️ Circuit Breaker (CB):\n\nCircuit Breaker adalah peranti yang boleh:\n• Membuka/tutup litar di bawah beban\n• Melindungi daripada arus berlebihan\n• Melindungi daripada short circuit\n• Boleh direset selepas trip\n• Mempunyai relay protection\n\nJenis: Air Circuit Breaker (ACB), Vacuum Circuit Breaker (VCB), SF6 Circuit Breaker.',
            'earth': '⚙️ Earth Switch:\n\nEarth switch digunakan untuk:\n• Membumikan peralatan untuk keselamatan\n• Digunakan semasa kerja penyelenggaraan\n• Mesti ditutup sebelum kerja dimulakan\n• Memberikan perlindungan kepada pekerja\n• Mencegah kejutan elektrik\n\nEarth switch mesti dipasang sebelum kerja dimulakan dan dibuka selepas kerja selesai.',
            'transformer': '⚙️ Transformer:\n\nTransformer digunakan untuk menukar voltan dalam sistem pengagihan:\n• Step-down transformer menurunkan voltan (contoh: 11kV ke 415V)\n• Mempunyai rating tertentu (kVA)\n• Mempunyai cooling system (ONAN, ONAF, OFAF)\n• Mesti dipantau suhu dan beban\n• Perlu maintenance berkala\n\nJenis: Oil-filled, Dry-type, Cast resin. Rating biasa: 100kVA, 200kVA, 500kVA, 1000kVA.',
            'vcb': '⚙️ VCB (Vacuum Circuit Breaker) - Nota Teknikal Lengkap:\n\n1. PENGENALAN:\nVCB adalah sejenis pemutus litar yang menggunakan ruang vakum sebagai medium untuk memadamkan arka (arc quenching medium).\n\n• Kegunaan Utama: Sistem voltan sederhana (Medium Voltage - MV) dari 3.3 kV hingga 33 kV\n• Kenapa Vakum: Vakum mempunyai kekuatan dielektrik (dielectric strength) yang jauh lebih tinggi berbanding udara atau minyak. Arka elektrik dapat dipadamkan dengan sangat pantas dalam jarak sentuhan yang kecil\n\n2. BINAAN UTAMA (Construction):\nBahagian paling kritikal ialah Vacuum Interrupter (Botol Vakum) yang mengandungi:\n\n• Fixed Contact (Sesentuh Tetap): Sesentuh yang tidak bergerak\n• Moving Contact (Sesentuh Bergerak): Disambungkan kepada mekanisme operasi untuk membuka/menutup litar\n• Arc Shield (Perisai Arka): Menghalang wap logam (metal vapour) daripada terenap pada dinding penebat botol seramik\n• Metallic Bellows (Belos Logam): Diperbuat daripada keluli tahan karat (stainless steel). Membolehkan Moving Contact bergerak tanpa merosakkan kedap vakum\n• Ceramic Envelope: Badan luar botol yang bertindak sebagai penebat\n\nNota Penting: Tekanan vakum di dalam interrupter biasanya dikekalkan pada tahap 10⁻⁵ hingga 10⁻⁷ Torr.\n\n3. PRINSIP KERJA:\n\nLangkah 1 - Keadaan Normal (Closed):\nSesentuh tetap dan bergerak bersambung rapat. Arus mengalir seperti biasa. Tiada masalah pemanasan kerana rintangan sentuhan yang sangat rendah.\n\nLangkah 2 - Berlaku Kerosakan (Fault Occurs):\nApabila relay mengesan kerosakan, gegelung trip akan diaktifkan dan mekanisme operasi menarik Moving Contact menjauhi Fixed Contact.\n\nLangkah 3 - Pembentukan Arka:\nApabila sesentuh mula terpisah, arka elektrik akan terhasil. Di dalam vakum, arka ini terhasil daripada wap logam (metal vapour) yang cair dari permukaan sesentuh akibat kepanasan tinggi. Elektron dan ion logam ini membolehkan arus terus mengalir buat seketika walaupun sesentuh telah terpisah.\n\nLangkah 4 - Pemadaman Arka:\nArus elektrik (AC) mempunyai sifat semula jadi akan melalui titik sifar (current zero) dalam setiap kitaran. Apabila arus menghampiri sifar, penghasilan wap logam berkurang secara mendadak. Oleh kerana ini adalah vakum, wap logam tersebut mengembang dan memeluwap (condense) dengan sangat pantas ke permukaan Arc Shield. Kekuatan dielektrik di celah sesentuh pulih serta-merta, menghalang arka daripada menyala semula (restrike). Litar berjaya diputuskan.\n\n4. JENIS UJIAN PADA VCB:\n\nA. Ujian Rintangan Penebatan (Insulation Resistance - IR Test):\n• Tujuan: Memastikan penebat antara fasa dan ke bumi berada dalam keadaan baik\n• Alat: Megger (Insulation Resistance Tester) - biasanya menggunakan suntikan 5kV DC\n• Cara Menguji:\n  - Fasa ke Bumi (R-E, Y-E, B-E) – Breaker dalam keadaan Closed\n  - Fasa ke Fasa (R-Y, Y-B, B-R) – Breaker dalam keadaan Closed\n  - Across Open Contacts (R-R\', Y-Y\', B-B\') – Breaker dalam keadaan Open\n• Kriteria Lulus: Bacaan mestilah tinggi (biasanya dalam GigaOhm, GΩ)\n\nB. Ujian Rintangan Sesentuh (Contact Resistance / Ductor Test):\n• Tujuan: Memastikan sambungan antara sesentuh tetap dan bergerak adalah rapat dan kemas\n• Alat: Micro-Ohm Meter (Ductor Tester)\n• Cara Menguji: Suntik arus DC (biasanya 100A) melalui fasa VCB semasa ia dalam keadaan Closed\n• Kriteria Lulus: Bacaan mestilah sangat rendah, biasanya di bawah 50 μΩ (mikro-ohm) atau mengikut spesifikasi pengilang\n\nC. Ujian Pemasa (Timing Test):\n• Tujuan: Mengukur kelajuan operasi VCB\n• Alat: Circuit Breaker Analyzer\n• Parameter yang diukur:\n  - Closing Time: Masa dari arahan Close diberi sehingga sesentuh bersentuh\n  - Opening Time: Masa dari arahan Trip diberi sehingga sesentuh terpisah\n  - Pole Discrepancy: Perbezaan masa operasi antara ketiga-tiga fasa (R, Y, B). Tidak boleh terlalu besar perbezaannya\n• Kepentingan: Jika VCB terlalu lambat, ia gagal memutuskan litar kerosakan pada masa yang ditetapkan\n\nD. Ujian Integriti Vakum (Vacuum Bottle Integrity / Hi-Pot Test):\n• Tujuan: Ujian paling kritikal untuk VCB. Menguji sama ada botol vakum telah bocor atau tidak. Jika vakum bocor, udara masuk dan VCB akan meletup jika beroperasi\n• Alat: AC High Potential Tester (Hi-Pot Set)\n• Cara Menguji: VCB dalam keadaan OPEN. Voltan tinggi (contohnya 20kV - 30kV AC bergantung pada rating VCB) disuntik merentasi sesentuh yang terbuka selama 1 minit\n• Kriteria Lulus: Arus bocor (leakage current) mestilah sangat rendah dan tiada flashover berlaku merentasi celahan vakum tersebut\n\n5. KELEBIHAN & KEKURANGAN:\n\nKelebihan:\n• Jangka Hayat Panjang: Tahan lasak untuk operasi berulang kali\n• Bebas Penyelenggaraan: Botol vakum adalah unit tertutup (sealed unit), tidak perlu tukar minyak/gas\n• Selamat: Tiada risiko kebakaran atau letupan gas\n• Operasi Senyap: Tidak mengeluarkan bunyi letupan kuat semasa tripping\n\nKekurangan:\n• Kos Tinggi: Teknologi botol vakum agak mahal berbanding jenis udara/minyak lama\n• Sukar Dibaiki: Jika botol vakum rosak/bocor, ia tidak boleh dibaiki di tapak, mesti tukar satu botol baru\n• Fenomena Current Chopping: Kadang-kadang memotong arus terlalu cepat sebelum zero crossing (perlu surge arrester)\n\n6. KESIMPULAN:\nVCB adalah pilihan utama untuk sistem voltan sederhana moden kerana kebolehpercayaannya yang tinggi dan penyelenggaraan yang minimum. Kunci utama keberkesanannya ialah keadaan vakum di dalam interrupter yang mesti sentiasa dipantau melalui Ujian Integriti Vakum.',
            'kabel': '⚙️ Kabel:\n\nKabel digunakan untuk menghantar kuasa elektrik. Jenis kabel:\n• HV Cable (11kV, 22kV, 33kV) - dengan shield dan insulation tebal\n• LV Cable (415V, 240V) - untuk pengagihan akhir\n• Control Cable - untuk kawalan dan signal\n\nKomponen kabel:\n• Conductor (copper/aluminum)\n• Insulation (XLPE, PVC)\n• Shield (untuk HV cable)\n• Sheath (protection)\n\nRating kabel bergantung pada: saiz conductor, jenis insulation, suhu ambien, cara pemasangan.',
            'lv board': '⚙️ LV Board (Low Voltage Board):\n\nLV Board adalah panel pengagihan untuk voltan rendah (415V, 240V). Komponen:\n• Main Incoming Breaker (ACB/MCCB)\n• MCB (Miniature Circuit Breaker) untuk setiap litar\n• Busbar untuk sambungan\n• Earth bar untuk earthing\n• Meter untuk monitoring\n• Indicator lamp\n\nFungsi:\n• Mengagihkan kuasa kepada beban\n• Melindungi litar daripada overload\n• Memudahkan kawalan dan maintenance\n• Monitoring beban dan voltan',
            'potential transformer': '⚙️ Potential Transformer (PT):\n\nPT adalah transformer instrumentasi untuk menurunkan voltan untuk metering dan protection. Ciri-ciri:\n• Ratio biasa: 11kV/110V, 22kV/110V, 33kV/110V\n• Secondary voltan standard: 110V\n• Rating: 50VA, 100VA, 200VA\n• Accuracy class: 0.5, 1.0, 3.0\n\nKegunaan:\n• Metering (voltmeter, wattmeter)\n• Protection relay\n• Synchronizing\n• Voltage monitoring\n\nPenting: Secondary tidak boleh short circuit, mesti ada fius protection.',
            'phasing stick': '⚙️ Phasing Stick:\n\nPhasing stick adalah alat untuk menguji fasa dan voltan dalam sistem HV. Fungsi:\n• Menguji voltan pada konduktor\n• Menguji fasa (R, S, T)\n• Menguji continuity\n• Menguji polarity\n\nCiri-ciri:\n• Rating voltan: 11kV, 22kV, 33kV\n• Mempunyai indicator (lampu/buzzer)\n• Mesti dikalibrasi berkala\n• Mesti disimpan di tempat kering\n\nKegunaan: Sebelum sambung sumber, untuk pengesahan fasa, untuk ujian keselamatan.',
            'ujian megger': '⚙️ Ujian Megger (Insulation Resistance Test):\n\nMegger digunakan untuk menguji rintangan penebat. Prosedur:\n• Pilih voltan ujian: 500V (LV), 1000V (HV)\n• Sambungkan: L ke conductor, E ke earth\n• Tekan test dan baca nilai\n\nNilai minimum:\n• LV: 1 MΩ\n• HV: 100 MΩ\n• Transformer: 1000 MΩ\n\nFaktor yang mempengaruhi: Suhu, kelembapan, umur peralatan, pencemaran.',
            'ujian continuity': '⚙️ Ujian Continuity:\n\nUjian continuity untuk menguji sambungan. Prosedur:\n• Gunakan multimeter pada mode continuity\n• Sambungkan ke dua titik\n• Bunyi "beep" = continuity baik\n• Nilai rintangan <1Ω = sambungan baik\n\nKegunaan:\n• Semak sambungan terminal\n• Semak continuity kabel\n• Semak earthing connection\n• Semak busbar connection',
            'ujian voltan': '⚙️ Ujian Voltan:\n\nUjian voltan untuk mengukur voltan dalam sistem. Prosedur:\n• Gunakan voltmeter yang sesuai\n• Pilih range yang betul\n• Sambungkan probe dengan betul\n• Baca nilai voltan\n\nJenis ujian:\n• Line-to-line voltage (415V untuk 3-fasa)\n• Line-to-neutral voltage (240V)\n• Phase voltage\n\nKegunaan: Monitoring, troubleshooting, commissioning, maintenance.',
            'ujian pcd': '⚙️ Ujian PCD (Phase Continuity Detection):\n\nPCD untuk mengesahkan fasa sebelum sambung dua sumber. Prosedur:\n• Matikan kedua-dua sumber\n• Sambungkan PCD tester\n• Semak continuity setiap fasa\n• Pastikan fasa sepadan (R-R, S-S, T-T)\n\nKepentingan:\n• Mengelakkan pertembungan fasa\n• Memastikan fasa sepadan\n• Keselamatan sistem\n• Mencegah kerosakan peralatan',
            'ujian ratio': '⚙️ Ujian Ratio Transformer:\n\nUjian ratio untuk mengesahkan ratio transformer. Prosedur:\n• Apply voltan rendah ke primary\n• Baca voltan secondary\n• Kira ratio = Vprimary / Vsecondary\n• Bandingkan dengan ratio nominal\n\nToleransi: ±0.5% dari ratio nominal\n\nKegunaan:\n• Commissioning transformer\n• Maintenance berkala\n• Troubleshooting\n• Quality control',
            'ssu': '⚙️ STESEN SUIS (SS) / STESEN SUIS UTAMA (SSU) - Laporan Teknikal Komprehensif:\n\n1.0 DEFINISI STESEN SUIS:\n\nStesen Suis (SS) atau Switching Station adalah satu instalasi elektrik voltan tinggi (biasanya 11kV atau 33kV) yang berfungsi sebagai nod pengagihan dan pensuisan kuasa tanpa melibatkan penurunan voltan kepada pengguna voltan rendah (415V).\n\nBerbeza dengan Pencawang Elektrik (PE) yang mempunyai transformer 11kV/415V untuk membekalkan elektrik ke rumah, Stesen Suis lazimnya tiada transformer kuasa utama. Fungsi utamanya adalah untuk memecahkan litar utama kepada beberapa laluan, mengasingkan kerosakan rangkaian, dan menstabilkan sistem Grid.\n\nHIERARKI SISTEM:\n• 132kV/275kV: PMU (Pencawang Masuk Utama) - Titik suntikan dari stesen janakuasa\n• 33kV/11kV: PPU (Pencawang Pembahagian Utama) - Mengagihkan kuasa ke kawasan luas\n• 11kV: SSU (Stesen Suis Utama) - Mengawal aliran kuasa, membolehkan pengasingan zon kerosakan\n• 415V: PSU (Papan Suis Utama) - Penggunaan akhir\n\n2.0 PERALATAN UTAMA DI STESEN SUIS:\n\nPeralatan di dalam Stesen Suis adalah "Heavy Duty" kerana ia perlu menampung arus beban yang besar dan arus kerosakan (fault current) yang tinggi.\n\n2.1 PERKAKASUIS VOLTAN TINGGI (High Voltage Switchgear):\n\nBiasanya jenis Vacuum Circuit Breaker (VCB) atau Gas Insulated Switchgear (GIS). Ia bertindak sebagai pemutus litar utama untuk kabel masuk dan keluar. VCB mampu memadamkan arka api yang besar di dalam tabung vakum.\n\nA. Teknologi Penebatan:\n• Gas SF6: Kekuatan dielektrik 2-3 kali ganda berbanding udara. Membolehkan reka bentuk kompak dan kalis cuaca. Isu: SF6 adalah gas rumah hijau yang sangat kuat, pengurusan kebocoran gas adalah kritikal dan dipantau melalui tolok tekanan.\n• VCB (Vacuum Circuit Breaker): Arka elektrik dipadamkan di dalam botol vakum. Ketiadaan udara bermakna tiada ion untuk mengalirkan arus, menyebabkan arka padam serta-merta apabila arus melintasi sifar.\n\nB. Ring Main Unit (RMU):\nRMU adalah komponen standard di SSU untuk rangkaian pengagihan bandar. Ia terdiri daripada:\n• Load Break Switch (LBS) untuk kabel masuk/keluar\n• Pemutus litar atau fius untuk perlindungan transformer\n• Ciri saling kunci (interlock) mekanikal yang menghalang suis dibumikan semasa hidup\n\n2.2 SISTEM BATERI DAN PENGCAS (DC System):\n\nMembekalkan kuasa 30V DC atau 110V DC untuk mengendalikan Tripping Coil (gegelung pelantik) dan panel kawalan. Tanpa DC, VCB tidak boleh "trip" secara automatik jika berlaku kerosakan, menyebabkan risiko letupan.\n\nFungsi Kritikal: Semasa gangguan bekalan elektrik (blackout), geganti perlindungan dan gegelung pelantik (trip coils) pada pemutus litar mesti terus beroperasi untuk memutuskan kerosakan. Bekalan AC tidak boleh digunakan untuk tujuan ini.\n\nKomponen:\n• Bank bateri (Nickel-Cadmium atau Lead Acid)\n• Unit pengecas (charger)\n• Voltan lazim: 30V DC atau 110V DC\n\nPenting: Kegagalan sistem DC adalah punca utama kegagalan perlindungan (protection failure), di mana pemutus litar gagal beroperasi walaupun geganti mengesan kerosakan.\n\n2.3 PANEL GEGANTI PERLINDUNGAN (Protection Relay Panel):\n\nOtak kepada sistem. Ia mengesan arus lebih (Overcurrent), kerosakan bumi (Earth Fault), atau kerosakan kabel (Differential Pilot Wire) dan menghantar isyarat kepada VCB untuk memutuskan litar.\n\n2.4 SISTEM PEMBUMIAN (Earthing System):\n\nBar tembaga yang disambungkan ke elektrod bumi untuk mengalirkan arus kerosakan ke tanah dengan selamat.\n\nSistem pembumian di SSU adalah grid bersepadu yang direka untuk mengawal Step Voltage dan Touch Voltage semasa kerosakan litar pintas.\n\n• Rintangan Elektrod: Untuk SSU dan PPU, rintangan bumi mestilah serendah mungkin, lazimnya di bawah 1.0 Ohm. Dicapai menggunakan grid mat tembaga (copper matt) yang ditanam di bawah tapak bangunan.\n• Neutral Earthing Resistor (NER): Di peringkat PPU yang menyuap SSU, NER digunakan pada titik bintang transformer untuk mengehadkan arus kerosakan bumi (biasanya kepada 1000A atau kurang).\n\n2.5 PEMADAM API AUTOMATIK (CO2 System):\n\nSistem pencegah kebakaran yang akan membanjiri bilik suis dengan gas CO2 jika pengesan asap diaktifkan.\n\n3.0 KONSEP LILO (LOOP-IN LOOP-OUT):\n\n3.1 BAGAIMANA LILO BERFUNGSI:\n\nSistem Loop-In Loop-Out (LILO) adalah kaedah penyambungan kabel yang paling kritikal dalam rangkaian Stesen Suis untuk membentuk sistem Gegelang (Ring).\n\nBayangkan sebatang kabel utama yang panjang dari Punca A ke Punca B.\n\nPotong: Kabel tersebut "dipotong" di lokasi Stesen Suis baru.\n\nMasuk (Loop-In): Hujung kabel dari Punca A dibawa MASUK ke dalam Stesen Suis (disambung ke Panel VCB 1).\n\nKeluar (Loop-Out): Hujung kabel yang menyambung ke Punca B dibawa KELUAR dari Stesen Suis (disambung ke Panel VCB 2).\n\n3.2 KELEBIHAN LILO:\n\nKesinambungan Bekalan: Jika Stesen Suis ini rosak, jurutera boleh menutup suis LILO untuk memintas stesen ini, membolehkan arus terus mengalir ke stesen seterusnya.\n\nRedundancy: Membolehkan bekalan diperoleh dari dua arah berbeza.\n\n4.0 PROTOKOL KESELAMATAN:\n\n4.1 KEPERLUAN ORANG KOMPETEN:\n• Peraturan 60, PPE 1994: Mana-mana kerja pada papan suis voltan rendah melebihi 100A mestilah dijalankan oleh atau di bawah kawalan serta-merta Penjaga Jentera (Chargeman) A1 atau ke atas.\n• Voltan Tinggi (11kV SSU): Memerlukan Penjaga Jentera B1 atau Jurutera Perkhidmatan Elektrik.\n\n4.2 PROSEDUR KERJA SELAMAT (SOP) dan PTW:\n• Penyuisan (Switching): Hanya boleh dilakukan selepas mendapat arahan daripada Pusat Kawalan\n• Pengasingan (Isolation): Membuka pemutus litar dan menarik keluar (rack out) VCB\n• Penguncian (LOTO): Mengunci shutter dan meletakkan tag amaran\n• Ujian Mati (Proving Dead): Menggunakan alat penguji voltan yang sah\n• Pembumian Litar: Membumikan kabel menggunakan Suis Bumi (Earth Switch) terbina dalam pada panel RMU/VCB\n\n4.3 KELENGKAPAN PERLINDUNGAN DIRI (PPE):\n\nPPE adalah benteng terakhir keselamatan.\n\n• Topi Keselamatan (Safety Helmet): Melindungi kepala dari hentakan dan percikan api.\n• Sut Kalis Arka (Arc Flash Suit): Pakaian khas (biasanya >40 cal/cm²) yang wajib dipakai semasa operasi pensuisan untuk melindungi badan dari haba letupan arka (sehingga 20,000°C).\n• Sarung Tangan Penebat (Insulating Gloves): Kelas voltan yang sesuai (cth: Class 2 untuk 11kV) untuk mencegah renjatan tangan.\n• Tikar Getah (Rubber Mat): Diletakkan di hadapan panel suis sebagai penebat tambahan antara kaki pekerja dan bumi.\n• Pelindung Muka (Face Shield): Melindungi muka dari serpihan leburan logam jika berlaku letupan suis.\n\n5.0 PENYELENGGARAAN:\n\n5.1 JADUAL PENYELENGGARAAN:\n• Bulanan: Pemeriksaan visual, pemeriksaan suhu bilik, pemeriksaan tikar getah\n• 6 Bulan: Pembersihan bilik suis, pemeriksaan bateri DC (aras elektrolit dan voltan)\n• Tahunan: Imbasan Inframerah (Thermography) pada sambungan kabel dan busbar\n• 2 Tahun (Mandatori): Penentukuran Geganti Perlindungan, Ujian suntikan arus primer/sekunder, Ujian rintangan penebatan dan rintangan sentuhan\n\n5.2 PENGURUSAN BATERI DC:\nBateri perlu diuji nyahcas (discharge test) untuk mengetahui kapasiti sebenar. Bateri yang menunjukkan voltan penuh tidak semestinya mempunyai ampere-hour (Ah) yang cukup untuk menggerakkan VCB yang berat semasa kerosakan.\n\n6.0 KESIMPULAN:\nSSU adalah jauh lebih kompleks daripada sekadar suis penyambung litar. Ia adalah hab integrasi teknologi, keselamatan, dan perundangan. Tiada kompromi boleh dibuat terhadap spesifikasi peralatan dan prosedur operasi. Pematuhan kepada Akta Bekalan Elektrik 1990 (Akta 447) bukan pilihan, tetapi kewajipan mandatori.',
            'psu': '⚙️ PAPAN SUIS UTAMA (PSU/MSB) - Laporan Teknikal Komprehensif:\n\n1.0 PENGENALAN:\nPSU (Main Switch Board) adalah jantung kepada sistem elektrik pengguna di premis. Ia menerima bekalan voltan rendah (415V) daripada transformer utiliti atau genset dan mengagihkannya ke beban bangunan. Segala perlindungan arus lebih dan kerosakan bumi di peringkat pengguna bermula di sini.\n\nKedudukan dalam Hierarki:\n• 11kV: SSU mengawal aliran kuasa\n• 415V: PSU menerima 415V, melindungi litar pengguna, mengukur penggunaan tenaga\n\n2.0 BINAAN DAN PENGASINGAN (Form of Separation):\nPSU dibina mengikut piawaian IEC 61439 yang menetapkan tahap pengasingan dalaman:\n\n• Form 1: Tiada pengasingan\n• Form 2: Pengasingan busbar daripada terminal\n• Form 3: Pengasingan setiap litar\n• Form 4: Pengasingan penuh setiap litar dan busbar\n• Form 4b: Lazimnya digunakan untuk PSU bangunan komersial besar. Memisahkan sepenuhnya busbar daripada pemutus litar dan terminal kabel. Ini bermakna kerja penyelenggaraan boleh dilakukan pada satu pemutus litar dengan lebih selamat walaupun busbar utama masih hidup.\n\n3.0 PERALATAN PSU:\n\n3.1 PEMUTUS LITAR UDARA (Air Circuit Breaker - ACB):\nBagi arus masukan melebihi 800A, ACB adalah pilihan mandatori berbanding MCCB.\n\nAnatomi ACB:\n• Mekanisme Penyimpanan Tenaga: Menggunakan spring yang dicas. Spring boleh dicas secara manual (menggunakan tuil) atau automatik (menggunakan motor). Ini membolehkan pensuisan serta-merta apabila butang ON ditekan.\n• Arc Chutes: Kepingan logam berlapis di atas sesentuh yang berfungsi memecah, menyejuk, dan memadamkan arka elektrik yang terhasil semasa pemutusan beban tinggi.\n• Draw-out Mechanism: Kebanyakan ACB di PSU dipasang secara draw-out (boleh ditarik keluar). Ini memudahkan penyelenggaraan dan memberikan pengasingan visual yang jelas untuk keselamatan (LOTO).\n\n3.2 SISTEM BUSBAR (Palang Bas):\nBusbar kuprum (tembaga) berfungsi sebagai arteri utama arus.\n\n• Ketumpatan Arus: Reka bentuk mestilah mengambil kira ketumpatan arus (contohnya 1.5A per mm²) untuk mengelakkan pemanasan lampau.\n• Sokongan Mekanikal: Semasa litar pintas, arus boleh melonjak ke 50kA dalam milisaat. Daya elektromagnet yang terhasil sangat kuat dan boleh membengkokkan busbar jika penebat sokongan (busbar support insulators) tidak mencukupi atau terlalu jauh jaraknya.\n\n4.0 SISTEM PERLINDUNGAN:\n\n4.1 KOORDINASI GEGANTI (Relay Coordination):\nSistem perlindungan mesti bersifat diskriminatif. Jika berlaku kerosakan pada sub-papan (DB) tingkat 1, hanya pemutus litar DB tersebut yang patut jatuh, bukan ACB utama di PSU.\n\n• IDMT (Inverse Definite Minimum Time): Geganti di PSU ditetapkan dengan masa lengah (time delay) yang lebih tinggi berbanding peranti di hilir (downstream), membenarkan peranti hilir bertindak dahulu.\n\n4.2 PERLINDUNGAN KEROSAKAN BUMI (Earth Fault Protection):\nIni adalah perlindungan paling kritikal untuk nyawa manusia.\n\n• EFR (Earth Fault Relay): Disambungkan kepada Pengubah Arus (CT) pada fasa dan neutral (atau CT teras imbang). Sebarang ketidakseimbangan arus menandakan kebocoran ke bumi.\n• Penyelerasan dengan RCCB: Di peringkat sub-litar, RCCB (Residual Current Circuit Breaker) memberikan perlindungan sensitif (30mA atau 100mA). EFR di PSU biasanya ditetapkan pada 10% daripada arus beban (contohnya 100A untuk sistem 1000A) sebagai perlindungan sandaran (backup).\n\n4.3 PERLINDUNGAN ZON DAN UNIT:\nUntuk pemasangan kritikal atau kabel voltan tinggi antara SSU, perlindungan unit seperti Pilot Wire Differential Protection digunakan. Ia membandingkan arus masuk di hujung A dan arus keluar di hujung B. Jika tidak sama, bermakna ada kerosakan di tengah kabel, dan kedua-dua hujung akan diputuskan serta-merta.\n\n5.0 SISTEM PEMETERAN:\n\n5.1 KONFIGURASI PEMETERAN:\nPemilihan jenis pemeteran bergantung pada Beban Permintaan Maksimum (Maximum Demand - MD):\n\n• < 100 A: Direct Meter (415V/240V) - Meter disambung terus ke talian arus\n• > 100 A (sehingga 1000 kVA): LVCT (Low Voltage Current Transformer) - Menggunakan CT untuk menurunkan arus ke 5A untuk bacaan meter\n• > 1000 kVA: MV/HV Metering (11kV/33kV) - Meter dipasang di panel SSU pada bahagian voltan tinggi menggunakan kedua-dua CT dan VT (Voltage Transformer)\n\n5.2 KEPERLUAN FIZIKAL PANEL METER:\nESAH (Electricity Supply Application Handbook) menetapkan piawaian fizikal yang ketat:\n\n• Tetingkap Kaca: Panel meter pada PSU mestilah mempunyai tetingkap kaca lutsinar pada ketinggian yang sesuai (paras mata) supaya bacaan boleh diambil tanpa membuka pintu.\n• Pengasingan: Ruang meter mestilah berasingan sepenuhnya daripada ruang suis lain dan boleh dikunci/dimeterai (seal) oleh TNB.\n• Fius Pengasing: Fius pengasing (cut-out fuse) untuk litar voltan meter juga perlu disediakan dan dimeterai.\n• Kiosk Pemeteran Luar: Bagi premis besar atau LSS (Large Scale Solar), kiosk khas yang tahan cuaca dan mempunyai akses "dua-kunci" diperlukan.\n\n5.3 PEMETERAN TENAGA BOLEH BAHARU (NEM & Solar):\nIntegrasi solar mengubah PSU dari satu hala kepada dua hala.\n\n• Meter Bi-arah (Bi-directional Meter): Merekodkan tenaga Import (dari TNB) dan Eksport (ke TNB).\n• Titik Sambungan (PCC): Sambungan solar mestilah dibuat di PSU (sebelah beban meter TNB). Ini memerlukan pemasangan Lockable Isolator yang boleh diakses oleh TNB 24 jam untuk tujuan keselamatan.\n• Skim SARE: Dalam perjanjian pajakan solar, meter ketiga (Solar Generation Meter) mungkin dipasang untuk mengukur jumlah output panel solar bagi tujuan pengebilan pelabur solar kepada pemilik bangunan.\n\n6.0 PENGURUSAN KUALITI KUASA:\n\n6.1 PEMBETULAN FAKTOR KUASA (PFC):\nTNB mengenakan surcaj jika faktor kuasa purata bulanan jatuh di bawah 0.85 (atau 0.90 untuk voltan tinggi).\n\n• Operasi PFR (Power Factor Regulator): Alat ini memantau sudut fasa antara voltan dan arus. Jika arus tertinggal (lagging) akibat beban induktif, PFR akan mengaktifkan penyentuh (contactors) untuk menyambungkan kapasitor bank.\n• Pengiraan C/K: Kejituan PFR bergantung pada tetapan nisbah C/K.\n  C/K = Q_step1 / (V × √3 × I_CT)\n  Di mana Q_step1 adalah saiz langkah kapasitor pertama (VAR) dan I_CT adalah nisbah transformer arus. Kesilapan menetapkan nilai ini menyebabkan kapasitor "bermain" (hunting) atau gagal masuk.\n\n6.2 ISU HARMONIK DAN KAPASITOR:\nBeban moden (LED, inverter) menghasilkan harmonik yang memesongkan gelombang sinus. Harmonik frekuensi tinggi boleh menyebabkan impedans kapasitor menurun, menarik arus tinggi yang menyebabkan kapasitor meletup atau kembung.\n\n• Penyelesaian: Pemasangan Detuned Reactor bersiri dengan kapasitor di dalam panel PFC di PSU. Reaktor ini menala frekuensi resonans litar ke tahap selamat (contohnya 189Hz), menghalang arus harmonik daripada merosakkan kapasitor.\n\n7.0 PROTOKOL KESELAMATAN:\n\n7.1 KEPERLUAN ORANG KOMPETEN:\n• Peraturan 60, PPE 1994: Mana-mana kerja pada papan suis voltan rendah melebihi 100A mestilah dijalankan oleh atau di bawah kawalan serta-merta Penjaga Jentera (Chargeman) A1 atau ke atas.\n\n7.2 PROSEDUR KERJA SELAMAT:\n• Pengasingan (Isolation): Membuka pemutus litar dan menarik keluar (rack out) ACB\n• Penguncian (LOTO): Mengunci shutter dan meletakkan tag amaran\n• Ujian Mati (Proving Dead): Menggunakan alat penguji voltan yang sah\n• Pembumian Litar: Membumikan kabel untuk membuang cas kapasitif\n\n7.3 KELENGKAPAN PERLINDUNGAN DIRI (PPE):\n• Sut Arka (Arc Flash Suit): Diwajibkan semasa operasi pensuisan\n• Tikar Getah: Setiap hadapan panel PSU mesti dilengkapi tikar getah penebat (Kelas 0 untuk LV)\n• Sarung Tangan Penebat: Kelas voltan yang sesuai mesti digunakan\n\n8.0 PENYELENGGARAAN:\n\n8.1 JADUAL PENYELENGGARAAN:\n• Bulanan: Bacaan meter MD, pemeriksaan visual lampu penunjuk, pemeriksaan suhu bilik dan pengudaraan, pemeriksaan tikar getah, bacaan PFR\n• 6 Bulan: Pembersihan bilik suis, pemeriksaan bateri DC (jika ada)\n• Tahunan: Imbasan Inframerah (Thermography) pada sambungan kabel dan busbar, Ujian fungsi mekanikal ACB (ON/OFF tanpa beban)\n• 2 Tahun (Mandatori): Penentukuran Geganti Perlindungan oleh Perkhidmatan Elektrik berdaftar, Ujian suntikan arus primer/sekunder, Ujian rintangan penebatan dan rintangan sentuhan\n\n8.2 PROSEDUR PENENTUKALAN GEGANTI:\nGeganti perlindungan adalah peranti pasif yang mungkin "tidur" selama bertahun-tahun. Penentukuran memastikan ia akan "bangun" apabila diperlukan.\n\n• Ujian Suntikan Sekunder: Arus simulasi disuntik ke dalam geganti untuk memastikan ia menghantar isyarat "trip" pada masa yang tepat mengikut keluk IDMT.\n• Ujian Shunt Trip: Memastikan isyarat dari geganti benar-benar berjaya menjatuhkan (trip) mekanisma ACB/MCCB. Kegagalan gegelung shunt trip adalah punca biasa pemutus litar gagal beroperasi.\n\n9.0 KESIMPULAN:\nPSU bukan sekadar pengagih, ia juga loji pembetulan kualiti kuasa. Dengan evolusi tarif TNB dan teknologi solar NEM, PSU kini memainkan peranan kewangan yang besar. Reka bentuk panel pemeteran yang tepat dan penyelenggaraan kapasitor bank adalah kritikal untuk mengelakkan kerugian kewangan (penalti) dan memaksimumkan pulangan pelaburan tenaga. Sistem perlindungan (geganti dan pemutus litar) adalah insurans nyawa bangunan. Kegagalan untuk menyelenggara sistem ini adalah umpama membatalkan polisi insurans sebelum bencana berlaku.',
            'acb': '⚙️ Air Circuit Breaker (ACB) - Nota Teknikal:\n\nACB adalah pemutus litar untuk arus masukan melebihi 800A di PSU. Ia adalah pilihan mandatori berbanding MCCB untuk sistem besar.\n\nANATOMI ACB:\n\n1. Mekanisme Penyimpanan Tenaga:\n• Menggunakan spring yang dicas\n• Spring boleh dicas secara manual (menggunakan tuil) atau automatik (menggunakan motor)\n• Membolehkan pensuisan serta-merta apabila butang ON ditekan\n\n2. Arc Chutes:\n• Kepingan logam berlapis di atas sesentuh\n• Berfungsi memecah, menyejuk, dan memadamkan arka elektrik yang terhasil semasa pemutusan beban tinggi\n• Mencegah kerosakan pada sesentuh akibat arka\n\n3. Draw-out Mechanism:\n• Kebanyakan ACB di PSU dipasang secara draw-out (boleh ditarik keluar)\n• Memudahkan penyelenggaraan\n• Memberikan pengasingan visual yang jelas untuk keselamatan (LOTO)\n• Membolehkan kerja penyelenggaraan dilakukan dengan lebih selamat\n\nKELEBIHAN:\n• Boleh memutuskan arus tinggi (sehingga beberapa ribu Ampere)\n• Tahan lasak untuk operasi berulang\n• Mudah diselenggara dengan mekanisme draw-out\n• Mempunyai perlindungan relay yang boleh diselaraskan\n\nPENYELENGGARAAN:\n• Ujian fungsi mekanikal (ON/OFF tanpa beban) - Tahunan\n• Ujian rintangan sesentuh (Ductor Test) - 2 tahun\n• Pemeriksaan Arc Chutes - Tahunan\n• Penentukuran relay perlindungan - 2 tahun',
            'pemeteran': '⚙️ Sistem Pemeteran - Nota Teknikal Lengkap:\n\nPemeteran adalah titik pertemuan antara kejuruteraan dan kewangan. Di Malaysia, spesifikasi pemeteran dikawal ketat oleh TNB melalui Electricity Supply Application Handbook (ESAH).\n\n1. KONFIGURASI PEMETERAN:\n\nA. Direct Meter (< 100 A):\n• Voltan: 415V/240V\n• Meter disambung terus ke talian arus\n• Tiada CT diperlukan\n\nB. LVCT (Low Voltage Current Transformer) - > 100 A sehingga 1000 kVA:\n• Voltan: 415V\n• Menggunakan CT untuk menurunkan arus ke 5A untuk bacaan meter\n• CT ratio biasa: 100/5, 200/5, 300/5, 500/5, 800/5, 1000/5\n\nC. MV/HV Metering (> 1000 kVA):\n• Voltan: 11kV/33kV\n• Meter dipasang di panel SSU pada bahagian voltan tinggi\n• Menggunakan kedua-dua CT (Current Transformer) dan VT (Voltage Transformer)\n• CT ratio: Bergantung pada arus beban\n• VT ratio: 11kV/110V, 22kV/110V, 33kV/110V\n\n2. KEPERLUAN FIZIKAL PANEL METER:\n\n• Tetingkap Kaca: Panel meter pada PSU mestilah mempunyai tetingkap kaca lutsinar pada ketinggian yang sesuai (paras mata) supaya bacaan boleh diambil tanpa membuka pintu.\n• Pengasingan: Ruang meter mestilah berasingan sepenuhnya daripada ruang suis lain dan boleh dikunci/dimeterai (seal) oleh TNB.\n• Fius Pengasing: Fius pengasing (cut-out fuse) untuk litar voltan meter juga perlu disediakan dan dimeterai.\n• Kiosk Pemeteran Luar: Bagi premis besar atau LSS (Large Scale Solar), kiosk khas yang tahan cuaca dan mempunyai akses "dua-kunci" diperlukan.\n\n3. PEMETERAN TENAGA BOLEH BAHARU (NEM & Solar):\n\n• Meter Bi-arah (Bi-directional Meter): Merekodkan tenaga Import (dari TNB) dan Eksport (ke TNB).\n• Titik Sambungan (PCC): Sambungan solar mestilah dibuat di PSU (sebelah beban meter TNB). Ini memerlukan pemasangan Lockable Isolator yang boleh diakses oleh TNB 24 jam untuk tujuan keselamatan (mematikan solar semasa penyelenggaraan grid).\n• Skim SARE: Dalam perjanjian pajakan solar, meter ketiga (Solar Generation Meter) mungkin dipasang untuk mengukur jumlah output panel solar bagi tujuan pengebilan pelabur solar kepada pemilik bangunan.\n\n4. PENYELENGGARAAN:\n• Bacaan meter MD - Bulanan\n• Pemeriksaan meter dan CT - Tahunan\n• Kalibrasi meter - Mengikut jadual TNB\n• Pemeriksaan meterai - Berkala',
            'sistem perlindungan': '⚙️ Sistem Perlindungan - Nota Teknikal Lengkap:\n\nPerlindungan elektrik adalah sains mengimbangi antara keselamatan dan kesinambungan bekalan.\n\n1. KOORDINASI GEGANTI (Relay Coordination):\n\nSistem perlindungan mesti bersifat diskriminatif. Jika berlaku kerosakan pada sub-papan (DB) tingkat 1, hanya pemutus litar DB tersebut yang patut jatuh, bukan ACB utama di PSU.\n\n• IDMT (Inverse Definite Minimum Time): Geganti di PSU ditetapkan dengan masa lengah (time delay) yang lebih tinggi berbanding peranti di hilir (downstream), membenarkan peranti hilir bertindak dahulu.\n• Keluk Masa: Geganti di PSU ditetapkan dengan masa lengah yang lebih tinggi berbanding peranti di hilir.\n\n2. PERLINDUNGAN KEROSAKAN BUMI (Earth Fault Protection):\n\nIni adalah perlindungan paling kritikal untuk nyawa manusia.\n\n• EFR (Earth Fault Relay): Disambungkan kepada Pengubah Arus (CT) pada fasa dan neutral (atau CT teras imbang). Sebarang ketidakseimbangan arus menandakan kebocoran ke bumi.\n• Penyelerasan dengan RCCB: Di peringkat sub-litar, RCCB (Residual Current Circuit Breaker) memberikan perlindungan sensitif (30mA atau 100mA). EFR di PSU biasanya ditetapkan pada 10% daripada arus beban (contohnya 100A untuk sistem 1000A) sebagai perlindungan sandaran (backup).\n\n3. PERLINDUNGAN ZON DAN UNIT (Unit Protection):\n\nUntuk pemasangan kritikal atau kabel voltan tinggi antara SSU, perlindungan unit seperti Pilot Wire Differential Protection digunakan.\n\n• Prinsip: Membandingkan arus masuk di hujung A dan arus keluar di hujung B. Jika tidak sama, bermakna ada kerosakan di tengah kabel, dan kedua-dua hujung akan diputuskan serta-merta.\n• Aplikasi: Kabel panjang antara SSU, transformer kritikal, motor besar.\n\n4. PENENTUKALAN GEGANTI:\n\nGeganti perlindungan adalah peranti pasif yang mungkin "tidur" selama bertahun-tahun. Penentukuran memastikan ia akan "bangun" apabila diperlukan.\n\n• Ujian Suntikan Sekunder: Arus simulasi disuntik ke dalam geganti untuk memastikan ia menghantar isyarat "trip" pada masa yang tepat mengikut keluk IDMT.\n• Ujian Shunt Trip: Memastikan isyarat dari geganti benar-benar berjaya menjatuhkan (trip) mekanisma ACB/MCCB. Kegagalan gegelung shunt trip adalah punca biasa pemutus litar gagal beroperasi.\n• Kekerapan: 2 tahun (mandatori) oleh Perkhidmatan Elektrik berdaftar.',
            'faktor kuasa': '⚙️ Faktor Kuasa dan Pembetulan - Nota Teknikal:\n\nTNB mengenakan surcaj jika faktor kuasa purata bulanan jatuh di bawah 0.85 (atau 0.90 untuk voltan tinggi).\n\n1. OPERASI PFR (Power Factor Regulator):\n\n• Alat ini memantau sudut fasa antara voltan dan arus\n• Jika arus tertinggal (lagging) akibat beban induktif, PFR akan mengaktifkan penyentuh (contactors) untuk menyambungkan kapasitor bank\n• Kapasitor bank akan menghasilkan arus mendahului (leading) untuk mengimbangi arus tertinggal\n\n2. PENGIRAAN C/K:\n\nKejituan PFR bergantung pada tetapan nisbah C/K:\n\nC/K = Q_step1 / (V × √3 × I_CT)\n\nDi mana:\n• Q_step1 = Saiz langkah kapasitor pertama (VAR)\n• V = Voltan sistem (415V)\n• I_CT = Nisbah transformer arus (contoh: 1000/5 = 200)\n\nKesilapan menetapkan nilai ini menyebabkan kapasitor "bermain" (hunting) atau gagal masuk.\n\n3. ISU HARMONIK DAN KAPASITOR:\n\nBeban moden (LED, inverter) menghasilkan harmonik yang memesongkan gelombang sinus. Harmonik frekuensi tinggi boleh menyebabkan impedans kapasitor menurun, menarik arus tinggi yang menyebabkan kapasitor meletup atau kembung.\n\n• Penyelesaian: Pemasangan Detuned Reactor bersiri dengan kapasitor di dalam panel PFC di PSU. Reaktor ini menala frekuensi resonans litar ke tahap selamat (contohnya 189Hz), menghalang arus harmonik daripada merosakkan kapasitor.\n\n4. PENYELENGGARAAN:\n\n• Bacaan PFR - Bulanan\n• Pemeriksaan kapasitor bank - 6 bulan\n• Ujian kapasitor - Tahunan\n• Pemeriksaan Detuned Reactor - Tahunan',
            'lilo': '⚙️ KONSEP LILO (LOOP-IN LOOP-OUT) - Nota Teknikal Lengkap:\n\n1.0 PENGENALAN:\n\nSistem Loop-In Loop-Out (LILO) adalah kaedah penyambungan kabel yang paling kritikal dalam rangkaian Stesen Suis untuk membentuk sistem Gegelang (Ring).\n\n2.0 BAGAIMANA LILO BERFUNGSI:\n\nBayangkan sebatang kabel utama yang panjang dari Punca A ke Punca B.\n\nLangkah 1 - Potong: Kabel tersebut "dipotong" di lokasi Stesen Suis baru.\n\nLangkah 2 - Masuk (Loop-In): Hujung kabel dari Punca A dibawa MASUK ke dalam Stesen Suis (disambung ke Panel VCB 1).\n\nLangkah 3 - Keluar (Loop-Out): Hujung kabel yang menyambung ke Punca B dibawa KELUAR dari Stesen Suis (disambung ke Panel VCB 2).\n\n3.0 KELEBIHAN LILO:\n\n3.1 Kesinambungan Bekalan:\nJika Stesen Suis ini rosak, jurutera boleh menutup suis LILO untuk memintas stesen ini, membolehkan arus terus mengalir ke stesen seterusnya tanpa gangguan bekalan kepada pengguna.\n\n3.2 Redundancy:\nMembolehkan bekalan diperoleh dari dua arah berbeza. Jika satu punca gagal, bekalan boleh diambil dari punca kedua.\n\n3.3 Fleksibiliti Operasi:\nMembolehkan pengasingan zon kerosakan tanpa menjejaskan keseluruhan rangkaian.\n\n4.0 APLIKASI LILO:\n\nLILO digunakan dalam:\n• Sistem Gegelang (Ring System) untuk pengagihan 11kV\n• Stesen Suis Utama (SSU)\n• Pencawang Pembahagian Utama (PPU)\n• Rangkaian pengagihan bandar yang memerlukan kesinambungan bekalan tinggi\n\n5.0 KESELAMATAN LILO:\n\nSebelum melakukan kerja pada kabel LILO:\n• Pastikan kedua-dua punca (A dan B) telah dimatikan\n• Lakukan prosedur 7 Langkah Keselamatan\n• Pasang NOP jika perlu\n• Lakukan ujian PCD sebelum sambung semula\n• Rekod semua operasi',
            'pencawang elektrik': '⚙️ PENCANWANG ELEKTRIK (PE) - Laporan Teknikal Komprehensif:\n\n1.0 PENGENALAN:\n\nPencawang Elektrik (PE) atau Distribution Substation adalah instalasi kritikal dalam sistem pengagihan tenaga. Fungsi utamanya adalah untuk menerima bekalan voltan tinggi (biasanya 11kV) dari Stesen Suis Utama (SSU) atau Papan Suis Utama (PPU) dan menurunkannya kepada voltan rendah (415V/240V) yang selamat untuk digunakan oleh pengguna komersial dan domestik.\n\nSecara umumnya, sebuah PE standard mengandungi tiga peralatan utama yang saling berkait:\n\n• Ring Main Unit (RMU) - Bahagian Voltan Tinggi (11kV)\n• Transformer (Alatubah) - Bahagian Penurunan Voltan (Step-down)\n• LV Board (Papan Agihan Voltan Rendah) - Bahagian Pengagihan (415V)\n\n2.0 UNIT GEGELANG UTAMA (Ring Main Unit - RMU):\n\nRMU adalah perkakasuis voltan tinggi yang padat dan tertutup sepenuhnya. Ia berfungsi sebagai titik pensuisan untuk rangkaian kabel 11kV.\n\nFUNGSI UTAMA:\n• Menyambungkan kabel 11kV dalam bentuk "gegelang" (ring) untuk memastikan kesinambungan bekalan\n• Melindungi transformer daripada arus kerosakan melalui fius atau pemutus litar\n\nCARA KERJA:\n\nMekanisme Penebatan: RMU biasanya menggunakan gas SF6 (Sulfur Heksafluorida) sebagai penebat kerana gas ini sangat efisien memadamkan arka elektrik, membolehkan saiz fizikal RMU menjadi kecil.\n\nSuis 3-Posisi: Suis di dalam RMU mempunyai tiga kedudukan operasi:\n• ON (Hidup): Litar bersambung, arus mengalir\n• OFF (Mati): Litar terputus (terbuka)\n• EARTH (Bumi): Litar disambungkan ke bumi untuk membuang cas elektrik sisa bagi tujuan keselamatan penyelenggaraan\n\nApa itu NOP (Normally Open Point)?\nNOP adalah konsep kritikal dalam rangkaian RMU. Dalam sistem gegelang (ring), bekalan datang dari dua arah berbeza (Punca A dan Punca B).\n\nFungsi NOP: Salah satu suis di dalam rangkaian gegelang ini akan sengaja diletakkan dalam posisi "OFF" (Terbuka). Titik ini dipanggil Normally Open Point.\n\nTujuan:\n• Mengelakkan Pertembungan Punca: Menghalang dua punca bekalan berbeza bercantum yang boleh menyebabkan arus kerosakan tinggi atau masalah pembumian\n• Pemulihan Bekalan (Back-feeding): Jika berlaku kerosakan kabel di sebelah Kiri (Punca A), jurutera boleh menutup suis NOP untuk mengambil bekalan dari sebelah Kanan (Punca B), meminimumkan tempoh gangguan bekalan elektrik kepada pengguna\n\nCiri Keselamatan RMU:\nSaling Kunci (Interlocking): Pintu akses kabel atau fius tidak boleh dibuka melainkan suis berada dalam kedudukan "EARTH". Suis pula tidak boleh diubah ke posisi "EARTH" jika ia sedang "ON". Ini menghalang pekerja daripada menyentuh bahagian hidup.\n\n3.0 TRANSFORMER PENURUN VOLTAN (Step-Down Transformer):\n\nIni adalah komponen paling berat dan besar di dalam pencawang.\n\nFUNGSI UTAMA: Menurunkan voltan daripada 11,000 Volt (11kV) kepada 415 Volt (3 Fasa) atau 240 Volt (1 Fasa).\n\nCARA KERJA (Prinsip Aruhan Elektromagnet):\n\nTransformer terdiri daripada dua gegelung wayar: Gegelung Primer (Voltan Tinggi) dan Gegelung Sekunder (Voltan Rendah) yang dililit pada teras besi berlamina.\n\nApabila arus AC 11kV mengalir melalui gegelung primer, ia menghasilkan medan magnet yang berubah-ubah di dalam teras besi.\n\nMedan magnet ini memotong gegelung sekunder, dan secara aruhan (tanpa sentuhan fizikal wayar), ia menghasilkan voltan yang lebih rendah di gegelung sekunder. Nisbah penurunan voltan bergantung kepada nisbah lilitan wayar (Np > Ns).\n\nFormula: Vp / Vs = Np / Ns\n\nCIRI KESELAMATAN:\n\nBuchholz Relay (Untuk jenis minyak): Mengesan pembentukan gas di dalam tangki minyak yang menandakan litar pintas dalaman, lalu memutuskan litar secara automatik.\n\nPressure Relief Valve: Melepaskan tekanan minyak jika berlaku letupan dalaman bagi mengelakkan tangki meletup.\n\nPagar/Tembok: Transformer jenis luar (outdoor) mesti dipagar kerana bahagian bushing (terminal sambungan) adalah terdedah dan berisiko tinggi.\n\n4.0 PAPAN AGIHAN VOLTAN RENDAH (LV Board):\n\nSetelah voltan diturunkan ke 415V, ia disalurkan ke LV Board (atau Feeder Pillar jika di luar bangunan).\n\nFUNGSI UTAMA: Menerima bekalan utama dari transformer dan memecahkannya kepada beberapa laluan kecil (feeders) untuk dihantar ke premis pengguna, lampu jalan, atau Papan Suis Utama (MSB) bangunan.\n\nCARA KERJA:\n\nBusbar: Kepingan tembaga besar yang menerima arus 415V.\n\nPengagihan: Dari busbar, arus dialirkan melalui beberapa set fius (J-Type Fuse) atau Pemutus Litar (MCCB). Setiap set fius mewakili satu kabel yang keluar ke kawasan perumahan atau bangunan tertentu.\n\nCIRI KESELAMATAN:\n\nFius HRC (High Rupturing Capacity): Jika berlaku litar pintas di rumah pengguna atau kabel bawah tanah, fius di LV Board akan meletup/putus untuk mengasingkan kerosakan tersebut supaya tidak menjejaskan keseluruhan transformer.\n\nPenyelubungan (Shrouding): Semua bahagian hidup ditutup dengan penghadang penebat untuk mengelakkan sentuhan tidak sengaja semasa kerja penyelenggaraan.\n\n5.0 RUMUSAN KESELAMATAN & OPERASI KESELURUHAN:\n\nOperasi di Pencawang Elektrik tertakluk kepada prosedur ketat di bawah Akta Bekalan Elektrik 1990:\n\nProsedur "Mati & Bumikan" (Dead & Earthed): Sebelum sebarang kerja dilakukan pada transformer atau kabel, bekalan mesti diputuskan di RMU (posisi OFF) dan kemudian suis dibumikan (posisi EARTH).\n\nSistem Kunci (Lock-out Tag-out): Suis yang telah dimatikan mesti dikunci dengan mangga (padlock) dan diletakkan tanda amaran "JANGAN HIDUPKAN" bagi mengelakkan bekalan dihidupkan semula secara tidak sengaja oleh orang lain.\n\nKelengkapan Pelindung Diri (PPE): Penggunaan Arc Flash Suit, sarung tangan penebat voltan tinggi, dan tikar getah di hadapan papan suis adalah mandatori untuk melindungi jurutera daripada renjatan dan letupan arka.'
        },
        'troubleshooting': {
            'pertembungan fasa': '🔧 Masalah: Pertembungan Fasa\n\nPertembungan fasa berlaku apabila dua sumber hidup disambungkan tanpa NOP. Ini sangat berbahaya dan boleh menyebabkan:\n• Letupan\n• Kerosakan peralatan\n• Kebakaran\n• Kecederaan\n\nPenyelesaian:\n1) Matikan salah satu sumber segera\n2) Pasang NOP dengan betul\n3) Lakukan ujian PCD sebelum sambung\n4) Pastikan hanya satu sumber hidup pada satu masa\n5) Semak fasa dengan phasing stick\n6) Rekod insiden untuk analisis',
            'tiada kuasa': '🔧 Masalah: Tiada Kuasa\n\nJika tiada kuasa, semak:\n1) Status sumber utama (Bus A/B)\n2) Circuit breaker dan isolator\n3) Fius (semak jika melebur)\n4) Sambungan kabel\n5) Lakukan ujian voltan\n6) Semak relay protection\n7) Semak transformer status\n8) Semak VCB status\n9) Semak LV board MCB\n10) Semak sambungan terminal',
            'overload': '🔧 Masalah: Sistem Overload\n\nJika sistem overload:\n1) Kurangkan beban segera\n2) Semak rating peralatan\n3) Semak fius dan circuit breaker\n4) Monitor suhu transformer\n5) Pertimbangkan untuk menambah kapasiti\n6) Seimbangkan beban antara fasa\n7) Lakukan load shedding jika perlu\n8) Semak kabel rating\n9) Monitor arus setiap fasa\n10) Rekod semua bacaan',
            'trip': '🔧 Masalah: Circuit Breaker Trip\n\nJika CB trip:\n1) Jangan reset segera - cari punca\n2) Semak relay protection\n3) Semak beban dan arus\n4) Semak short circuit atau fault\n5) Lakukan ujian sebelum reset\n6) Rekod punca trip\n7) Lakukan maintenance jika perlu\n8) Semak insulation resistance\n9) Semak continuity\n10) Semak earthing system',
            'vcb tidak tutup': '🔧 Masalah: VCB Tidak Boleh Tutup\n\nJika VCB tidak boleh tutup:\n1) Semak spring charging mechanism\n2) Semak control voltage\n3) Semak close coil\n4) Semak auxiliary contact\n5) Semak interlock mechanism\n6) Semak vacuum level\n7) Semak mechanical obstruction\n8) Semak control circuit\n9) Lakukan manual charging jika perlu\n10) Hubungi technician jika masalah berterusan',
            'vcb trip selalu': '🔧 Masalah: VCB Trip Selalu\n\nJika VCB trip selalu:\n1) Semak relay setting\n2) Semak beban sebenar\n3) Semak short circuit\n4) Semak insulation resistance\n5) Semak earth fault\n6) Semak overcurrent\n7) Semak under voltage\n8) Semak protection relay\n9) Lakukan ujian megger\n10) Rekod semua trip events untuk analisis',
            'kabel panas': '🔧 Masalah: Kabel Terlalu Panas\n\nJika kabel terlalu panas:\n1) Kurangkan beban segera\n2) Semak rating kabel\n3) Semak sambungan terminal\n4) Semak kabel tidak terlipat\n5) Semak suhu ambien\n6) Semak ventilation\n7) Pertimbangkan ganti kabel lebih besar\n8) Semak continuity dan resistance\n9) Monitor suhu berkala\n10) Rekod semua bacaan',
            'lv board mcb trip': '🔧 Masalah: MCB di LV Board Trip\n\nJika MCB trip:\n1) Semak beban pada litar tersebut\n2) Semak rating MCB\n3) Semak short circuit\n4) Semak earth fault\n5) Semak insulation resistance\n6) Semak sambungan terminal\n7) Kurangkan beban jika overload\n8) Ganti MCB jika rosak\n9) Semak kabel pada litar\n10) Rekod punca trip',
            'transformer panas': '🔧 Masalah: Transformer Terlalu Panas\n\nJika transformer terlalu panas:\n1) Kurangkan beban\n2) Semak cooling system\n3) Semak oil level (untuk oil-filled)\n4) Semak ventilation\n5) Semak tap changer position\n6) Monitor suhu winding\n7) Semak beban setiap fasa\n8) Pertimbangkan transformer lebih besar\n9) Lakukan maintenance\n10) Rekod semua bacaan',
            'pt tidak tepat': '🔧 Masalah: PT Bacaan Tidak Tepat\n\nJika PT bacaan tidak tepat:\n1) Semak ratio PT\n2) Semak sambungan\n3) Semak polarity\n4) Semak burden\n5) Lakukan ujian ratio\n6) Semak fius secondary\n7) Semak sambungan meter\n8) Semak accuracy class\n9) Kalibrasi semula jika perlu\n10) Ganti PT jika rosak',
            'phasing stick tidak berfungsi': '🔧 Masalah: Phasing Stick Tidak Berfungsi\n\nJika phasing stick tidak berfungsi:\n1) Semak bateri\n2) Semak indicator\n3) Semak probe connection\n4) Semak rating voltan\n5) Kalibrasi semula\n6) Semak kerosakan fizikal\n7) Ganti jika rosak\n8) Simpan di tempat kering\n9) Lakukan ujian berkala\n10) Jangan guna jika rosak',
            'megger bacaan rendah': '🔧 Masalah: Megger Bacaan Rendah\n\nJika megger bacaan rendah:\n1) Semak kelembapan\n2) Semak pencemaran\n3) Semak kerosakan insulation\n4) Semak suhu\n5) Bersihkan permukaan\n6) Keringkan jika basah\n7) Semak umur peralatan\n8) Pertimbangkan ganti insulation\n9) Lakukan ujian berkala\n10) Rekod semua bacaan untuk trend',
            'ujian gagal': '🔧 Masalah: Ujian Gagal\n\nJika ujian gagal:\n1) Semak prosedur ujian\n2) Semak peralatan ujian\n3) Semak sambungan\n4) Semak kalibrasi peralatan\n5) Ulang ujian\n6) Semak faktor luaran (suhu, kelembapan)\n7) Rujuk manual\n8) Hubungi technician\n9) Rekod semua hasil\n10) Analisis punca kegagalan',
            'ssu tiada kuasa': '🔧 Masalah: SSU Tiada Kuasa\n\nJika SSU tiada kuasa:\n1) Semak status sumber dari PPU\n2) Semak VCB incoming status (ON/OFF/Trip)\n3) Semak isolator dan earth switch\n4) Semak fius (jika ada)\n5) Lakukan ujian voltan pada busbar\n6) Semak relay protection status\n7) Semak sistem DC (bateri dan charger) berfungsi\n8) Semak SF6 pressure (jika menggunakan RMU SF6)\n9) Semak sambungan kabel incoming\n10) Hubungi Pusat Kawalan untuk status grid\n11) Semak transformer upstream (jika ada)\n12) Rekod semua status dan operasi',
            'ssu vcb tidak berfungsi': '🔧 Masalah: VCB di SSU Tidak Berfungsi\n\nJika VCB tidak berfungsi:\n1) Semak spring charging mechanism\n2) Semak control voltage (DC supply)\n3) Semak trip coil dan close coil\n4) Semak auxiliary contact\n5) Semak interlock mechanism\n6) Semak vacuum level dalam interrupter\n7) Semak mechanical obstruction\n8) Semak control circuit\n9) Lakukan ujian integriti vakum (Hi-Pot Test)\n10) Semak relay protection mengeluarkan isyarat\n11) Lakukan manual charging jika perlu\n12) Hubungi technician jika masalah berterusan\n13) Rekod semua operasi dan status',
            'ssu sistem dc gagal': '🔧 Masalah: Sistem DC SSU Gagal\n\nJika sistem DC gagal:\n1) Semak voltan bateri (30V DC atau 110V DC)\n2) Semak charger berfungsi dengan baik\n3) Semak aras elektrolit bateri (untuk Lead Acid)\n4) Lakukan ujian nyahcas (discharge test) untuk mengetahui kapasiti sebenar\n5) Semak sambungan bateri dan charger\n6) Semak fius DC\n7) Ganti bateri jika kapasiti tidak mencukupi\n8) Semak charger output voltage\n9) Rekod semua bacaan\n10) Sistem DC adalah kritikal - kegagalan menyebabkan protection failure',
            'psu acb trip': '🔧 Masalah: ACB di PSU Trip\n\nJika ACB trip:\n1) Jangan reset segera - cari punca\n2) Semak relay protection setting\n3) Semak beban sebenar vs rating ACB\n4) Semak short circuit atau fault\n5) Semak earth fault (EFR)\n6) Semak overcurrent\n7) Semak under voltage\n8) Lakukan ujian sebelum reset (megger, continuity)\n9) Semak busbar connection\n10) Semak sambungan kabel\n11) Rekod punca trip dan masa\n12) Lakukan maintenance jika perlu\n13) Semak koordinasi dengan downstream protection',
            'psu faktor kuasa rendah': '🔧 Masalah: Faktor Kuasa Rendah di PSU\n\nJika faktor kuasa rendah:\n1) Semak bacaan PFR (Power Factor Regulator)\n2) Semak tetapan C/K adalah betul\n3) Semak kapasitor bank berfungsi dengan baik\n4) Semak contactor kapasitor berfungsi\n5) Semak kapasitor tidak rosak atau kembung\n6) Semak Detuned Reactor (jika ada) berfungsi\n7) Semak beban induktif (motor, transformer)\n8) Pertimbangkan tambah kapasitor bank jika perlu\n9) Monitor faktor kuasa secara berkala\n10) Rekod semua bacaan\n11) Faktor kuasa < 0.85 akan dikenakan surcaj oleh TNB',
            'psu kapasitor meletup': '🔧 Masalah: Kapasitor di PSU Meletup atau Kembung\n\nJika kapasitor meletup:\n1) Matikan PSU segera\n2) Semak punca (biasanya harmonik)\n3) Semak Detuned Reactor dipasang dengan betul\n4) Semak rating kapasitor sesuai dengan sistem\n5) Semak beban harmonik (LED, inverter)\n6) Ganti kapasitor yang rosak\n7) Pastikan Detuned Reactor dipasang bersiri dengan kapasitor\n8) Semak frekuensi resonans litar (biasanya 189Hz)\n9) Lakukan ujian kapasitor sebelum pasang\n10) Rekod insiden dan analisis punca',
            'psu meter tidak tepat': '🔧 Masalah: Meter TNB Tidak Tepat\n\nJika meter tidak tepat:\n1) Jangan sentuh atau ubah meter TNB\n2) Laporkan kepada TNB segera\n3) Semak meterai meter tidak pecah\n4) Semak CT dan VT (jika ada) berfungsi dengan baik\n5) Semak sambungan meter dan CT/VT\n6) Semak fius pengasing meter tidak melebur\n7) Ambil bacaan meter dan bandingkan dengan beban sebenar\n8) Rekod semua bacaan\n9) TNB akan melakukan kalibrasi semula jika perlu\n10) Jangan cuba baiki meter sendiri',
            'psu busbar panas': '🔧 Masalah: Busbar di PSU Terlalu Panas\n\nJika busbar terlalu panas:\n1) Kurangkan beban segera\n2) Semak rating busbar sesuai dengan beban\n3) Semak ketumpatan arus (biasanya 1.5A per mm²)\n4) Semak sambungan terminal ketat\n5) Semak busbar support insulators tidak rosak\n6) Semak jarak sokongan tidak terlalu jauh\n7) Lakukan imbasan inframerah (thermography)\n8) Semak beban setiap fasa seimbang\n9) Pertimbangkan ganti busbar lebih besar jika perlu\n10) Monitor suhu berkala\n11) Rekod semua bacaan',
            'psu relay tidak trip': '🔧 Masalah: Relay Protection Tidak Trip\n\nJika relay tidak trip:\n1) Semak relay setting adalah betul\n2) Semak relay menerima isyarat dari CT\n3) Semak shunt trip coil berfungsi\n4) Semak control circuit\n5) Semak sistem DC (jika relay menggunakan DC)\n6) Lakukan ujian suntikan sekunder\n7) Semak auxiliary contact\n8) Semak wiring relay ke ACB\n9) Lakukan penentukuran relay (2 tahun mandatori)\n10) Hubungi technician jika masalah berterusan\n11) Rekod semua ujian dan status\n12) Kegagalan relay adalah sangat berbahaya - mesti dibaiki segera',
            'pe tiada kuasa': '🔧 Masalah: Pencawang Elektrik Tiada Kuasa\n\nJika PE tiada kuasa:\n1) Semak status sumber dari SSU/PPU\n2) Semak RMU incoming status (ON/OFF/Trip)\n3) Semak suis 3-posisi di RMU\n4) Semak fius transformer (jika ada)\n5) Semak transformer status (trip, overload)\n6) Semak LV Board incoming breaker\n7) Lakukan ujian voltan pada setiap peringkat (11kV, 415V)\n8) Semak relay protection status\n9) Semak sambungan kabel incoming dan outgoing\n10) Semak NOP status (jika dalam rangkaian ring)\n11) Hubungi Pusat Kawalan untuk status grid\n12) Rekod semua status dan operasi',
            'pe transformer trip': '🔧 Masalah: Transformer di PE Trip\n\nJika transformer trip:\n1) Jangan reset segera - cari punca\n2) Semak relay protection (Buchholz Relay untuk oil-filled)\n3) Semak beban transformer vs rating\n4) Semak suhu transformer (winding temperature)\n5) Semak oil level dan quality (untuk oil-filled)\n6) Semak short circuit atau fault pada litar sekunder\n7) Semak earth fault\n8) Semak tap changer position\n9) Lakukan ujian megger sebelum reset\n10) Semak cooling system (fan, radiator)\n11) Rekod punca trip dan masa\n12) Lakukan maintenance jika perlu',
            'pe buchholz relay trip': '🔧 Masalah: Buchholz Relay Trip\n\nJika Buchholz Relay trip:\n1) Jangan reset segera - ini menandakan masalah serius\n2) Semak gas di dalam relay (warna dan kuantiti)\n3) Gas kuning/putih = kelembapan atau udara\n4) Gas hitam = litar pintas dalaman atau arka\n5) Semak oil level transformer\n6) Semak tekanan dalam tangki\n7) Lakukan ujian DGA (Dissolved Gas Analysis) pada minyak\n8) Semak winding temperature\n9) Jangan hidupkan transformer jika gas hitam\n10) Hubungi technician atau pengilang\n11) Rekod semua pemerhatian\n12) Transformer mungkin perlu dibuka untuk pemeriksaan dalaman',
            'pe lv board tiada output': '🔧 Masalah: LV Board di PE Tiada Output\n\nJika LV Board tiada output:\n1) Semak transformer output voltan (415V)\n2) Semak incoming breaker di LV Board status\n3) Semak semua MCB di LV Board\n4) Semak fius HRC (jika ada) tidak melebur\n5) Semak busbar connection\n6) Lakukan ujian voltan pada busbar\n7) Semak sambungan kabel dari transformer ke LV Board\n8) Semak earth fault\n9) Semak relay protection trip\n10) Semak penyelubungan (shrouding) tidak menghalang sambungan\n11) Rekod semua status\n12) Semak downstream beban tidak menyebabkan trip'
        }
    };

    // FUNGSI WEB SEARCH - Mencari maklumat dari internet
    async function searchWeb(query) {
        try {
            // Gunakan DuckDuckGo Instant Answer API (tidak memerlukan API key)
            const searchUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
            const response = await fetch(searchUrl);
            const data = await response.json();
            
            if (data.AbstractText) {
                return data.AbstractText;
            }
            if (data.Answer) {
                return data.Answer;
            }
            if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                return data.RelatedTopics[0].Text || data.RelatedTopics[0].FirstURL;
            }
            
            // Fallback ke Wikipedia API
            try {
                const wikiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
                const wikiResponse = await fetch(wikiUrl);
                const wikiData = await wikiResponse.json();
                if (wikiData.extract) {
                    return wikiData.extract.substring(0, 500) + '...';
                }
            } catch(e) {}
            
            return null;
        } catch(e) {
            return null;
        }
    }

    // FUNGSI CHECK INTERNET CONNECTION
    async function checkInternetConnection() {
        try {
            const response = await fetch('https://www.google.com/favicon.ico', { 
                method: 'HEAD', 
                mode: 'no-cors',
                cache: 'no-cache'
            });
            return true;
        } catch(e) {
            try {
                const response = await fetch('https://api.duckduckgo.com/?q=test&format=json', {
                    method: 'GET',
                    cache: 'no-cache'
                });
                return true;
            } catch(e2) {
                return false;
            }
        }
    }

    // FUNGSI UPDATE CONNECTION STATUS
    async function updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        if (!statusEl) return;
        
        const isOnline = await checkInternetConnection();
        if (isOnline) {
            statusEl.innerHTML = '<i class="fa-solid fa-circle" style="font-size:6px;"></i><span>ONLINE</span>';
            statusEl.style.background = 'rgba(34,197,94,0.2)';
            statusEl.style.color = '#4ade80';
        } else {
            statusEl.innerHTML = '<i class="fa-solid fa-circle" style="font-size:6px;"></i><span>OFFLINE</span>';
            statusEl.style.background = 'rgba(239,68,68,0.2)';
            statusEl.style.color = '#f87171';
        }
    }

    // FUNGSI SEARCH KNOWLEDGE BASE
    function searchKnowledgeBase(query) {
        const lowerQuery = query.toLowerCase();
        const words = lowerQuery.split(/\s+/);
        
        // Cari dalam SOP - exact match
        for (const [key, value] of Object.entries(knowledgeBase.sop)) {
            if (lowerQuery.includes(key) || words.some(w => w.includes(key) || key.includes(w))) {
                return { source: 'SOP Lokal', answer: value };
            }
        }
        
        // Cari dalam teknikal
        for (const [key, value] of Object.entries(knowledgeBase.teknikal)) {
            if (lowerQuery.includes(key) || words.some(w => w.includes(key) || key.includes(w))) {
                return { source: 'Knowledge Base Teknikal', answer: value };
            }
        }
        
        // Cari dalam troubleshooting
        for (const [key, value] of Object.entries(knowledgeBase.troubleshooting)) {
            if (lowerQuery.includes(key) || words.some(w => w.includes(key) || key.includes(w))) {
                return { source: 'Troubleshooting Guide', answer: value };
            }
        }
        
        // Fuzzy search - cari perkataan kunci dengan sinonim (EXTENDED)
        const keywordMap = {
            // NOP
            'nop': { source: 'SOP Lokal', answer: knowledgeBase.sop.nop },
            'neutral open point': { source: 'SOP Lokal', answer: knowledgeBase.sop.nop },
            // Fius
            'fius': { source: 'SOP Lokal', answer: knowledgeBase.sop.fius },
            'fuse': { source: 'SOP Lokal', answer: knowledgeBase.sop.fius },
            // RMU
            'rmu': { source: 'SOP Lokal', answer: knowledgeBase.sop.rmu },
            'ring main unit': { source: 'SOP Lokal', answer: knowledgeBase.sop.rmu },
            // Keselamatan
            'keselamatan': { source: 'SOP Lokal', answer: knowledgeBase.sop.keselamatan },
            'safety': { source: 'SOP Lokal', answer: knowledgeBase.sop.keselamatan },
            'ppe': { source: 'SOP Lokal', answer: knowledgeBase.sop.keselamatan },
            // Transformer
            'transformer': { source: 'SOP Lokal', answer: knowledgeBase.sop.transformer },
            'tx': { source: 'SOP Lokal', answer: knowledgeBase.sop.transformer },
            'transformer teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.transformer },
            // Isolator
            'isolator': { source: 'SOP Lokal', answer: knowledgeBase.sop.isolator },
            'isolator teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.isolator },
            // Circuit Breaker
            'circuit breaker': { source: 'SOP Lokal', answer: knowledgeBase.sop['circuit breaker'] },
            'cb': { source: 'SOP Lokal', answer: knowledgeBase.sop['circuit breaker'] },
            'breaker': { source: 'SOP Lokal', answer: knowledgeBase.sop['circuit breaker'] },
            // VCB
            'vcb': { source: 'SOP Lokal', answer: knowledgeBase.sop.vcb },
            'vacuum circuit breaker': { source: 'SOP Lokal', answer: knowledgeBase.sop.vcb },
            'vcb teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.vcb },
            // Kabel
            'kabel': { source: 'SOP Lokal', answer: knowledgeBase.sop.kabel },
            'cable': { source: 'SOP Lokal', answer: knowledgeBase.sop.kabel },
            'kabel teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.kabel },
            // LV Board
            'lv board': { source: 'SOP Lokal', answer: knowledgeBase.sop['lv board'] },
            'lv': { source: 'SOP Lokal', answer: knowledgeBase.sop['lv board'] },
            'low voltage board': { source: 'SOP Lokal', answer: knowledgeBase.sop['lv board'] },
            'panel lv': { source: 'SOP Lokal', answer: knowledgeBase.sop['lv board'] },
            'lv board teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['lv board'] },
            // Potential Transformer
            'potential transformer': { source: 'SOP Lokal', answer: knowledgeBase.sop['potential transformer'] },
            'pt': { source: 'SOP Lokal', answer: knowledgeBase.sop['potential transformer'] },
            'voltage transformer': { source: 'SOP Lokal', answer: knowledgeBase.sop['potential transformer'] },
            'vt': { source: 'SOP Lokal', answer: knowledgeBase.sop['potential transformer'] },
            'pt teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['potential transformer'] },
            // Phasing Stick
            'phasing stick': { source: 'SOP Lokal', answer: knowledgeBase.sop['phasing stick'] },
            'phasing': { source: 'SOP Lokal', answer: knowledgeBase.sop['phasing stick'] },
            'phasing stick teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['phasing stick'] },
            // Ujian Megger
            'ujian megger': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian megger'] },
            'megger': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian megger'] },
            'insulation test': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian megger'] },
            'ir test': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian megger'] },
            'megger teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['ujian megger'] },
            // Ujian Continuity
            'ujian continuity': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian continuity'] },
            'continuity': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian continuity'] },
            'continuity test': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian continuity'] },
            'ujian continuity teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['ujian continuity'] },
            // Ujian Voltan
            'ujian voltan': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian voltan'] },
            'voltage test': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian voltan'] },
            'ujian voltan teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['ujian voltan'] },
            // Ujian PCD
            'ujian pcd': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian pcd'] },
            'pcd': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian pcd'] },
            'phase continuity detection': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian pcd'] },
            'ujian pcd teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['ujian pcd'] },
            // Ujian Ratio
            'ujian ratio': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian ratio'] },
            'ratio test': { source: 'SOP Lokal', answer: knowledgeBase.sop['ujian ratio'] },
            'ujian ratio teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['ujian ratio'] },
            // Earth
            'earth': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.earth },
            'ground': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.earth },
            'earthing': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.earth },
            // Troubleshooting
            'pertembungan': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pertembungan fasa'] },
            'pertembungan fasa': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pertembungan fasa'] },
            'phase clash': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pertembungan fasa'] },
            'tiada kuasa': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['tiada kuasa'] },
            'no power': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['tiada kuasa'] },
            'overload': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting.overload },
            'trip': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting.trip },
            'vcb tidak tutup': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['vcb tidak tutup'] },
            'vcb tidak boleh tutup': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['vcb tidak tutup'] },
            'vcb trip selalu': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['vcb trip selalu'] },
            'kabel panas': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['kabel panas'] },
            'cable hot': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['kabel panas'] },
            'lv board mcb trip': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['lv board mcb trip'] },
            'mcb trip': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['lv board mcb trip'] },
            'transformer panas': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['transformer panas'] },
            'transformer hot': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['transformer panas'] },
            'pt tidak tepat': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pt tidak tepat'] },
            'pt inaccurate': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pt tidak tepat'] },
            'phasing stick tidak berfungsi': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['phasing stick tidak berfungsi'] },
            'megger bacaan rendah': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['megger bacaan rendah'] },
            'low insulation': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['megger bacaan rendah'] },
            'ujian gagal': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['ujian gagal'] },
            'test failed': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['ujian gagal'] },
            // Pencawang Elektrik
            'pencawang elektrik': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['pencawang elektrik'] },
            'pe': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['pencawang elektrik'] },
            'distribution substation': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal['pencawang elektrik'] },
            'sop pencawang elektrik': { source: 'SOP Lokal', answer: knowledgeBase.sop['pencawang elektrik'] },
            'sop pe': { source: 'SOP Lokal', answer: knowledgeBase.sop['pencawang elektrik'] },
            'pe tiada kuasa': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pe tiada kuasa'] },
            'pe transformer trip': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pe transformer trip'] },
            'buchholz relay': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pe buchholz relay trip'] },
            'pe buchholz relay trip': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pe buchholz relay trip'] },
            'pe lv board tiada output': { source: 'Troubleshooting Guide', answer: knowledgeBase.troubleshooting['pe lv board tiada output'] },
            // Stesen Suis
            'stesen suis': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.ssu },
            'ss': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.ssu },
            'ssu teknikal': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.ssu },
            'switching station': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.ssu },
            'sop ssu': { source: 'SOP Lokal', answer: knowledgeBase.sop.ssu },
            'sop stesen suis': { source: 'SOP Lokal', answer: knowledgeBase.sop.ssu },
            // LILO
            'lilo': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.lilo },
            'loop-in loop-out': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.lilo },
            'loop in loop out': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.lilo },
            'konsep lilo': { source: 'Knowledge Base Teknikal', answer: knowledgeBase.teknikal.lilo },
            // 7 Langkah Keselamatan
            '7 langkah keselamatan': { source: 'SOP Lokal', answer: knowledgeBase.sop['7 langkah keselamatan'] },
            'tujuh langkah keselamatan': { source: 'SOP Lokal', answer: knowledgeBase.sop['7 langkah keselamatan'] },
            'prosedur kerja selamat': { source: 'SOP Lokal', answer: knowledgeBase.sop['prosedur kerja selamat'] },
            'safe work procedure': { source: 'SOP Lokal', answer: knowledgeBase.sop['prosedur kerja selamat'] },
            'swp': { source: 'SOP Lokal', answer: knowledgeBase.sop['prosedur kerja selamat'] },
            // LOTO
            'loto': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto },
            'lock-out tag-out': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto },
            'lockout tagout': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto },
            'kunci tidak piawai': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto },
            'non-standard lock': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto },
            'kunci piawai': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto },
            'standard lock': { source: 'SOP Lokal', answer: knowledgeBase.sop.loto }
        };
        
        for (const [keyword, data] of Object.entries(keywordMap)) {
            if (lowerQuery.includes(keyword) || words.some(w => keyword.includes(w))) {
                return data;
            }
        }
        
        return null;
    }

    // FUNGSI SEND AI CHAT - Sistem Hybrid Pintar
    window.sendAIChat = async function() {
        const input = document.getElementById('ai-input');
        const question = input.value.trim();
        if(!question) return;
        
        addAIMessage(question, true);
        input.value = '';
        
        // Update connection status
        await updateConnectionStatus();
        const isOnline = await checkInternetConnection();
        
        let loadingMsg = addAIMessage("🔍 Mencari maklumat", false, true);
        
        // 1. Cari dalam knowledge base lokal dahulu
        const localResult = searchKnowledgeBase(question);
        if (localResult) {
            addAIMessage(`📚 [${localResult.source}]\n\n${localResult.answer}`, false);
            speakText(localResult.answer.substring(0, 200));
            return;
        }
        
        // 2. Jika tidak jumpa, cuba web search jika online
        if (isOnline) {
            loadingMsg = addAIMessage("🌐 Mencari dari internet", false, true);
            const webResult = await searchWeb(question);
            
            if (webResult) {
                addAIMessage(`🌐 [Web Search]\n\n${webResult}`, false);
                speakText(webResult.substring(0, 200));
                return;
            }
        }
        
        // 3. Fallback - cuba Gemini API jika ada
        try {
            loadingMsg = addAIMessage("🤖 Menghubungi AI", false, true);
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `Anda adalah pakar dalam sistem pengagihan kuasa elektrik. Jawab soalan ini dalam Bahasa Melayu dengan terperinci: ${question}`
                        }]
                    }]
                })
            });
            const data = await response.json();
            const answer = data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            
            if (answer) {
                addAIMessage(`🤖 [AI Response]\n\n${answer}`, false);
                speakText(answer.substring(0, 200));
                return;
            }
        } catch(e) {
            // Ignore error, continue to fallback
        }
        
        // 4. Final fallback - jawapan generik dengan cadangan
        const fallbackAnswer = `❌ Maaf, saya tidak dapat mencari maklumat spesifik tentang "${question}".\n\n💡 Sila cuba soalan yang lebih spesifik seperti:\n\n• SOP NOP\n• SOP Fius\n• SOP RMU\n• Masalah pertembungan fasa\n• Cara kerja isolator\n• Circuit breaker\n• Earth switch\n\n${isOnline ? '✅ Sambungan internet aktif - cuba soalan lain untuk carian web.' : '⚠️ Sambungan internet tidak aktif - gunakan knowledge base lokal.'}`;
        addAIMessage(fallbackAnswer, false);
        speakText("Maaf, tidak dapat mencari maklumat. Sila cuba soalan lain.");
    };

    // LOGOUT FUNCTION
    window.logout = function() {
        if(confirm("Adakah anda pasti mahu log keluar?")) {
            location.reload();
        }
    };

    // --- INIT ---
    // Memastikan suara dimuatkan untuk text-to-speech
    if ('speechSynthesis' in window) {
        // Memuatkan suara segera
        window.speechSynthesis.getVoices();
        
        // Event listener untuk apabila suara dimuatkan
        window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
        };
        
        // Paksa muatkan suara dengan bercakap kosong (trick untuk memuatkan suara)
        const loadVoices = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                setTimeout(loadVoices, 100);
            }
        };
        loadVoices();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const loginButton = document.getElementById('login-button');
        if (loginButton) {
            loginButton.addEventListener('click', checkCode);
        }
        
        // Pastikan suara dimuatkan selepas DOM ready
        if ('speechSynthesis' in window) {
            setTimeout(() => {
                window.speechSynthesis.getVoices();
            }, 500);
        }
    });

    mkFuse('lk',8); mkFuse('pt',8); mkFuse('lm',5);
    calc();
</script>
</body>
</html>
